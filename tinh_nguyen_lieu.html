<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh ƒê·ªãnh M·ª©c Nguy√™n Li·ªáu Th·ª±c ƒê∆°n</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† ƒë√°p ·ª©ng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ v√† cƒÉn ch·ªânh c∆° b·∫£n */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 1rem;
        }
        /* Custom style to handle closing dropdown when clicking outside */
        .dish-option:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        /* B·ªï sung ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng ngang tr√™n mobile (n·∫øu c·∫ßn thi·∫øt, nh∆∞ng ƒë√£ c·ªë g·∫Øng tr√°nh) */
        .table-responsive {
            overflow-x: auto;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Modal Content */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        /* T√πy ch·ªânh cho dropdown trong khu v·ª±c ch·ªânh s·ª≠a */
        .norm-select-container {
            max-height: 12rem; /* Gi·ªõi h·∫°n chi·ªÅu cao cho dropdown danh s√°ch m√≥n */
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Modal cho k·∫øt qu·∫£ LLM -->
    <div id="llm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-backdrop transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-2xl modal-content transform transition-transform duration-300 scale-95">
            <h3 id="llm-modal-title" class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">K·∫øt Qu·∫£ Gemini ‚ú®</h3>
            <div id="llm-modal-content" class="text-gray-700 whitespace-pre-wrap">
                <!-- LLM response content -->
            </div>
            <button onclick="document.getElementById('llm-modal').classList.add('hidden')" class="mt-6 w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150">ƒê√≥ng</button>
        </div>
    </div>
    <!-- K·∫øt th√∫c Modal -->


    <div class="max-w-4xl mx-auto p-2 sm:p-6 bg-white shadow-xl rounded-xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700 mb-6 border-b pb-2">
            üìä T√≠nh To√°n T·ªïng Nguy√™n Li·ªáu Theo Th·ª±c ƒê∆°n B√°n Tr√∫ Tr∆∞·ªùng Gia ƒê·ªãnh
        </h1>
        <p class="text-gray-600 mb-6 text-sm sm:text-base">
            Nh·∫≠p ƒë·ªãnh m·ª©c nguy√™n li·ªáu cho t·ª´ng m√≥n v√† l·∫≠p th·ª±c ƒë∆°n ng√†y ƒë·ªÉ t√≠nh to√°n.
        </p>

        <!-- KHU V·ª∞C 1: ƒê·ªäNH M·ª®C NGUY√äN LI·ªÜU (Norms) -->
        <div id="norms-section" class="bg-indigo-50 p-3 sm:p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-lg sm:text-xl font-semibold text-indigo-800 mb-4 flex justify-between items-center">
                ƒê·ªãnh M·ª©c Nguy√™n Li·ªáu
            </h2>

            <!-- N√öT M·ªöI: QU·∫¢N L√ù ƒê·ªäNH M·ª®C -->
            <button onclick="toggleNormsManagement(true)" id="manage-norms-btn" class="w-full bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition duration-150 mb-4 shadow-md flex items-center justify-center text-sm sm:text-base">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Qu·∫£n L√Ω ƒê·ªãnh M·ª©c M√≥n ƒÇn (Th√™m/S·ª≠a/X√≥a)
            </button>
            <!-- END N√öT QU·∫¢N L√ù -->


            <div id="norms-management-area" class="hidden p-3 sm:p-4 bg-white rounded-lg border-2 border-indigo-200">
                <!-- Select m√≥n ƒÉn ƒë·ªÉ ch·ªânh s·ª≠a -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Ch·ªçn M√≥n ƒÇn ƒë·ªÉ Ch·ªânh S·ª≠a ho·∫∑c Th√™m M√≥n M·ªõi:</h3>
                    
                    <div class="relative">
                        <input type="text" id="norm-dish-search" placeholder="T√¨m ki·∫øm m√≥n ƒÉn ƒë·ªÉ ch·ªânh s·ª≠a ho·∫∑c nh·∫≠p t√™n m·ªõi..." 
                            oninput="filterNormDishList(this.value)" 
                            onfocus="renderSearchableNormDishList()"
                            onblur="setTimeout(() => document.getElementById('norm-dish-options').classList.add('hidden'), 200)"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                        
                        <div id="norm-dish-options" 
                             class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg norm-select-container hidden text-sm">
                            <!-- Dish options for norm management -->
                        </div>
                    </div>
                </div>

                <!-- Form ch·ªânh s·ª≠a/th√™m m√≥n ƒÉn -->
                <div id="add-edit-form" class="space-y-3 p-3 bg-white rounded-lg border border-gray-200">
                    <h3 id="form-title" class="font-bold text-lg text-indigo-700"></h3>
                    <input type="hidden" id="current-norm-dish-name"> 
                    
                    <!-- V√πng nh·∫≠p nguy√™n li·ªáu -->
                    <div id="new-ingredient-inputs" class="space-y-2">
                        <!-- S·∫Ω ch·ª©a c√°c input nguy√™n li·ªáu -->
                    </div>
                    
                    <button onclick="addIngredientInput()" class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h3m-3-3H9m-3-3h6a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2z"></path></svg>
                        Th√™m Nguy√™n Li·ªáu
                    </button>
                    
                    <!-- N√∫t L∆∞u / C·∫≠p Nh·∫≠t -->
                    <div id="form-action-buttons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 pt-2 border-t mt-3">
                        <button id="save-update-button" onclick="saveDishNorm()" class="flex-grow bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition duration-150 text-sm">
                            L∆∞u / C·∫≠p Nh·∫≠t ƒê·ªãnh M·ª©c
                        </button>
                        <button onclick="deleteNorm(document.getElementById('current-norm-dish-name').value)" id="delete-norm-button" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition duration-150 text-sm w-full sm:w-28 hidden">
                            X√≥a M√≥n
                        </button>
                        <button onclick="toggleNormsManagement(false)" class="w-full sm:w-28 bg-gray-300 text-gray-700 p-2 rounded-md hover:bg-gray-400 transition duration-150 text-sm">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        <!-- END KHU V·ª∞C 1 -->


        <!-- KHU V·ª∞C 2: TH·ª∞C ƒê∆†N NG√ÄY (Daily Menu) -->
        <div class="bg-white p-3 sm:p-4 rounded-lg shadow-lg mb-8 border border-gray-200">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                <span class="flex items-center">üìã Th·ª±c ƒê∆°n Ng√†y</span>
                <!-- Th√™m input ch·ªçn ng√†y -->
                <input type="date" id="menu-date" 
                       onchange="renderResultsTitle()" 
                       class="p-2 border rounded-md text-sm focus:ring-green-500 focus:border-green-500 w-full sm:w-auto">
            </h2>
            
            <!-- Input ƒë·ªÉ th√™m m√≥n v√†o th·ª±c ƒë∆°n (Responsive layout) -->
            <div class="flex flex-col space-y-3 mb-4">
                <!-- KH·ªêI CH·ªåN M√ìN C√ì T√åM KI·∫æM -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative flex-grow">
                        <input type="text" id="dish-search-input" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." 
                               oninput="filterDishList(this.value)" 
                               onfocus="renderSearchableDishList()"
                               onblur="setTimeout(() => document.getElementById('dish-options-list').classList.add('hidden'), 200)"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white text-sm">
                        
                        <input type="hidden" id="menu-dish-select" value="">

                        <div id="dish-options-list" 
                             class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden text-sm">
                            <!-- Dish options will be rendered here by JS -->
                        </div>
                    </div>
                </div>
                <!-- END KH·ªêI CH·ªåN M√ìN C√ì T√åM KI·∫æM -->
                
                <!-- KH·ªêI NH·∫¨P S·ªê SU·∫§T V√Ä N√öT TH√äM -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center">
                    <div class="flex-grow w-full sm:w-auto flex items-center space-x-2">
                         <label class="text-sm font-medium text-gray-700 whitespace-nowrap hidden sm:block">S·ªë Su·∫•t:</label>
                        <input type="number" id="menu-servings-input" placeholder="S·ªë su·∫•t" value="1" min="1" class="w-full sm:w-28 p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 text-center text-sm">
                    </div>

                    <!-- N√öT G·ª¢I √ù NHANH -->
                    <div class="flex space-x-1 w-full sm:w-auto justify-end">
                        <button onclick="setServings(500)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">500</button>
                        <button onclick="setServings(1000)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">1000</button>
                        <button onclick="setServings(2000)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">2000</button>
                    </div>
                    <!-- END N√öT G·ª¢I √ù NHANH -->

                    <button onclick="addDishToMenu()" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition duration-150 whitespace-nowrap text-sm w-full sm:w-auto">
                        Th√™m
                    </button>
                </div>
                <!-- END KH·ªêI NH·∫¨P S·ªê SU·∫§T V√Ä N√öT TH√äM -->
            </div>

            <!-- N√∫t ƒê·∫∑t l·∫°i v√† N√∫t Gemini -->
            <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center space-y-2 sm:space-y-0 mb-4">
                <!-- N√öT M·ªöI: G·ª¢I √ù TH·ª∞C ƒê∆†N -->
                <button onclick="generateMenuSuggestion()" id="generate-summary-btn" class="text-xs sm:text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <span class="mr-1">‚ú®</span> G·ª£i √Ω Th·ª±c ƒë∆°n
                </button>
                <!-- END N√öT M·ªöI -->

                <button onclick="resetDailyMenu()" class="text-xs sm:text-sm bg-red-100 text-red-700 hover:bg-red-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20v-5m-5.074 8.751A8.001 8.001 0 0119.418 15m-15.356-2A8.001 8.001 0 0019.418 15m-15.356-2H4v5"></path></svg>
                    ƒê·∫∑t l·∫°i Th·ª±c ƒê∆°n
                </button>
            </div>
            <!-- K·∫øt th√∫c N√∫t ƒê·∫∑t l·∫°i v√† N√∫t Gemini -->


            <!-- B·∫£ng hi·ªÉn th·ªã th·ª±c ƒë∆°n (Table Responsive) -->
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√≥n ƒÇn</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24 sm:w-28">S·ªë Su·∫•t</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="daily-menu-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Menu items are rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- KHU V·ª∞C 3: K·∫æT QU·∫¢ T√çNH TO√ÅN (Results) -->
        <div class="bg-yellow-50 p-3 sm:p-4 rounded-lg shadow-lg border border-yellow-300">
            <h2 class="text-lg sm:text-xl font-semibold text-yellow-800 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0" id="results-title-header">
                üõí T·ªïng Nguy√™n Li·ªáu C·∫ßn Thi·∫øt Cho Ng√†y
                <!-- N√∫t Export v√† N√∫t Gemini v√† N√∫t View Toggle -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                    <button onclick="toggleResultsView()" id="toggle-view-btn" class="bg-gray-200 text-gray-700 text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-gray-300 transition duration-150 shadow-md w-full sm:w-auto flex items-center justify-center">
                        <!-- Icon v√† Text s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
                    </button>
                    <button onclick="generateShoppingListNotes()" id="generate-notes-btn" class="bg-yellow-700 text-white text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-yellow-800 transition duration-150 shadow-md w-full sm:w-auto">
                        <span class="mr-1">‚ú®</span> G·ª£i √Ω Mua s·∫Øm
                    </button>
                    <button onclick="exportResultsToCSVWithBOM()" class="bg-yellow-600 text-white text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-yellow-700 transition duration-150 shadow-md w-full sm:w-auto">
                        Xu·∫•t File (.csv - H·ªó tr·ª£ TV)
                    </button>
                </div>
            </h2>
            
            <!-- B·∫£ng K·∫øt qu·∫£ (Table Responsive) -->
            <div id="results-table-view" class="table-responsive">
                <table class="min-w-full divide-y divide-yellow-300 rounded-lg overflow-hidden border border-yellow-300">
                    <thead class="bg-yellow-200">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Nguy√™n Li·ªáu</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-yellow-800 uppercase tracking-wider">T·ªïng S·ªë L∆∞·ª£ng (G·ªëc)</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-yellow-800 uppercase tracking-wider">Quy ƒê·ªïi</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Calculation results are rendered here -->
                        <tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Th·ª±c ƒë∆°n tr·ªëng. H√£y th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n ƒë·ªÉ t√≠nh to√°n!</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Danh s√°ch K·∫øt qu·∫£ (List/Card View cho Mobile) -->
            <div id="results-list-view" class="space-y-3 hidden">
                <!-- List items are rendered here -->
            </div>

        </div>

        <!-- Message Box for alerts -->
        <div id="message-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white hidden z-50 transition-opacity duration-300 text-sm"></div>

    </div>

    <script>
        // --- C∆† S·ªû D·ªÆ LI·ªÜU V√Ä ƒê·ªäNH NGHƒ®A ---
        
        // Danh s√°ch c√°c ƒë∆°n v·ªã t√≠nh ƒë∆∞·ª£c thi·∫øt l·∫≠p s·∫µn
        const UNITS = ['g', 'kg', 'ml', 'l', 'c√°i', 'qu·∫£', 'b√≥', 'lon', 'h·ªôp', 'th√¨a', 'mu·ªóng', 'ph·∫ßn', 'mi·∫øng'];
        
        // C·∫•u tr√∫c ƒê·ªãnh m·ª©c: { "T√™n M√≥n ƒÇn": { "Nguy√™n Li·ªáu (ƒê∆°n v·ªã)": S·ªë L∆∞·ª£ng (cho 1 su·∫•t) } }
        let norms = JSON.parse(localStorage.getItem('norms')) || {
            "G√† chi√™n s·ªët cay": { "Th·ªãt n·∫°c vai (g)": 200, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "Th·ªãt kho c·ªß c·∫£i": { "Th·ªãt n·∫°c vai (g)": 180, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "C·ªët l·∫øt ram m·∫∑n": { "C·ªët l·∫øt (g)": 200 },
            "Ch·∫£ c√° kho ti√™u": { "Ch·∫£ c√° (g)": 150 },
            "G√† chi√™n n∆∞·ªõc m·∫Øm": { "G√† t∆∞∆°i (g)": 200 },
            "Th·ªãt kho tr·ª©ng g√†": { "Th·ªãt n·∫°c vai (g)": 130, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "C√° phi l√™": { "C√° phi l√™ (g)": 130 },
            "G√† kho g·ª´ng": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn kho ti√™u": { "S∆∞·ªùn non (g)": 220 },
            "G√† kho s·∫£": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn s·ªët chua ng·ªçt": { "S∆∞·ªùn non (g)": 220 },
            "Th·ªãt kho ƒë·∫≠u h≈©": { "Th·ªãt n·∫°c vai (g)": 130, "ƒê·∫≠u h≈© chi√™n (g)": 100 },
            "Ch·∫£ c√° tr·ª©ng c√∫t": { "Ch·∫£ c√° b·ªçc tr·ª©ng c√∫t (g)": 125 },
            "ƒê√πi g√† chi√™n": { "ƒê√πi g√† (g)": 200 },
            "C·∫£i ng·ªçt x√†o": { "C·∫£i ng·ªçt (g)": 80 },
            "B·∫ßu x√†o": { "B·∫ßu (g)": 80 },
            "B·∫Øp c·∫£i x√†o": { "B·∫Øp c·∫£i tr√≤n (g)": 80 },
            "Rau mu·ªëng x√†o": { "Rau mu·ªëng (g)": 90 },
            "D∆∞a leo x√†o": { "D∆∞a leo (g)": 80 },
            "ƒê·∫≠u ƒë≈©a x√†o": { "ƒê·∫≠u ƒë≈© (g)": 80 },
            "C·∫£i th√¨a x√†o": { "C·∫£i th√¨a (g)": 80 },
            "Su su, c√† r·ªët x√†o": { "Su su (g)": 80, "C√† r·ªët (g)": 10 },
            "Canh Rong bi·ªÉn": { "Rong bi·ªÉn kh√¥ (g)": 0.35 },
            "Canh B·∫Øp c·∫£i tr·∫Øng, c√† r·ªët": { "B·∫Øp c·∫£i tr·∫Øng (g)": 40, "C√† r·ªët (g)": 10 },
            "Canh b·∫ßu": { "B·∫ßu (g)": 55 },
            "Canh Soup": { "C·ªß c·∫£i tr·∫Øng (g)": 10, "C√† r·ªët (g)": 10, "C·ªß d·ªÅn (g)": 10, "Su su (g)": 10, "B·∫Øp c·∫£i tr·∫Øng (g)": 15 },
            "Canh Khoai M·ª°": { "Khoai m·ª° (g)": 55 },
            "Canh B√≠ xanh": { "B√≠ xanh (g)": 55 },
            "Canh C·∫£i th·∫£o": { "C·∫£i th·∫£o (g)": 50 },
            "Canh chua rau mu·ªëng": { "rau mu·ªëng (g)": 20, "c·ªß chua (g)": 5 }
        };

        // C·∫•u tr√∫c Th·ª±c ƒë∆°n: [{ dish: "T√™n M√≥n ƒÇn", servings: S·ªë Su·∫•t }]
        let dailyMenu = JSON.parse(localStorage.getItem('dailyMenu')) || [];
        
        // Tr·∫°ng th√°i View cho b·∫£ng k·∫øt qu·∫£: 'table' (M·∫∑c ƒë·ªãnh) ho·∫∑c 'list'
        let resultsView = localStorage.getItem('resultsView') || 'table';

        // Bi·∫øn to√†n c·ª•c theo d√µi m√≥n ƒëang ch·ªânh s·ª≠a
        let editingDishName = null; 

        // --- C√ÄI ƒê·∫∂T GEMINI API ---
        const LLM_API_KEY = "";
        const LLM_MODEL = "gemini-2.5-flash-preview-05-20";
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${LLM_API_KEY}`;
        
        // --- H√ÄM L∆ØU D·ªÆ LI·ªÜU V√ÄO LOCALSTORAGE ---
        function saveData() {
            localStorage.setItem('norms', JSON.stringify(norms));
            localStorage.setItem('dailyMenu', JSON.stringify(dailyMenu));
            localStorage.setItem('resultsView', resultsView);
        }

        // --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO V√Ä MODAL ---
        
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white z-50 opacity-0 ${bgColor} text-sm`;
            box.textContent = message;
            box.classList.remove('hidden');
            
            setTimeout(() => {
                box.style.opacity = '1';
            }, 50);

            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        function showLLMModal(title, content) {
            const modal = document.getElementById('llm-modal');
            document.getElementById('llm-modal-title').textContent = title;
            document.getElementById('llm-modal-content').innerHTML = content.replace(/\n/g, '<br>'); // Convert newlines to <br>
            modal.classList.remove('hidden');
            // CƒÉn gi·ªØa modal content
            modal.querySelector('.modal-content').classList.add('scale-100');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        // --- H√ÄM CHUNG X·ª¨ L√ù GEMINI API ---

        /**
         * G·ªçi API c·ªßa Gemini v·ªõi c∆° ch·∫ø exponential backoff
         */
        async function fetchLLMResponse(prompt, systemInstruction, buttonId) {
            const button = document.getElementById(buttonId);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'ƒêang t·∫°o...';

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            const maxRetries = 5;
            let lastResult = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            lastResult = text;
                            break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Th·ª≠ l·∫°i n·∫øu l√† l·ªói Rate Limit (429) ho·∫∑c Server Error (5xx)
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Gemini API error:", error);
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            button.disabled = false;
            button.innerHTML = originalText;
            
            if (!lastResult) {
                 showMessage("L·ªói: Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Gemini sau nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau.", 'error');
            }

            return lastResult;
        }

        // --- T√çNH NƒÇNG GEMINI C·ª§ TH·ªÇ ---

        /**
         * T·∫°o g·ª£i √Ω th·ª±c ƒë∆°n m·ªõi d·ª±a tr√™n c√°c ti√™u ch√≠ t·ªëi ∆∞u h√≥a
         */
        async function generateMenuSuggestion() {
            if (Object.keys(norms).length === 0) {
                showMessage("Kh√¥ng c√≥ ƒë·ªãnh m·ª©c m√≥n ƒÉn n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng th√™m ƒë·ªãnh m·ª©c tr∆∞·ªõc.", 'error');
                return;
            }

            // 1. Chu·∫©n b·ªã danh s√°ch m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh
            const availableDishes = Object.keys(norms).map(dishName => {
                const normsForDish = norms[dishName];
                // L·∫•y nguy√™n li·ªáu ƒë·∫ßu ti√™n l√†m ƒë·∫°i di·ªán cho nguy√™n li·ªáu ch√≠nh
                const [mainIngredientKey] = Object.entries(normsForDish)[0];
                const { name: mainIngredient } = parseIngredientKey(mainIngredientKey);
                
                // Chu·∫©n h√≥a t√™n nguy√™n li·ªáu ch√≠nh ƒë·ªÉ LLM d·ªÖ ph√¢n lo·∫°i (Th·ªãt, C√°, G√†, S∆∞·ªùn, Tr·ª©ng, ƒê·∫≠u, v.v.)
                return `${dishName} (Ch√≠nh: ${mainIngredient})`;
            }).join('\n');
            
            const prompt = `T·ª´ danh s√°ch c√°c m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh sau, h√£y ƒë·ªÅ xu·∫•t m·ªôt th·ª±c ƒë∆°n ho√†n ch·ªânh cho m·ªôt ng√†y (g·ªìm 3-4 m√≥n: 1 M√≥n ch√≠nh, 1 M√≥n ph·ª•, 1 Canh) cho su·∫•t ƒÉn b√°n tr√∫, ƒë·∫£m b·∫£o c√°c ti√™u ch√≠:
            1) T·ªëi ∆∞u h√≥a vi·ªác s·ª≠ d·ª•ng nguy√™n li·ªáu (nguy√™n li·ªáu ch√≠nh n√™n kh√°c nhau).
            2) Kh√¥ng ƒë·ªÉ tr√πng l·∫∑p nguy√™n li·ªáu ch√≠nh (Th·ªãt n·∫°c vai, Th·ªãt g√†/ƒë√πi g√†, S∆∞·ªùn non, C√° phi l√™, Ch·∫£ c√°, Tr·ª©ng, ƒê·∫≠u) trong 2 m√≥n ƒë∆∞·ª£c ch·ªçn.
            3) Ph·∫£i l√† c√°c m√≥n c√≥ trong danh s√°ch.
            
            K·∫øt qu·∫£ ch·ªâ ƒë∆∞·ª£c li·ªát k√™ T√™n M√≥n ƒÇn ƒë√£ ch·ªçn, m·ªói m√≥n m·ªôt d√≤ng, kh√¥ng th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát, kh√¥ng gi·∫£i th√≠ch.

            Danh s√°ch m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh:\n${availableDishes}`;
            
            const systemInstruction = "B·∫°n l√† chuy√™n gia dinh d∆∞·ª°ng v√† qu·∫£n l√Ω b·∫øp ƒÉn tr∆∞·ªùng h·ªçc. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë∆∞a ra m·ªôt th·ª±c ƒë∆°n c√¢n b·∫±ng, ngon mi·ªáng, v√† tu√¢n th·ªß ch·∫∑t ch·∫Ω c√°c quy t·∫Øc v·ªÅ t·ªëi ∆∞u h√≥a nguy√™n li·ªáu v√† kh√¥ng tr√πng l·∫∑p ngu·ªìn protein ch√≠nh. K·∫øt qu·∫£ ph·∫£i l√† m·ªôt danh s√°ch c√°c m√≥n ƒÉn b·∫±ng ti·∫øng Vi·ªát, ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng r√µ r√†ng, ph√π h·ª£p ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ sao ch√©p v√† l·∫≠p th·ª±c ƒë∆°n.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-summary-btn');

            if (result) {
                showLLMModal("‚ú® G·ª£i √ù Th·ª±c ƒê∆°n T·ªëi ∆Øu", result);
            }
        }

        /**
         * T·∫°o g·ª£i √Ω mua s·∫Øm d·ª±a tr√™n t·ªïng nguy√™n li·ªáu
         */
        async function generateShoppingListNotes() {
            if (dailyMenu.length === 0) {
                showMessage("Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n tr∆∞·ªõc khi s·ª≠ d·ª•ng t√≠nh nƒÉng Gemini.", 'error');
                return null;
            }

            const results = calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o trong danh s√°ch t·ªïng. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            const shoppingList = Object.entries(results).map(([ingKey, qty]) => {
                const { name: ingredientName, unit } = parseIngredientKey(ingKey);
                const { convertedQuantity, convertedUnit } = getConvertedUnit(unit, qty);
                
                // S·ª≠ d·ª•ng ƒë∆°n v·ªã quy ƒë·ªïi n·∫øu l√† kg ho·∫∑c l√≠t
                const displayQty = convertedUnit !== unit ? convertedQuantity.toFixed(2) : qty;
                const displayUnit = convertedUnit !== unit ? convertedUnit : unit;

                return `${ingredientName}: ${displayQty} ${displayUnit}`;
            }).join('\n');


            const prompt = `Ph√¢n t√≠ch danh s√°ch mua s·∫Øm n√†y v√† ƒë∆∞a ra 3 l·ªùi khuy√™n ng·∫Øn g·ªçn, quan tr·ªçng cho vi·ªác mua s·∫Øm s·ªë l∆∞·ª£ng l·ªõn (V√≠ d·ª•: ∆∞u ti√™n h√†ng t∆∞∆°i, ki·ªÉm tra ch·∫•t l∆∞·ª£ng, mua s·ªâ).\n\nDanh s√°ch mua s·∫Øm:\n${shoppingList}`;

            const systemInstruction = "B·∫°n l√† m·ªôt qu·∫£n l√Ω kho v√† b·∫øp chuy√™n nghi·ªáp. H√£y ƒë∆∞a ra 3 ghi ch√∫/l·ªùi khuy√™n quan tr·ªçng nh·∫•t (theo th·ª© t·ª± ∆∞u ti√™n 1, 2, 3) cho ng∆∞·ªùi ƒëi mua s·∫Øm d·ª±a tr√™n danh s√°ch nguy√™n li·ªáu ƒë√£ cung c·∫•p. Vi·∫øt b·∫±ng ti·∫øng Vi·ªát, t·∫≠p trung v√†o t√≠nh th·ª±c t·∫ø v√† hi·ªáu qu·∫£ mua h√†ng.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-notes-btn');

            if (result) {
                showLLMModal("‚ú® G·ª£i √ù Mua S·∫Øm Hi·ªáu Qu·∫£", result);
            }
        }


        // --- LOGIC ·∫®N/HI·ªÜN KHU V·ª∞C ƒê·ªäNH M·ª®C ---
        
        /**
         * Toggle hi·ªÉn th·ªã khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         * @param {boolean} shouldOpen - N·∫øu true, m·ªü khu v·ª±c qu·∫£n l√Ω, n·∫øu false, ƒë√≥ng
         */
        function toggleNormsManagement(shouldOpen) {
            const area = document.getElementById('norms-management-area');
            const button = document.getElementById('manage-norms-btn');

            if (shouldOpen) {
                area.classList.remove('hidden');
                button.classList.add('hidden');
                // Reset form ƒë·ªÉ chu·∫©n b·ªã cho vi·ªác nh·∫≠p li·ªáu/ch·ªçn m√≥n m·ªõi
                resetNormsForm(); 
            } else {
                area.classList.add('hidden');
                button.classList.remove('hidden');
            }
        }
        
        /**
         * T√°ch t√™n nguy√™n li·ªáu v√† ƒë∆°n v·ªã t·ª´ key ƒë√£ l∆∞u (v√≠ d·ª•: "Th·ªãt B√≤ (g)")
         */
        function parseIngredientKey(key) {
            const match = key.match(/(.*)\s*(\([^\)]+\))$/);
            if (match) {
                return { name: match[1].trim(), unit: match[2].replace(/[()]/g, '') };
            }
            // M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y ƒë∆°n v·ªã
            return { name: key, unit: UNITS[0] }; 
        }

        // --- LOGIC X·ª¨ L√ù DATE V√Ä EXPORT ---
        
        /**
         * Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ JS (0=CN, 1=T2,...) sang Ti·∫øng Vi·ªát (Th·ª© Hai, Th·ª© Ba,...)
         * @param {Date} date - ƒê·ªëi t∆∞·ª£ng ng√†y th√°ng
         * @returns {string} Th·ª© trong tu·∫ßn b·∫±ng Ti·∫øng Vi·ªát
         */
        function getVietnameseDayOfWeek(date) {
            const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
            return days[date.getDay()];
        }

        /**
         * Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán t·∫°i
         */
        function initializeDate() {
            const dateInput = document.getElementById('menu-date');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            renderResultsTitle(); // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ l·∫ßn ƒë·∫ßu
        }
        
        /**
         * C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ k·∫øt qu·∫£ v·ªõi ng√†y ƒë√£ ch·ªçn
         */
        function renderResultsTitle() {
            const dateInput = document.getElementById('menu-date');
            const menuDateValue = dateInput.value;
            let dateString = '';

            if (menuDateValue) {
                // L·∫•y th√¥ng tin ng√†y th√°ng
                const [year, month, day] = menuDateValue.split('-');
                const dateObj = new Date(menuDateValue.replace(/-/g, '/')); // T·∫°o Date object
                
                const dayOfWeek = getVietnameseDayOfWeek(dateObj);

                // ƒê·ªãnh d·∫°ng chu·ªói hi·ªÉn th·ªã: "Th·ª© Hai, Ng√†y 01/01/2024"
                dateString = `${dayOfWeek}, Ng√†y ${day}/${month}/${year}`;
            }
            
            const titleHeader = document.getElementById('results-title-header');
            const exportButtonHtml = titleHeader.querySelector('div').outerHTML; // L·∫•y c·∫£ kh·ªëi n√∫t
            
            titleHeader.innerHTML = `
                üõí T·ªïng Nguy√™n Li·ªáu C·∫ßn Thi·∫øt <span class="text-indigo-700">${dateString}</span>
                ${exportButtonHtml}
            `;
        }
        
        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô xem b·∫£ng v√† danh s√°ch cho k·∫øt qu·∫£.
         */
        function toggleResultsView() {
            resultsView = resultsView === 'table' ? 'list' : 'table';
            saveData();
            renderResults(); // G·ªçi h√†m render ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
        }

        /**
         * C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi giao di·ªán
         */
        function updateViewToggleButton() {
            const btn = document.getElementById('toggle-view-btn');
            if (!btn) return;
            
            const isTableView = resultsView === 'table';

            if (isTableView) {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    D·∫°ng Danh s√°ch
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng danh s√°ch (t·ªëi ∆∞u mobile)";
            } else {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-3-8l-3 4m6-4l3 4"></path></svg>
                    D·∫°ng B·∫£ng
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng b·∫£ng (chi ti·∫øt)";
            }
        }


        /**
         * Xu·∫•t d·ªØ li·ªáu nguy√™n li·ªáu c·∫ßn thi·∫øt sang file CSV c√≥ BOM (h·ªó tr·ª£ ti·∫øng Vi·ªát)
         */
        function exportResultsToCSVWithBOM() {
            const dateInput = document.getElementById('menu-date');
            // ƒê·ªãnh d·∫°ng t√™n file: yyyy-mm-dd
            const menuDate = dateInput.value || new Date().toISOString().split('T')[0]; 
            const results = calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë·ªÉ xu·∫•t. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            // S·ª≠ d·ª•ng d·∫•u ph·∫©y (,) l√†m delimiter cho CSV
            // C·ªôt ti√™u ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c b·ªï sung th√¥ng tin
            let csvContent = "Nguy√™n Li·ªáu,S·ªë L∆∞·ª£ng (G·ªëc),ƒê∆°n V·ªã (G·ªëc),S·ªë L∆∞·ª£ng (Quy ƒê·ªïi),ƒê∆°n V·ªã (Quy ƒê·ªïi)\r\n";

            // Data rows
            const ingredientsArray = Object.entries(results).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                const { name: ingredientName, unit } = parseIngredientKey(ingredientWithUnit);
                
                // T√≠nh to√°n quy ƒë·ªïi
                const { convertedQuantity, convertedUnit } = getConvertedUnit(unit, quantity);

                // L√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n
                const formattedQuantity = Number.isInteger(quantity) ? quantity.toString() : quantity.toFixed(2); 
                const formattedConvertedQuantity = Number.isInteger(convertedQuantity) ? convertedQuantity.toString() : convertedQuantity.toFixed(2);
                
                // D√≤ng d·ªØ li·ªáu CSV
                const row = `"${ingredientName}",${formattedQuantity},"${unit}",${formattedConvertedQuantity},"${convertedUnit}"`;
                csvContent += row + "\r\n";
            });

            // Th√™m Byte Order Mark (BOM) ƒë·ªÉ Excel nh·∫≠n di·ªán UTF-8
            const bom = "\uFEFF"; 
            const encodedCsvContent = bom + csvContent;

            // T·∫°o Blob object v·ªõi MIME type CSV v√† BOM (UTF-8)
            const csvBlob = new Blob([encodedCsvContent], { type: 'text/csv;charset=utf-8;' });
            const dataUri = URL.createObjectURL(csvBlob);
            
            // T·∫°o file v√† t·∫£i xu·ªëng
            const link = document.createElement("a");
            link.setAttribute("href", dataUri);
            link.setAttribute("download", `nguyen_lieu_thuc_don_${menuDate}.csv`); // ƒê·∫∑t ph·∫ßn m·ªü r·ªông l√† .csv
            document.body.appendChild(link); // Required for certain browsers
            link.click();
            document.body.removeChild(link);
            
            // X√≥a URL object khi kh√¥ng c·∫ßn thi·∫øt n·ªØa
            URL.revokeObjectURL(dataUri); 

            showMessage(`ƒê√£ xu·∫•t file nguyen_lieu_thuc_don_${menuDate}.csv th√†nh c√¥ng!`);
        }
        // Gi·ªØ l·∫°i h√†m c≈© ƒë·ªÉ tr√°nh l·ªói tham chi·∫øu n·∫øu c√≥, nh∆∞ng c·∫≠p nh·∫≠t t√™n
        function exportResultsToXLS() {
             exportResultsToCSVWithBOM();
        }
        function exportResultsToCSV() {
             exportResultsToCSVWithBOM();
        }


        // --- LOGIC X·ª¨ L√ù ƒê·ªäNH M·ª®C NGUY√äN LI·ªÜU (NORMS) ---

        /**
         * Thi·∫øt l·∫≠p form ch·ªânh s·ª≠a/th√™m m√≥n ƒÉn v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (ch·ªçn m√≥n)
         */
        function resetNormsForm() {
            editingDishName = null;
            document.getElementById('form-title').textContent = 'Ch·ªçn m√≥n ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªãnh m·ª©c';
            document.getElementById('current-norm-dish-name').value = '';
            
            // ·∫®n v√πng nh·∫≠p nguy√™n li·ªáu v√† n√∫t l∆∞u/x√≥a/c·∫≠p nh·∫≠t
            document.getElementById('new-ingredient-inputs').innerHTML = '';
            document.getElementById('add-edit-form').classList.add('hidden');
        }

        /**
         * Hi·ªán form v√† t·∫£i d·ªØ li·ªáu cho m√≥n ƒëang ch·ªçn
         */
        function loadNormsForm(dishName) {
            document.getElementById('add-edit-form').classList.remove('hidden');
            document.getElementById('current-norm-dish-name').value = dishName;

            // X√≥a input c≈©
            document.getElementById('new-ingredient-inputs').innerHTML = '';

            const normData = norms[dishName];
            
            if (normData) {
                // Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a m√≥n ƒë√£ c√≥
                editingDishName = dishName;
                document.getElementById('form-title').textContent = `Ch·ªânh S·ª≠a ƒê·ªãnh M·ª©c: ${dishName}`;
                Object.entries(normData).forEach(([key, quantity]) => {
                    addIngredientInput(key, quantity);
                });
                document.getElementById('delete-norm-button').classList.remove('hidden');

            } else {
                // Ch·∫ø ƒë·ªô th√™m m√≥n m·ªõi
                editingDishName = null;
                document.getElementById('form-title').textContent = `Th√™m M√≥n M·ªõi: ${dishName}`;
                addIngredientInput(); 
                document.getElementById('delete-norm-button').classList.add('hidden');
            }
        }
        
        /**
         * H√†m l∆∞u/c·∫≠p nh·∫≠t ƒë·ªãnh m·ª©c (ƒë∆∞·ª£c g·ªçi b·ªüi n√∫t L∆∞u/C·∫≠p Nh·∫≠t)
         */
        function saveDishNorm() {
            const currentDishName = document.getElementById('current-norm-dish-name').value.trim();

            if (!currentDishName) {
                showMessage("L·ªói: Vui l√≤ng ch·ªçn m√≥n ƒÉn ho·∫∑c nh·∫≠p t√™n m√≥n m·ªõi tr∆∞·ªõc khi l∆∞u.", 'error');
                return;
            }

            const newNorm = {};
            let hasValidIngredient = false;

            const nameInputs = document.querySelectorAll('#new-ingredient-inputs .ingredient-name');
            const unitSelects = document.querySelectorAll('#new-ingredient-inputs .ingredient-unit');
            const quantityInputs = document.querySelectorAll('#new-ingredient-inputs .ingredient-quantity');


            nameInputs.forEach((nameInput, index) => {
                const ingredientName = nameInput.value.trim();
                const unit = unitSelects[index].value; 
                const quantity = parseFloat(quantityInputs[index].value);

                if (ingredientName && quantity >= 0) {
                    const fullIngredientName = `${ingredientName} ${unit}`;
                    newNorm[fullIngredientName] = quantity;
                    if (quantity > 0) hasValidIngredient = true;
                }
            });

            if (!hasValidIngredient) {
                showMessage("M√≥n ƒÉn ph·∫£i c√≥ √≠t nh·∫•t m·ªôt nguy√™n li·ªáu v·ªõi ƒë·ªãnh m·ª©c > 0.", 'error');
                return;
            }
            
            // L∆∞u/C·∫≠p nh·∫≠t
            norms[currentDishName] = newNorm; 
            saveData();

            showMessage(`ƒê·ªãnh m·ª©c m√≥n '${currentDishName}' ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T th√†nh c√¥ng!`);
            
            // Reset form sau khi l∆∞u
            resetNormsForm(); 
            // C·∫≠p nh·∫≠t l·∫°i danh s√°ch m√≥n ƒÉn trong Th·ª±c ƒë∆°n n·∫øu c√≥ thay ƒë·ªïi t√™n m√≥n
            renderAll(); 
        }

        /**
         * Th√™m tr∆∞·ªùng input cho nguy√™n li·ªáu m·ªõi v√†o form th√™m ƒë·ªãnh m·ª©c
         * @param {string} key - Key nguy√™n li·ªáu ƒë√£ l∆∞u (v√≠ d·ª•: "Th·ªãt B√≤ (g)")
         * @param {number} quantity - ƒê·ªãnh m·ª©c s·ªë l∆∞·ª£ng
         */
        function addIngredientInput(key = '', quantity = '') {
            const container = document.getElementById('new-ingredient-inputs');
            const inputGroup = document.createElement('div');
            // Responsive layout cho input nguy√™n li·ªáu
            inputGroup.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2';
            
            const { name: ingredientName, unit: ingredientUnit } = parseIngredientKey(key);
            
            const unitOptions = UNITS.map(unit => 
                `<option value="(${unit})" ${ingredientUnit === unit ? 'selected' : ''}>${unit}</option>`
            ).join('');

            inputGroup.innerHTML = `
                <input type="text" placeholder="T√™n Nguy√™n li·ªáu" value="${ingredientName}" class="flex-grow p-2 border rounded-md ingredient-name text-sm">
                <select class="w-full sm:w-20 p-2 border rounded-md ingredient-unit focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                    ${unitOptions}
                </select>
                <div class="flex space-x-2">
                    <input type="number" placeholder="ƒê·ªãnh m·ª©c (1 su·∫•t)" value="${quantity}" min="0" class="w-full sm:w-28 p-2 border rounded-md ingredient-quantity text-right text-sm">
                    <button type="button" onclick="this.closest('.flex.flex-col').remove();" class="text-red-500 hover:text-red-700 p-2 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            container.appendChild(inputGroup);
        }

        /**
         * X√≥a ƒë·ªãnh m·ª©c m√≥n ƒÉn. (L∆ØU √ù: Kh√¥ng d√πng confirm() n√™n thao t√°c n√†y x√≥a ngay l·∫≠p t·ª©c)
         */
        function deleteNorm(dish) {
            if (!dish || !(dish in norms)) {
                 showMessage("M√≥n ƒÉn kh√¥ng t·ªìn t·∫°i trong ƒë·ªãnh m·ª©c.", 'error');
                 return;
            }
            
            delete norms[dish];
            // X√≥a m√≥n ƒÉn n√†y kh·ªèi th·ª±c ƒë∆°n n·∫øu c√≥
            dailyMenu = dailyMenu.filter(item => item.dish !== dish);
            
            saveData();
            // ƒê√≥ng khu v·ª±c ch·ªânh s·ª≠a v√† reset form
            resetNormsForm();
            toggleNormsManagement(false);
            
            renderAll();
            showMessage(`ƒê·ªãnh m·ª©c m√≥n '${dish}' ƒë√£ ƒë∆∞·ª£c x√≥a.`);
        }
        
        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn cho vi·ªác qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        function renderSearchableNormDishList() {
            const listContainer = document.getElementById('norm-dish-options');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            
            const dishNames = Object.keys(norms).sort();

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ch∆∞a c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => selectNormDish(dish); // D√πng mousedown ƒë·ªÉ ngƒÉn onblur
                listContainer.appendChild(itemDiv);
            });
        }

        /**
         * L·ªçc danh s√°ch m√≥n ƒÉn cho khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        function filterNormDishList(searchTerm) {
            const listContainer = document.getElementById('norm-dish-options');
            const normalizedTerm = removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            if (listContainer.children.length === 0) {
                 renderSearchableNormDishList();
            }

            listContainer.innerHTML = ''; 

            if (normalizedTerm.length === 0) {
                renderSearchableNormDishList();
                listContainer.classList.remove('hidden');
                resetNormsForm(); // Reset form khi input r·ªóng
                return;
            }
            
            const dishNames = Object.keys(norms).sort();
            let matchedDishes = [];

            dishNames.forEach(dish => {
                const normalizedDishName = removeVietnameseDiacritics(dish);

                if (normalizedDishName.includes(normalizedTerm)) {
                    matchedDishes.push(dish);
                }
            });

            matchedDishes.forEach(dish => {
                 const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => selectNormDish(dish);
                listContainer.appendChild(itemDiv);
                foundCount++;
            });

            if (foundCount === 0) {
                // N·∫øu kh√¥ng t√¨m th·∫•y, hi·ªÉn th·ªã t√πy ch·ªçn th√™m m·ªõi
                const newDishName = searchTerm.trim();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                msgDiv.textContent = `Kh√¥ng t√¨m th·∫•y. Nh·∫•n ƒë·ªÉ Th√™m m√≥n "${newDishName}"`;
                msgDiv.classList.add('cursor-pointer', 'hover:bg-green-100');
                msgDiv.onmousedown = () => selectNormDish(newDishName, true);
                listContainer.appendChild(msgDiv);

            }
            listContainer.classList.remove('hidden');
        }
        
        /**
         * Ch·ªçn m√≥n ƒÉn t·ª´ danh s√°ch cho khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        function selectNormDish(dishName, isNew = false) {
            document.getElementById('norm-dish-search').value = dishName;
            document.getElementById('norm-dish-options').classList.add('hidden'); // ·∫®n danh s√°ch
            loadNormsForm(dishName); // T·∫£i form ch·ªânh s·ª≠a/th√™m
        }
        
        // --- LOGIC T√åM KI·∫æM V√Ä CH·ªåN M√ìN ƒÇN TRONG TH·ª∞C ƒê∆†N ---

        /**
         * H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát (chu·∫©n h√≥a Unicode)
         * @param {string} str - Chu·ªói c√≥ d·∫•u
         * @returns {string} Chu·ªói kh√¥ng d·∫•u, ch·ªØ th∆∞·ªùng
         */
        function removeVietnameseDiacritics(str) {
            str = str.toLowerCase();
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            // X√≥a c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát v√† kho·∫£ng tr·∫Øng d∆∞ th·ª´a
            str = str.replace(/\s+/g, ' ').trim();
            return str;
        }

        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn c√≥ th·ªÉ t√¨m ki·∫øm
         */
        function renderSearchableDishList() {
            const listContainer = document.getElementById('dish-options-list');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            
            const dishNames = Object.keys(norms).sort();

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => selectDish(dish); // D√πng mousedown ƒë·ªÉ ngƒÉn onblur
                listContainer.appendChild(itemDiv);
            });
        }
        
        /**
         * L·ªçc danh s√°ch m√≥n ƒÉn d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
         */
        function filterDishList(searchTerm) {
            const listContainer = document.getElementById('dish-options-list');
            // Chu·∫©n h√≥a t·ª´ kh√≥a t√¨m ki·∫øm (kh√¥ng d·∫•u, ch·ªØ th∆∞·ªùng)
            const normalizedTerm = removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            // ƒê·∫£m b·∫£o danh s√°ch ƒë√£ ƒë∆∞·ª£c render tr∆∞·ªõc khi l·ªçc
            if (listContainer.children.length === 0) {
                 renderSearchableDishList();
            }

            // X√≥a gi√° tr·ªã c·ªßa hidden input khi b·∫Øt ƒë·∫ßu t√¨m ki·∫øm m·ªõi ho·∫∑c g√µ
            document.getElementById('menu-dish-select').value = ''; 
            
            const dishOptions = listContainer.querySelectorAll('.dish-option');
            
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y
            const notFoundMessageId = 'dish-not-found-msg';
            const existingMessage = document.getElementById(notFoundMessageId);
            
            // N·∫øu c√≥ th√¥ng b√°o kh√¥ng t√¨m th·∫•y, x√≥a n√≥ ƒëi tr∆∞·ªõc khi l·ªçc l·∫°i
            if (existingMessage) existingMessage.remove(); 
            listContainer.innerHTML = ''; // X√≥a to√†n b·ªô n·ªôi dung trong list container

            if (normalizedTerm.length === 0) {
                // N·∫øu input r·ªóng, hi·ªÉn th·ªã l·∫°i to√†n b·ªô m√≥n
                renderSearchableDishList();
                listContainer.classList.remove('hidden');

            } else {
                 // N·∫øu c√≥ t·ª´ kh√≥a t√¨m ki·∫øm
                const dishNames = Object.keys(norms).sort();

                dishNames.forEach(dish => {
                    // Chu·∫©n h√≥a t√™n m√≥n ƒÉn trong database (kh√¥ng d·∫•u, ch·ªØ th∆∞·ªùng)
                    const normalizedDishName = removeVietnameseDiacritics(dish);

                    if (normalizedDishName.includes(normalizedTerm)) {
                        const itemDiv = document.createElement('div');
                        itemDiv.textContent = dish;
                        itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                        itemDiv.setAttribute('data-dish-name', dish);
                        itemDiv.onmousedown = () => selectDish(dish);
                        listContainer.appendChild(itemDiv);
                        foundCount++;
                    }
                });

                if (foundCount === 0) {
                    const msgDiv = document.createElement('div');
                    msgDiv.id = notFoundMessageId;
                    msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                    msgDiv.textContent = 'Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn ph√π h·ª£p.';
                    listContainer.appendChild(msgDiv);
                }
                listContainer.classList.remove('hidden');
            }
        }
        
        /**
         * Ch·ªçn m√≥n ƒÉn t·ª´ danh s√°ch
         */
        function selectDish(dishName) {
            document.getElementById('dish-search-input').value = dishName;
            document.getElementById('menu-dish-select').value = dishName;
            document.getElementById('dish-options-list').classList.add('hidden'); // ·∫®n danh s√°ch
        }


        // --- LOGIC X·ª¨ L√ù TH·ª∞C ƒê∆†N NG√ÄY (DAILY MENU) ---
        
        /**
         * H√†m nhanh ƒë·ªÉ ƒëi·ªÅn s·ªë su·∫•t
         */
        function setServings(quantity) {
             document.getElementById('menu-servings-input').value = quantity;
        }


        /**
         * Th√™m m√≥n ƒÉn v√† s·ªë su·∫•t v√†o th·ª±c ƒë∆°n ng√†y
         */
        function addDishToMenu() {
            // S·ª≠ d·ª•ng hidden input ƒë·ªÉ l·∫•y gi√° tr·ªã m√≥n ƒë√£ ch·ªçn
            const dishSelect = document.getElementById('menu-dish-select');
            const servingsInput = document.getElementById('menu-servings-input');
            
            const dish = dishSelect.value;
            const servings = parseInt(servingsInput.value);

            if (!dish || !(dish in norms)) {
                showMessage("Vui l√≤ng ch·ªçn m·ªôt m√≥n ƒÉn h·ª£p l·ªá t·ª´ danh s√°ch.", 'error');
                return;
            }
            if (isNaN(servings) || servings <= 0) {
                showMessage("S·ªë su·∫•t ƒÉn ph·∫£i l√† s·ªë d∆∞∆°ng.", 'error');
                return;
            }

            // Ki·ªÉm tra n·∫øu m√≥n ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t s·ªë su·∫•t
            const existingItem = dailyMenu.find(item => item.dish === dish);
            if (existingItem) {
                existingItem.servings += servings;
            } else {
                dailyMenu.push({ dish, servings });
            }

            saveData();
            renderMenu();
            calculateAndRenderResults();
            showMessage(`ƒê√£ th√™m ${servings} su·∫•t '${dish}' v√†o th·ª±c ƒë∆°n.`);
            
            // Reset input sau khi th√™m th√†nh c√¥ng
            document.getElementById('dish-search-input').value = ''; 
            dishSelect.value = '';
            servingsInput.value = 1;
        }

        /**
         * X√≥a m√≥n ƒÉn kh·ªèi th·ª±c ƒë∆°n ng√†y
         */
        function deleteDishFromMenu(index) {
            dailyMenu.splice(index, 1);
            saveData();
            renderMenu();
            calculateAndRenderResults();
            showMessage("M√≥n ƒÉn ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi th·ª±c ƒë∆°n.", 'warning');
        }

        /**
         * ƒê·∫∑t l·∫°i to√†n b·ªô th·ª±c ƒë∆°n ng√†y
         */
        function resetDailyMenu() {
            dailyMenu = [];
            saveData();
            renderMenu();
            calculateAndRenderResults();
            showMessage("Th·ª±c ƒë∆°n ng√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng.", 'warning');
        }

        /**
         * C·∫≠p nh·∫≠t s·ªë su·∫•t c·ªßa m√≥n ƒÉn trong th·ª±c ƒë∆°n
         */
        function updateServings(index, value) {
            const servings = parseInt(value);
             if (isNaN(servings) || servings <= 0) {
                showMessage("S·ªë su·∫•t kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë su·∫•t l·ªõn h∆°n 0.", 'warning');
                if (servings <= 0) {
                    deleteDishFromMenu(index);
                } else {
                    renderMenu(); 
                }
                return;
            }
            
            dailyMenu[index].servings = servings;
            saveData();
            calculateAndRenderResults();
        }

        /**
         * L·∫•y ƒë·ªãnh m·ª©c (norms) c·ªßa m·ªôt m√≥n ƒÉn, ƒë·ªãnh d·∫°ng th√†nh chu·ªói HTML ƒë·ªÉ hi·ªÉn th·ªã
         * @param {string} dishName - T√™n m√≥n ƒÉn
         * @returns {string} HTML string of ingredients
         */
        function getDishNormsHtml(dishName) {
            const normData = norms[dishName];
            if (!normData) return '<span class="text-red-500 italic">Thi·∫øu ƒê·ªãnh M·ª©c</span>';

            let ingredientsHtml = Object.entries(normData).map(([ingKey, qty]) => {
                const { name, unit } = parseIngredientKey(ingKey);
                // Hi·ªÉn th·ªã ƒë·ªãnh m·ª©c chi ti·∫øt cho 1 su·∫•t
                return `<span class="inline-block text-xs text-gray-600 mr-2">${name}: **${qty}** ${unit}</span>`;
            }).join(' | ');

            return `<div class="text-xs text-gray-500 mt-1 pt-1 border-t border-gray-100">${ingredientsHtml}</div>`;
        }

        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn trong th·ª±c ƒë∆°n
         */
        function renderMenu() {
            const tableBody = document.getElementById('daily-menu-table-body');
            tableBody.innerHTML = '';
            
            if (dailyMenu.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Th·ª±c ƒë∆°n h√¥m nay ch∆∞a c√≥ m√≥n n√†o.</td></tr>`;
                return;
            }

            dailyMenu.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                
                const dishNormsHtml = getDishNormsHtml(item.dish);

                row.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-900">
                        ${item.dish}
                        <div class="mt-1">${dishNormsHtml}</div>
                    </td>
                    <td class="px-3 sm:px-6 py-3">
                        <input type="number" 
                            value="${item.servings}" 
                            min="1" 
                            onchange="updateServings(${index}, this.value)"
                            class="w-full p-1 border rounded-md text-center focus:ring-green-500 focus:border-green-500 text-sm">
                    </td>
                    <td class="px-3 sm:px-6 py-3 text-right">
                        <button onclick="deleteDishFromMenu(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full" title="X√≥a m√≥n ƒÉn">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- LOGIC T√çNH TO√ÅN V√Ä HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---

        /**
         * H√†m quy ƒë·ªïi ƒë∆°n v·ªã g->kg v√† ml->l
         * @param {string} unit - ƒê∆°n v·ªã g·ªëc (g, ml,...)
         * @param {number} quantity - S·ªë l∆∞·ª£ng g·ªëc
         * @returns {{convertedQuantity: number, convertedUnit: string}}
         */
        function getConvertedUnit(unit, quantity) {
            let convertedQuantity = quantity;
            let convertedUnit = unit;

            if (unit === 'g' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'kg';
            } else if (unit === 'ml' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'l';
            }
            // N·∫øu s·ªë l∆∞·ª£ng nh·ªè h∆°n 1000 (ho·∫∑c ƒë∆°n v·ªã kh√°c), gi·ªØ nguy√™n
            return { convertedQuantity, convertedUnit };
        }

        /**
         * Th·ª±c hi·ªán t√≠nh to√°n t·ªïng l∆∞·ª£ng nguy√™n li·ªáu
         */
        function calculateTotalIngredients() {
            const totalIngredients = {};

            dailyMenu.forEach(menuItem => {
                const dish = menuItem.dish;
                const servings = menuItem.servings;
                
                const dishNorms = norms[dish];

                if (dishNorms) {
                    for (const ingredient in dishNorms) {
                        const normQuantity = dishNorms[ingredient]; // ƒê·ªãnh m·ª©c (cho 1 su·∫•t)
                        const requiredQuantity = normQuantity * servings; // S·ªë l∆∞·ª£ng c·∫ßn cho to√†n b·ªô su·∫•t

                        // C·ªông d·ªìn v√†o t·ªïng
                        if (totalIngredients[ingredient]) {
                            totalIngredients[ingredient] += requiredQuantity;
                        } else {
                            totalIngredients[ingredient] = requiredQuantity;
                        }
                    }
                }
            });

            return totalIngredients;
        }

        /**
         * Hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£ t·ªïng nguy√™n li·ªáu
         */
        function renderResults() {
            const totalIngredients = calculateTotalIngredients();
            const tableBody = document.getElementById('results-table-body');
            const listBody = document.getElementById('results-list-view');
            const tableView = document.getElementById('results-table-view');
            
            // C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi
            updateViewToggleButton();
            
            // X√≥a n·ªôi dung c≈©
            tableBody.innerHTML = '';
            listBody.innerHTML = '';
            
            const ingredientsArray = Object.entries(totalIngredients).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            if (ingredientsArray.length === 0) {
                const emptyRow = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</td></tr>`;
                tableBody.innerHTML = emptyRow;
                listBody.innerHTML = `<p class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</p>`;
                
                // ·∫®n/hi·ªán d·ª±a tr√™n ch·∫ø ƒë·ªô xem (ngay c·∫£ khi r·ªóng)
                if (resultsView === 'table') {
                    tableView.classList.remove('hidden');
                    listBody.classList.add('hidden');
                } else {
                    tableView.classList.add('hidden');
                    listBody.classList.remove('hidden');
                }
                return;
            }

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                // T√°ch T√™n Nguy√™n Li·ªáu v√† ƒê∆°n V·ªã
                const { name: ingredientName, unit } = parseIngredientKey(ingredientWithUnit);
                
                // Quy ƒë·ªïi ƒë∆°n v·ªã
                const { convertedQuantity, convertedUnit } = getConvertedUnit(unit, quantity);

                // ƒê·ªãnh d·∫°ng s·ªë l∆∞·ª£ng g·ªëc
                const displayQuantity = Number.isInteger(quantity) ? quantity.toLocaleString('vi-VN') : quantity.toFixed(2).toLocaleString('vi-VN');
                
                // ƒê·ªãnh d·∫°ng s·ªë l∆∞·ª£ng ƒë√£ quy ƒë·ªïi
                const displayConvertedQuantity = Number.isInteger(convertedQuantity) ? convertedQuantity.toLocaleString('vi-VN') : convertedQuantity.toFixed(2).toLocaleString('vi-VN');
                
                // 1. T·∫°o h√†ng cho ch·∫ø ƒë·ªô B·∫£ng (Table View)
                const tableRow = document.createElement('tr');
                tableRow.className = 'bg-white hover:bg-yellow-100 transition duration-100';
                tableRow.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-800">${ingredientName}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right font-semibold text-yellow-800">${displayQuantity} ${unit}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right text-yellow-600 font-medium">${displayConvertedQuantity} ${convertedUnit}</td>
                `;
                tableBody.appendChild(tableRow);
                
                // 2. T·∫°o Card cho ch·∫ø ƒë·ªô Danh s√°ch (List View)
                const listItem = document.createElement('div');
                listItem.className = 'p-3 bg-white rounded-lg shadow-sm border border-yellow-300';
                listItem.innerHTML = `
                    <div class="font-bold text-base text-gray-800 mb-1">${ingredientName}</div>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-1">
                        <span class="text-xs text-gray-500">T·ªïng S·ªë L∆∞·ª£ng (G·ªëc):</span>
                        <span class="font-semibold text-yellow-800 text-sm">${displayQuantity} ${unit}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-xs text-gray-500">Quy ƒê·ªïi:</span>
                        <span class="font-medium text-yellow-600 text-sm">${displayConvertedQuantity} ${convertedUnit}</span>
                    </div>
                `;
                listBody.appendChild(listItem);
            });
            
            // ·∫®n/hi·ªán giao di·ªán theo tr·∫°ng th√°i view
            if (resultsView === 'table') {
                tableView.classList.remove('hidden');
                listBody.classList.add('hidden');
            } else {
                tableView.classList.add('hidden');
                listBody.classList.remove('hidden');
            }
        }
        
        /**
         * H√†m t·ªïng h·ª£p ƒë·ªÉ render l·∫°i t·∫•t c·∫£
         */
        function renderAll() {
            // renderNorms(); // ƒê√£ x√≥a ch·ª©c nƒÉng render danh s√°ch ƒë·ªãnh m·ª©c
            renderMenu();
            calculateAndRenderResults();
        }

        function calculateAndRenderResults() {
             // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o updateServings ho√†n t·∫•t tr∆∞·ªõc khi t√≠nh to√°n
             setTimeout(renderResults, 50);
        }

        // --- KH·ªûI T·∫†O ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDate(); // Kh·ªüi t·∫°o ng√†y
            resetNormsForm(); // Kh·ªüi t·∫°o form ·ªü tr·∫°ng th√°i ch·ªçn m√≥n
            renderAll();
        });
    </script>

</body>
</html>