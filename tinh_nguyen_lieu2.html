<!DOCTYPE html>
<html lang="vi">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh Nguy√™n Li·ªáu Th·ª±c ƒê∆°n B√°n Tr√∫</title>
    
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† ƒë√°p ·ª©ng -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- === TH√äM M·ªöI: Th∆∞ vi·ªán ƒë·ªçc file Excel (SheetJS) === -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- T·∫£i Firebase SDKs (Module Imports) -->
    <script type="module">
        // Import c√°c h√†m b·∫°n c·∫ßn t·ª´ SDKs
        // S·ª¨A L·ªñI: Import to√†n b·ªô module ƒë·ªÉ g√°n v√†o window
        import * as firebaseAppModule from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import * as firebaseAuthModule from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import * as firebaseFirestoreModule from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // G√°n module v√†o window ƒë·ªÉ script ·ªü body c√≥ th·ªÉ d√πng
        window.firebaseAppModule = firebaseAppModule;
        window.firebaseAuthModule = firebaseAuthModule;
        // S·ª¨A L·ªñI (ƒê√£ th√™m d√≤ng n√†y):
        window.firebaseFirestoreModule = firebaseFirestoreModule; 

        // --- C·∫§U H√åNH FIREBASE (ƒê√É S·ª¨A ƒê·ªÇ D√ôNG BI·∫æN M√îI TR∆Ø·ªúNG) ---
        // S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng do n·ªÅn t·∫£ng cung c·∫•p
        window.firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT_ID.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
              };
        // ---------------------------------------------

        // Kh·ªüi t·∫°o Firebase v√† c√°c d·ªãch v·ª•
        window.firebaseApp = firebaseAppModule.initializeApp(window.firebaseConfig);
        window.db = firebaseFirestoreModule.getFirestore(window.firebaseApp);
        window.auth = firebaseAuthModule.getAuth(window.firebaseApp);

        // K√≠ch ho·∫°t l·∫°i network (n·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ t·∫Øt)
        firebaseFirestoreModule.enableNetwork(window.db).catch(error => {
            console.warn("L·ªói khi k√≠ch ho·∫°t l·∫°i m·∫°ng Firestore:", error);
        });

    </script>

    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ v√† cƒÉn ch·ªânh c∆° b·∫£n */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 1rem;
        }
        /* ... existing style rules ... */
        .ingredient-select-container {
            max-height: 10rem; /* Gi·ªõi h·∫°n chi·ªÅu cao cho dropdown nguy√™n li·ªáu */
            overflow-y: auto;
            /* ƒê·∫£m b·∫£o n√≥ n·ªïi l√™n tr√™n c√°c input kh√°c */
            z-index: 20; 
        }

        /* === TH√äM M·ªöI: CSS CHO IN ·∫§N === */
        @media print {
            body {
                padding: 0;
                margin: 0;
                font-family: 'Times New Roman', Times, serif; /* Font chu·∫©n cho in ·∫•n */
            }
            /* ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ kh√¥ng mu·ªën in */
            .no-print, 
            #norms-section, 
            #daily-menu-section .flex, /* ·∫®n c√°c kh·ªëi n√∫t */
            #results-section h2 div, /* ·∫®n kh·ªëi n√∫t c·ªßa k·∫øt qu·∫£ */
            #message-box,
            #llm-modal {
                display: none !important;
            }

            /* Ch·ªâ ƒë·ªãnh v√πng ƒë∆∞·ª£c in */
            .printable-section {
                display: none !important;
            }

            /* Khi in menu */
            body.printing-menu #daily-menu-section {
                display: block !important;
            }
            body.printing-menu #daily-menu-section .table-responsive {
                display: block !important;
            }
            body.printing-menu #daily-menu-section h2,
            body.printing-menu #daily-menu-section table {
                display: block !important;
            }
            /* ·∫®n c·ªôt S·ªë su·∫•t v√† X√≥a khi in menu */
            body.printing-menu #daily-menu-table-body input,
            body.printing-menu #daily-menu-table-body button,
            body.printing-menu thead th:nth-child(2),
            body.printing-menu thead th:nth-child(3),
            body.printing-menu tbody td:nth-child(2),
            body.printing-menu tbody td:nth-child(3) {
                display: none !important;
            }
            body.printing-menu tbody td {
                font-size: 11pt; /* C·ª° ch·ªØ A5 */
            }
            body.printing-menu h2 {
                font-size: 14pt;
                text-align: center;
            }
             body.printing-menu #menu-date {
                display: none; /* ·∫®n input ng√†y */
             }


            /* Khi in k·∫øt qu·∫£ */
            body.printing-results #results-section {
                display: block !important;
            }
            body.printing-results #results-section #results-table-view {
                display: block !important;
            }
            body.printing-results #results-section h2,
            body.printing-results #results-section table {
                display: block !important;
            }
            body.printing-results #results-list-view {
                display: none !important; /* Lu√¥n d√πng b·∫£ng khi in */
            }
            body.printing-results #results-title-header span {
                display: block; /* Hi·ªÉn th·ªã ng√†y th√°ng r√µ r√†ng */
                text-align: center;
                font-size: 12pt;
                margin-top: 5px;
            }
             body.printing-results h2 {
                font-size: 14pt;
                text-align: center;
             }
             body.printing-results tbody td {
                font-size: 11pt;
             }

            /* Thi·∫øt l·∫≠p chung cho kh·ªï A5 */
            @page {
                size: A5 portrait;
                margin: 1cm;
            }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Modal cho k·∫øt qu·∫£ LLM -->
    <div id="llm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-backdrop transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-2xl modal-content transform transition-transform duration-300 scale-95">
            <h3 id="llm-modal-title" class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">K·∫øt Qu·∫£ Gemini ‚ú®</h3>
            <div id="llm-modal-content" class="text-gray-700 whitespace-pre-wrap">
                <!-- LLM response content -->
            </div>
            <button onclick="document.getElementById('llm-modal').classList.add('hidden')" class="mt-6 w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150">ƒê√≥ng</button>
        </div>
    </div>
    <!-- K·∫øt th√∫c Modal -->


    <div class="max-w-4xl mx-auto p-2 sm:p-6 bg-white shadow-xl rounded-xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700 mb-6 border-b pb-2">
            üìä T√≠nh To√°n T·ªïng Nguy√™n Li·ªáu Theo Th·ª±c ƒê∆°n B√°n Tr√∫
        </h1>
        <p class="text-gray-600 mb-6 text-sm sm:text-base">
            Nh·∫≠p ƒë·ªãnh m·ª©c nguy√™n li·ªáu cho t·ª´ng m√≥n v√† l·∫≠p th·ª±c ƒë∆°n ng√†y ƒë·ªÉ t√≠nh to√°n. D·ªØ li·ªáu **ƒê·ªãnh M·ª©c Nguy√™n Li·ªáu** ƒë∆∞·ª£c ƒë·ªìng b·ªô qua ƒë√°m m√¢y.
        </p>

        <!-- KHU V·ª∞C 1: ƒê·ªäNH M·ª®C NGUY√äN LI·ªÜU (Norms) -->
        <div id="norms-section" class="bg-indigo-50 p-3 sm:p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-lg sm:text-xl font-semibold text-indigo-800 mb-4 flex justify-between items-center">
                ƒê·ªãnh M·ª©c Nguy√™n Li·ªáu
            </h2>

            <!-- N√öT M·ªöI: QU·∫¢N L√ù ƒê·ªäNH M·ª®C -->
            <button onclick="window.toggleNormsManagement(true)" id="manage-norms-btn" class="w-full bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition duration-150 mb-4 shadow-md flex items-center justify-center text-sm sm:text-base">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Qu·∫£n L√Ω ƒê·ªãnh M·ª©c M√≥n ƒÇn (Th√™m/S·ª≠a/X√≥a)
            </button>
            <!-- END N√öT QU·∫¢N L√ù -->

            <!-- Tr·∫°ng th√°i k·∫øt n·ªëi Firebase -->
            <div id="connection-status" class="text-center p-2 text-sm text-gray-600 italic">ƒêang k·∫øt n·ªëi...</div>

            <div id="norms-management-area" class="hidden p-3 sm:p-4 bg-white rounded-lg border-2 border-indigo-200">
                <!-- Select m√≥n ƒÉn ƒë·ªÉ ch·ªânh s·ª≠a -->
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Ch·ªçn M√≥n ƒÇn ƒë·ªÉ Ch·ªânh S·ª≠a ho·∫∑c Th√™m M√≥n M·ªõi:</h3>
                    
                    <div class="relative">
                        <input type="text" id="norm-dish-search" placeholder="T√¨m ki·∫øm m√≥n ƒÉn ƒë·ªÉ ch·ªânh s·ª≠a ho·∫∑c nh·∫≠p t√™n m·ªõi..." 
                            oninput="window.filterNormDishList(this.value)" 
                            onfocus="window.renderSearchableNormDishList()"
                            onblur="setTimeout(() => document.getElementById('norm-dish-options').classList.add('hidden'), 200)"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                        
                        <div id="norm-dish-options" 
                             class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg norm-select-container hidden text-sm">
                            <!-- Dish options for norm management -->
                        </div>
                    </div>
                </div>

                <!-- === TH√äM M·ªöI: C√ÅC N√öT EXPORT === -->
                <div class="my-4 p-3 bg-gray-50 rounded-lg border flex flex-col sm:flex-row gap-2 justify-center">
                    <button onclick="window.exportFullNorms()" class="text-xs sm:text-sm bg-green-100 text-green-700 hover:bg-green-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Xu·∫•t To√†n B·ªô ƒê·ªãnh M·ª©c (Excel)
                    </button>
                    <button onclick="window.exportDishList()" class="text-xs sm:text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        Xu·∫•t DS M√≥n ƒÇn (Excel)
                    </button>
                    <button onclick="window.exportIngredientList()" class="text-xs sm:text-sm bg-yellow-100 text-yellow-700 hover:bg-yellow-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        Xu·∫•t DS Nguy√™n Li·ªáu (Excel)
                    </button>
                </div>
                <!-- === K·∫æT TH√öC C√ÅC N√öT EXPORT === -->


                <!-- Form ch·ªânh s·ª≠a/th√™m m√≥n ƒÉn -->
                <div id="add-edit-form" class="space-y-3 p-3 bg-white rounded-lg border border-gray-200 hidden">
                    <h3 id="form-title" class="font-bold text-lg text-indigo-700">Ch·ªçn m√≥n ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªãnh m·ª©c</h3>
                    <!-- X√ìA B·ªé: Input hidden `current-norm-dish-name` ƒë√£ b·ªã x√≥a, ch√∫ng ta s·∫Ω ƒë·ªçc tr·ª±c ti·∫øp t·ª´ √¥ search -->
                    
                    <!-- V√πng nh·∫≠p nguy√™n li·ªáu -->
                    <div id="new-ingredient-inputs" class="space-y-4"></div>
                    
                    <button onclick="window.addIngredientInput()" class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 3h3m-3-3H9m-3-3h6a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2z"></path></svg>
                        Th√™m Nguy√™n Li·ªáu
                    </button>
                    
                    <!-- N√∫t L∆∞u / C·∫≠p Nh·∫≠t -->
                    <div id="form-action-buttons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 pt-2 border-t mt-3">
                        <button id="save-update-button" onclick="window.dbModule.saveNorms()" class="flex-grow bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition duration-150 text-sm">
                            L∆∞u / C·∫≠p Nh·∫≠t ƒê·ªãnh M·ª©c
                        </button>
                        <button onclick="window.deleteNorm(document.getElementById('norm-dish-search').value)" id="delete-norm-button" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition duration-150 text-sm w-full sm:w-28 hidden">
                            X√≥a M√≥n
                        </button>
                        <button onclick="window.toggleNormsManagement(false)" class="w-full sm:w-28 bg-gray-300 text-gray-700 p-2 rounded-md hover:bg-gray-400 transition duration-150 text-sm">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        <!-- END KHU V·ª∞C 1 -->


        <!-- KHU V·ª∞C 2: TH·ª∞C ƒê∆†N NG√ÄY (Daily Menu) -->
        <div id="daily-menu-section" class="bg-white p-3 sm:p-4 rounded-lg shadow-lg mb-8 border border-gray-200">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                <span class="flex items-center">üìã Th·ª±c ƒê∆°n Ng√†y</span>
                <!-- Th√™m input ch·ªçn ng√†y -->
                <input type="date" id="menu-date" 
                       onchange="window.renderResultsTitle()" 
                       class="p-2 border rounded-md text-sm focus:ring-green-500 focus:border-green-500 w-full sm:w-auto">
            </h2>
            
            <!-- Input ƒë·ªÉ th√™m m√≥n v√†o th·ª±c ƒë∆°n (Responsive layout) -->
            <div class="flex flex-col space-y-3 mb-4 no-print">
                <!-- KH·ªêI CH·ªåN M√ìN C√ì T√åM KI·∫æM -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative flex-grow">
                        <input type="text" id="dish-search-input" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." 
                               oninput="window.filterDishList(this.value)" 
                               onfocus="window.renderSearchableDishList()"
                               onblur="setTimeout(() => document.getElementById('dish-options-list').classList.add('hidden'), 200)"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white text-sm">
                        
                        <input type="hidden" id="menu-dish-select" value="">

                        <div id="dish-options-list" 
                             class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden text-sm">
                            <!-- Dish options will be rendered here by JS -->
                        </div>
                    </div>
                </div>
                <!-- END KH·ªêI CH·ªåN M√ìN C√ì T√åM KI·∫æM -->
                
                <!-- KH·ªêI NH·∫¨P S·ªê SU·∫§T V√Ä N√öT TH√äM -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center">
                    <div class="flex-grow w-full sm:w-auto flex items-center space-x-2">
                         <label class="text-sm font-medium text-gray-700 whitespace-nowrap hidden sm:block">S·ªë Su·∫•t:</label>
                        <input type="number" id="menu-servings-input" placeholder="S·ªë su·∫•t" value="1" min="1" class="w-full sm:w-28 p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 text-center text-sm">
                    </div>

                    <!-- N√öT G·ª¢I √ù NHANH -->
                    <div class="flex space-x-1 w-full sm:w-auto justify-end">
                        <button onclick="window.setServings(500)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">500</button>
                        <button onclick="window.setServings(1000)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">1000</button>
                        <button onclick="window.setServings(2000)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-300 transition duration-150">2000</button>
                    </div>
                    <!-- END N√öT G·ª¢I √ù NHANH -->

                    <button onclick="window.addDishToMenu()" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition duration-150 whitespace-nowrap text-sm w-full sm:w-auto">
                        Th√™m
                    </button>
                </div>
                <!-- END KH·ªêI NH·∫¨P S·ªê SU·∫§T V√Ä N√öT TH√äM -->
            </div>

            <!-- N√∫t ƒê·∫∑t l·∫°i v√† N√∫t Gemini -->
            <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center space-y-2 sm:space-y-0 mb-4 no-print">
                <!-- N√öT M·ªöI: G·ª¢I √ù TH·ª∞C ƒê∆†N -->
                <button onclick="window.generateMenuSuggestion()" id="generate-summary-btn" class="text-xs sm:text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <span class="mr-1">‚ú®</span> G·ª£i √Ω Th·ª±c ƒë∆°n
                </button>
                <!-- END N√öT M·ªöI -->

                <!-- === N√öT M·ªöI: IMPORT EXCEL === -->
                <label class="text-xs sm:text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto cursor-pointer">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Import Excel
                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls, .csv" onchange="window.handleFileUpload(event)">
                </label>
                <!-- === K·∫æT TH√öC N√öT M·ªöI === -->

                <!-- === TH√äM M·ªöI: N√öT XU·∫§T V√Ä IN TH·ª∞C ƒê∆†N === -->
                <button onclick="window.exportDailyMenu()" class="text-xs sm:text-sm bg-green-100 text-green-700 hover:bg-green-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Xu·∫•t Th·ª±c ƒê∆°n (Excel)
                </button>
                <button onclick="window.printDailyMenu()" class="text-xs sm:text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                </button>
                <!-- === K·∫æT TH√öC N√öT M·ªöI === -->


                <button onclick="window.resetDailyMenu()" class="text-xs sm:text-sm bg-red-100 text-red-700 hover:bg-red-200 p-2 rounded-md transition duration-150 flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20v-5m-5.074 8.751A8.001 8.001 0 0119.418 15m-15.356-2A8.001 8.001 0 0019.418 15m-15.356-2H4v5"></path></svg>
                    ƒê·∫∑t l·∫°i Th·ª±c ƒê∆°n
                </button>
            </div>
            <!-- K·∫øt th√∫c N√∫t ƒê·∫∑t l·∫°i v√† N√∫t Gemini -->


            <!-- B·∫£ng hi·ªÉn th·ªã th·ª±c ƒë∆°n (Table Responsive) -->
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M√≥n ƒÇn</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24 sm:w-28">S·ªë Su·∫•t</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="daily-menu-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Menu items are rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- KHU V·ª∞C 3: K·∫æT QU·∫¢ T√çNH TO√ÅN (Results) -->
        <div id="results-section" class="bg-yellow-50 p-3 sm:p-4 rounded-lg shadow-lg border border-yellow-300">
            <h2 class="text-lg sm:text-xl font-semibold text-yellow-800 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0" id="results-title-header">
                üõí T·ªïng Nguy√™n Li·ªáu C·∫ßn Thi·∫øt Cho Ng√†y
                <!-- N√∫t Export v√† N√∫t Gemini v√† N√∫t View Toggle -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto no-print">
                    <button onclick="window.toggleResultsView()" id="toggle-view-btn" class="bg-gray-200 text-gray-700 text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-gray-300 transition duration-150 shadow-md w-full sm:w-auto flex items-center justify-center">
                        <!-- Icon v√† Text s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
                    </button>
                    <button onclick="window.generateShoppingListNotes()" id="generate-notes-btn" class="bg-yellow-700 text-white text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-yellow-800 transition duration-150 shadow-md w-full sm:w-auto">
                        <span class="mr-1">‚ú®</span> G·ª£i √Ω Mua s·∫Øm
                    </button>
                    <!-- === CH·ªàNH S·ª¨A N√öT CSV TH√ÄNH EXCEL === -->
                    <button onclick="window.exportResultsToExcel()" class="bg-yellow-600 text-white text-xs sm:text-sm px-3 py-1 rounded-md hover:bg-yellow-700 transition duration-150 shadow-md w-full sm:w-auto">
                        Xu·∫•t T·ªïng NL (Excel)
                    </button>
                    <!-- === TH√äM M·ªöI: N√öT IN K·∫æT QU·∫¢ === -->
                    <button onclick="window.printResults()" class="bg-gray-100 text-gray-700 hover:bg-gray-200 text-xs sm:text-sm px-3 py-1 rounded-md transition duration-150 shadow-md w-full sm:w-auto flex items-center justify-center">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    </button>
                </div>
            </h2>
            
            <!-- B·∫£ng K·∫øt qu·∫£ (Table Responsive) -->
            <div id="results-table-view" class="table-responsive">
                <table class="min-w-full divide-y divide-yellow-300 rounded-lg overflow-hidden border border-yellow-300">
                    <thead class="bg-yellow-200">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Nguy√™n Li·ªáu</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-yellow-800 uppercase tracking-wider">T·ªïng S·ªë L∆∞·ª£ng (G·ªëc)</th>
                            <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-yellow-800 uppercase tracking-wider">Quy ƒê·ªïi</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Calculation results are rendered here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Danh s√°ch K·∫øt qu·∫£ (List/Card View cho Mobile) -->
            <div id="results-list-view" class="space-y-3 hidden">
                <!-- List items are rendered here -->
            </div>

        </div>

        <!-- Message Box for alerts -->
        <div id="message-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white hidden z-50 transition-opacity duration-300 text-sm"></div>

    </div>
    
    <!-- DI CHUY·ªÇN SCRIPT XU·ªêNG CU·ªêI BODY -->
    <script type="module">
        // Import c√°c h√†m b·∫°n c·∫ßn t·ª´ SDKs
        // (ƒê√£ ƒë∆∞·ª£c import v√† g√°n v√†o window trong th·∫ª script ·ªü <head>)
        
        // S·ª¨A L·ªñI: L·∫•y c√°c h√†m t·ª´ c√°c module ƒë√£ g√°n v√†o window
        const { initializeApp } = window.firebaseAppModule; 
        // S·ª¨A L·ªñI: L·∫•y th√™m h√†m signInWithCustomToken
        const { getAuth, signInAnonymously, signInWithCustomToken } = window.firebaseAuthModule;
        // S·ª¨A L·ªñI: ƒê·∫£m b·∫£o firebaseFirestoreModule ƒë√£ ƒë∆∞·ª£c g√°n (ƒë√£ s·ª≠a ·ªü head)
        // S·ª¨A L·ªñI: L·∫•y th√™m setLogLevel
        const { getFirestore, doc, onSnapshot, setDoc, enableNetwork, setLogLevel } = window.firebaseFirestoreModule;

        // --- C·∫§U H√åNH FIREBASE (L·∫§Y T·ª™ <HEAD>) ---
        // Bi·∫øn window.firebaseConfig ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o trong <head>
        // Bi·∫øn window.db v√† window.auth c≈©ng ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o trong <head>
        
        // B·∫≠t log chi ti·∫øt (h·ªØu √≠ch cho debug)
        setLogLevel('debug');
        
        // --- C∆† S·ªû D·ªÆ LI·ªÜU V√Ä ƒê·ªäNH NGHƒ®A ---
        
        // Danh s√°ch c√°c ƒë∆°n v·ªã t√≠nh ƒë∆∞·ª£c thi·∫øt l·∫≠p s·∫µn
        const UNITS = ['g', 'kg', 'ml', 'l', 'c√°i', 'qu·∫£', 'b√≥', 'lon', 'h·ªôp', 'th√¨a', 'mu·ªóng', 'ph·∫ßn', 'mi·∫øng', '(Kh√°c)'];
        
        // **S·ª¨A L·ªñI: ƒê·ªãnh nghƒ©a DEFAULT_NORMS TR∆Ø·ªöC khi s·ª≠ d·ª•ng**
        const DEFAULT_NORMS = {
            "G√† chi√™n s·ªët cay": { "Th·ªãt n·∫°c vai (g)": 200, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "Th·ªãt kho c·ªß c·∫£i": { "Th·ªãt n·∫°c vai (g)": 180, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "C·ªët l·∫øt ram m·∫∑n": { "C·ªët l·∫øt (g)": 200 },
            "Ch·∫£ c√° kho ti√™u": { "Ch·∫£ c√° (g)": 150 },
            "G√† chi√™n n∆∞·ªõc m·∫Øm": { "G√† t∆∞∆°i (g)": 200 },
            "Th·ªãt kho tr·ª©ng g√†": { "Th·ªãt n·∫°c vai (g)": 130, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "C√° phi l√™": { "C√° phi l√™ (g)": 130 },
            "G√† kho g·ª´ng": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn kho ti√™u": { "S∆∞·ªùn non (g)": 220 },
            "G√† kho s·∫£": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn s·ªët chua ng·ªçt": { "S∆∞·ªùn non (g)": 220 },
            "Th·ªãt kho ƒë·∫≠u h≈©": { "Th·ªãt n·∫°c vai (g)": 130, "ƒê·∫≠u h≈© chi√™n (g)": 100 },
            "Ch·∫£ c√° tr·ª©ng c√∫t": { "Ch·∫£ c√° b·ªçc tr·ª©ng c√∫t (g)": 125 },
            "ƒê√πi g√† chi√™n": { "ƒê√πi g√† (g)": 200 },
            "C·∫£i ng·ªçt x√†o": { "C·∫£i ng·ªçt (g)": 80 },
            "B·∫ßu x√†o": { "B·∫ßu (g)": 80 },
            "B·∫Øp c·∫£i x√†o": { "B·∫Øp c·∫£i tr√≤n (g)": 80 },
            "Rau mu·ªëng x√†o": { "Rau mu·ªëng (g)": 90 },
            "D∆∞a leo x√†o": { "D∆∞a leo (g)": 80 },
            "ƒê·∫≠u ƒë≈©a x√†o": { "ƒê·∫≠u ƒë≈©a (g)": 80 },
            "C·∫£i th√¨a x√†o": { "C·∫£i th√¨a (g)": 80 },
            "Su su, c√† r·ªët x√†o": { "Su su (g)": 80, "C√† r·ªët (g)": 10 },
            "Canh Rong bi·ªÉn": { "Rong bi·ªÉn kh√¥ (g)": 0.35 },
            "Canh B·∫Øp c·∫£i tr·∫Øng, c√† r·ªët": { "B·∫Øp c·∫£i tr·∫Øng (g)": 40, "C√† r·ªët (g)": 10 },
            "Canh b·∫ßu": { "B·∫ßu (g)": 55 },
            "Canh Soup": { "C·ªß c·∫£i tr·∫Øng (g)": 10, "C√† r·ªët (g)": 10, "C·ªß d·ªÅn (g)": 10, "Su su (g)": 10, "B·∫Øp c·∫£i tr·∫Øng (g)": 15 },
            "Canh Khoai M·ª°": { "Khoai m·ª° (g)": 55 },
            "Canh B√≠ xanh": { "B√≠ xanh (g)": 55 },
            "Canh C·∫£i th·∫£o": { "C·∫£i th·∫£o (g)": 50 },
            "Canh chua rau mu·ªëng": { "rau mu·ªëng (g)": 20, "c·ªß chua (g)": 5 },
            // Th√™m m√≥n m·ªõi t·ª´ h√¨nh ·∫£nh (ƒë√£ chu·∫©n h√≥a 'gam' -> 'g')
            "M√¨ tr·ªôn x√∫c x√≠ch": { "M√¨ Nissin (g)": 70, "X√∫c x√≠ch (g)": 50 },
            "M√¨ tr·ªôn tr·ª©ng, x√∫c x√≠ch": { "M√¨ Nissin (g)": 70, "X√∫c x√≠ch (g)": 50, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "M√¨ ph√¥ mai tr·ª©ng": { "M√¨ Nissin (g)": 70, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "G√† l·∫Øc": { "G√† vi√™n (g)": 110 },
            "B√°nh g√† ph√¥ mai": { "B√°nh g√† ph√¥ mai (g)": 180 },
            "B√°nh bao tr·ª©ng c√∫t": { "B√°nh bao tr·ª©ng c√∫t (g)": 62.5 },
            "B√°nh bao tr·ª©ng mu·ªëi": { "B√°nh bao tr·ª©ng mu·ªëi (g)": 100 },
            "B√°nh bao ng·ªçt": { "B√°nh bao ng·ªçt (g)": 40 },
            "C√° phi l√™ s·ªët chua ng·ªçt": { "C√° phi l√™ (g)": 130 },
            "Tr·ª©ng cu·ªôn ng≈© s·∫Øc": { "Tr·ª©ng g√† (qu·∫£)": 2, "C√† r·ªët (g)": 10, "ƒê·∫≠u ƒë≈©a (g)": 5, "Th·ªãt xay (g)": 30 },
            "G√† R√¥ti": { "ƒê√πi t·ªèi g√† (g)": 200 },
            "Ph·ªü g√†": { "B√°nh ph·ªü (g)": 200, "G√† phi l√™ (g)": 150, "gi√° (g)": 35, "C√† r·ªët (g)": 10, "C·ªß c·∫£i tr·∫Øng (g)": 10 }
        };

        // L·∫•y ƒë·ªãnh m·ª©c t·ª´ LocalStorage ho·∫∑c d√πng ƒë·ªãnh m·ª©c m·∫∑c ƒë·ªãnh n·∫øu LocalStorage tr·ªëng
        const storedNorms = localStorage.getItem('norms');
        // S·ª¨A L·ªñI: ƒê·∫£m b·∫£o DEFAULT_NORMS ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
        window.norms = storedNorms ? JSON.parse(storedNorms) : DEFAULT_NORMS; 

        // C·∫•u tr√∫c Th·ª±c ƒë∆°n (V·∫´n l∆∞u trong b·ªô nh·ªõ tr√¨nh duy·ªát cho phi√™n hi·ªán t·∫°i)
        let dailyMenu = JSON.parse(localStorage.getItem('dailyMenu')) || [];
        
        // Tr·∫°ng th√°i View cho b·∫£ng k·∫øt qu·∫£: 'table' (M·∫∑c ƒë·ªãnh) ho·∫∑c 'list'
        let resultsView = localStorage.getItem('resultsView') || 'table';

        // Bi·∫øn to√†n c·ª•c theo d√µi m√≥n ƒëang ch·ªânh s·ª≠a
        let editingDishName = null; 

        // --- C√ÄI ƒê·∫∂T GEMINI API ---
        const LLM_API_KEY = ""; // B·∫°n c·∫ßn ƒëi·ªÅn API Key c·ªßa m√¨nh v√†o ƒë√¢y n·∫øu mu·ªën d√πng Gemini
        const LLM_MODEL = "gemini-2.5-flash-preview-05-20";
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${LLM_API_KEY}`;
        
        // --- H√ÄM L∆ØU D·ªÆ LI·ªÜU (LOCALSTORAGE - D√πng khi Firestore l·ªói) ---
        function saveDataLocal() {
            localStorage.setItem('norms', JSON.stringify(window.norms));
            localStorage.setItem('dailyMenu', JSON.stringify(dailyMenu));
            localStorage.setItem('resultsView', resultsView);
        }

        // --- MODULE X·ª¨ L√ù DATABASE (FIRESTORE) ---
        window.dbModule = (function() {
            // S·ª¨A L·ªñI: S·ª≠ d·ª•ng __app_id t·ª´ bi·∫øn m√¥i tr∆∞·ªùng
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(window.db, "artifacts", appId, "public/data/norms/master_list");

            // 1. L∆∞u ƒê·ªãnh m·ª©c (Ghi l√™n Firestore)
            async function saveNorms() {
                // === THAY ƒê·ªîI LOGIC L·∫§Y T√äN ===
                // L·∫•y t√™n g·ªëc (l√∫c t·∫£i form) v√† t√™n m·ªõi (t·ª´ √¥ input)
                const oldName = editingDishName; 
                const newName = document.getElementById('norm-dish-search').value.trim();
                const isEditing = oldName !== null;
                const isRename = isEditing && oldName !== newName;
                // === K·∫æT TH√öC THAY ƒê·ªîI ===

                if (!newName) {
                    window.showMessage("L·ªói: Vui l√≤ng ch·ªçn m√≥n ƒÉn ho·∫∑c nh·∫≠p t√™n m√≥n m·ªõi tr∆∞·ªõc khi l∆∞u.", 'error');
                    return;
                }

                // Ki·ªÉm tra n·∫øu t·∫°o m·ªõi m√† b·ªã tr√πng
                if (!isEditing && newName in window.norms) {
                    window.showMessage(`M√≥n ƒÉn '${newName}' ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªânh s·ª≠a ho·∫∑c x√≥a m√≥n c≈©.`, 'error');
                    return;
                }

                // Ki·ªÉm tra n·∫øu ƒë·ªïi t√™n m√† b·ªã tr√πng
                if (isRename && newName in window.norms) {
                    window.showMessage(`L·ªói: T√™n m√≥n m·ªõi '${newName}' ƒë√£ t·ªìn t·∫°i. Kh√¥ng th·ªÉ ƒë·ªïi t√™n.`, 'error');
                    return;
                }

                const newNorm = {};
                let hasValidIngredient = false;

                const ingredientGroups = document.querySelectorAll('#new-ingredient-inputs .ingredient-group');

                ingredientGroups.forEach((group, index) => {
                    const nameInput = group.querySelector('.ingredient-name-input');
                    const unitSelect = group.querySelector('.ingredient-unit');
                    const customUnitInput = group.querySelector('.custom-unit-input');
                    const quantityInput = group.querySelector('.ingredient-quantity');

                    const ingredientName = nameInput.value.trim();
                    let unitValue = unitSelect.value;
                    const quantity = parseFloat(quantityInput.value);
                    
                    if (unitValue === '(Kh√°c)' && customUnitInput) {
                        const customUnit = customUnitInput.value.trim();
                        if (customUnit) {
                            unitValue = customUnit; // Ch·ªâ l·∫•y t√™n ƒë∆°n v·ªã
                        } else {
                            return; 
                        }
                    }

                    if (ingredientName && quantity >= 0 && unitValue) {
                        // S·ª¨A L·ªñI: ƒê·∫£m b·∫£o ƒë∆°n v·ªã lu√¥n c√≥ d·∫•u ngo·∫∑c
                        const fullIngredientName = `${ingredientName} (${unitValue})`; 
                        newNorm[fullIngredientName] = quantity;
                        if (quantity > 0) hasValidIngredient = true;
                    }
                });


                if (!hasValidIngredient) {
                    window.showMessage("M√≥n ƒÉn ph·∫£i c√≥ √≠t nh·∫•t m·ªôt nguy√™n li·ªáu v·ªõi ƒë·ªãnh m·ª©c > 0.", 'error');
                    return;
                }
                
                // C·∫≠p nh·∫≠t bi·∫øn global 'norms'
                // === THAY ƒê·ªîI LOGIC L∆ØU ===
                window.norms[newName] = newNorm; // Th√™m ho·∫∑c c·∫≠p nh·∫≠t t√™n m·ªõi
                if (isRename) {
                    delete window.norms[oldName]; // X√≥a t√™n c≈© n·∫øu l√† ƒë·ªïi t√™n
                }
                // === K·∫æT TH√öC THAY ƒê·ªîI ===
                
                // GHI L√äN FIRESTORE
                try {
                    // S·ª¨A L·ªñI: ƒê·∫£m b·∫£o window.norms kh√¥ng ph·∫£i l√† undefined (ƒë√£ s·ª≠a ·ªü ph·∫ßn ƒë·ªãnh nghƒ©a)
                    if (typeof window.norms === 'undefined') {
                        console.error("L·ªói nghi√™m tr·ªçng: window.norms l√† undefined tr∆∞·ªõc khi l∆∞u.");
                        window.norms = DEFAULT_NORMS; // Kh·ªüi t·∫°o l·∫°i
                    }
                    await setDoc(docRef, { norms: window.norms }, { merge: false }); // Ghi ƒë√® to√†n b·ªô (ƒë√£ bao g·ªìm x√≥a/ƒë·ªïi t√™n)
                    window.showMessage(`ƒê·ªãnh m·ª©c m√≥n '${newName}' ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T (Cloud) th√†nh c√¥ng!`);
                    
                    // === TH√äM M·ªöI: C·∫¨P NH·∫¨T DAILY MENU N·∫æU ƒê·ªîI T√äN ===
                    if (isRename) {
                        dailyMenu = dailyMenu.map(item => item.dish === oldName ? { ...item, dish: newName } : item);
                        saveDataLocal(); // C·∫≠p nh·∫≠t menu local
                        window.renderMenu(); // Render l·∫°i menu ngay l·∫≠p t·ª©c
                    }
                    // === K·∫æT TH√öC TH√äM M·ªöI ===

                    window.resetNormsForm(); 
                    window.renderAll(); // renderAll s·∫Ω t·ª± ƒë·ªông ch·∫°y v√¨ onSnapshot

                } catch (error) {
                    console.error("L·ªói khi l∆∞u Firestore: ", error);
                    window.showMessage(`L·ªói khi l∆∞u l√™n Cloud: ${error.message}`, 'error');
                    // N·∫øu l·ªói, l∆∞u t·∫°m local
                    saveDataLocal();
                }
            }

            // 2. T·∫£i ƒê·ªãnh m·ª©c (ƒê·ªçc t·ª´ Firestore)
            async function loadNorms() {
                const statusDiv = document.getElementById('connection-status');
                try {
                    // onSnapshot l·∫Øng nghe thay ƒë·ªïi theo th·ªùi gian th·ª±c
                    onSnapshot(docRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            if (data.norms && Object.keys(data.norms).length > 0) {
                                window.norms = data.norms;
                                statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi Firestore. D·ªØ li·ªáu ƒë·ªãnh m·ª©c ƒë∆∞·ª£c ƒë·ªìng b·ªô.';
                                statusDiv.className = 'text-center p-2 text-sm text-green-600 italic';
                                // Khi d·ªØ li·ªáu cloud thay ƒë·ªïi, render l·∫°i m·ªçi th·ª©
                                window.renderAll(); 
                            } else {
                                // N·∫øu t√†i li·ªáu t·ªìn t·∫°i nh∆∞ng kh√¥ng c√≥ norms, th·ª≠ l∆∞u DEFAULT_NORMS
                                console.log("T√†i li·ªáu Firestore tr·ªëng. ƒêang th·ª≠ l∆∞u ƒë·ªãnh m·ª©c m·∫∑c ƒë·ªãnh...");
                                setDoc(docRef, { norms: DEFAULT_NORMS }, { merge: false });
                                window.norms = DEFAULT_NORMS;
                            }
                        } else {
                            // T√†i li·ªáu ch∆∞a t·ªìn t·∫°i, t·∫°o m·ªõi
                            console.log("Kh√¥ng t√¨m th·∫•y t√†i li·ªáu. ƒêang t·∫°o m·ªõi v·ªõi ƒë·ªãnh m·ª©c m·∫∑c ƒë·ªãnh...");
                            setDoc(docRef, { norms: DEFAULT_NORMS }, { merge: false });
                            window.norms = DEFAULT_NORMS;
                        }
                    });

                } catch (error) {
                    console.error("L·ªói khi t·∫£i Firestore: ", error);
                    // S·ª¨A L·ªñI: Ki·ªÉm tra statusDiv tr∆∞·ªõc khi g√°n
                    if (statusDiv) {
                        statusDiv.textContent = `L·ªói k·∫øt n·ªëi Firestore. ƒêang d√πng d·ªØ li·ªáu c·ª•c b·ªô (Offline). ${error.message}`;
                        statusDiv.className = 'text-center p-2 text-sm text-red-600 italic';
                    }
                    // T·∫£i d·ªØ li·ªáu c·ª•c b·ªô n·∫øu kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
                    window.norms = JSON.parse(localStorage.getItem('norms')) || DEFAULT_NORMS;
                    window.renderAll();
                }
            }

            return {
                saveNorms,
                loadNorms
            };
        })();

        // --- KH·ªûI T·∫†O ƒê·ªíNG B·ªò D·ªÆ LI·ªÜU ---
        async function initializeDataSync() {
            const statusDiv = document.getElementById('connection-status');
            try {
                // S·ª¨A L·ªñI: S·ª≠ d·ª•ng token_auth ho·∫∑c signInAnonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("ƒêƒÉng nh·∫≠p b·∫±ng Custom Token th√†nh c√¥ng.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("ƒêƒÉng nh·∫≠p ·∫©n danh th√†nh c√¥ng.");
                }
                
                // B·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu t·ª´ Firestore
                await window.dbModule.loadNorms();

            } catch (error) {
                console.error("L·ªói x√°c th·ª±c Firebase: ", error);
                let userMessage = `L·ªói x√°c th·ª±c. ƒêang d√πng d·ªØ li·ªáu Offline. (${error.message})`;
                
                // S·ª¨A L·ªñI: Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n r√µ r√†ng cho l·ªói ph·ªï bi·∫øn
                if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                    userMessage = "L·ªñI K·∫æT N·ªêI: ƒêƒÉng nh·∫≠p ·∫®n danh (Anonymous Auth) CH∆ØA ƒê∆Ø·ª¢C B·∫¨T. Vui l√≤ng b·∫≠t trong Firebase Console -> Authentication -> Sign-in method.";
                }
                
                // S·ª¨A L·ªñI: Ki·ªÉm tra statusDiv tr∆∞·ªõc khi g√°n
                if (statusDiv) {
                    statusDiv.textContent = userMessage;
                    statusDiv.className = 'text-center p-2 text-sm text-red-600 italic';
                }
                
                // N·∫øu x√°c th·ª±c l·ªói, d√πng LocalStorage
                window.norms = JSON.parse(localStorage.getItem('norms')) || DEFAULT_NORMS;
                window.renderAll();
            }
        }


        // === B·ªî SUNG C√ÅC H√ÄM TI·ªÜN √çCH B·ªä THI·∫æU ===

        // --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO V√Ä MODAL ---
        
        window.showMessage = function(message, type = 'success') {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white z-50 opacity-0 ${bgColor} text-sm`;
            box.textContent = message;
            box.classList.remove('hidden');
            
            setTimeout(() => {
                box.style.opacity = '1';
            }, 50);

            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        window.showLLMModal = function(title, content) {
            const modal = document.getElementById('llm-modal');
            document.getElementById('llm-modal-title').textContent = title;
            document.getElementById('llm-modal-content').innerHTML = content.replace(/\n/g, '<br>'); // Convert newlines to <br>
            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').classList.add('scale-100');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        // --- H√ÄM CHUNG X·ª¨ L√ù GEMINI API ---

        async function fetchLLMResponse(prompt, systemInstruction, buttonId) {
            const button = document.getElementById(buttonId);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'ƒêang t·∫°o...';

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            const maxRetries = 5;
            let lastResult = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            lastResult = text;
                            break; 
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Gemini API error:", error);
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            button.disabled = false;
            button.innerHTML = originalText;
            
            if (!lastResult && LLM_API_KEY) { // Ch·ªâ b√°o l·ªói n·∫øu API key ƒë∆∞·ª£c cung c·∫•p
                 window.showMessage("L·ªói: Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Gemini. Vui l√≤ng th·ª≠ l·∫°i sau.", 'error');
            } else if (!LLM_API_KEY) {
                window.showMessage("T√≠nh nƒÉng AI c·∫ßn API Key trong m√£ ngu·ªìn ƒë·ªÉ ho·∫°t ƒë·ªông.", 'warning');
            }

            return lastResult;
        }

        // --- T√çNH NƒÇNG GEMINI C·ª§ TH·ªÇ ---

        window.generateMenuSuggestion = async function() {
            if (Object.keys(window.norms).length === 0) {
                window.showMessage("Kh√¥ng c√≥ ƒë·ªãnh m·ª©c m√≥n ƒÉn n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng th√™m ƒë·ªãnh m·ª©c tr∆∞·ªõc.", 'error');
                return;
            }

            const availableDishes = Object.keys(window.norms).map(dishName => {
                const normsForDish = window.norms[dishName];
                const [mainIngredientKey] = Object.entries(normsForDish)[0] || [""];
                const { name: mainIngredient } = window.parseIngredientKey(mainIngredientKey);
                return `${dishName} (Ch√≠nh: ${mainIngredient})`;
            }).join('\n');
            
            const prompt = `T·ª´ danh s√°ch c√°c m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh sau, h√£y ƒë·ªÅ xu·∫•t m·ªôt th·ª±c ƒë∆°n ho√†n ch·ªânh cho m·ªôt ng√†y (g·ªìm 3-4 m√≥n: 1 M√≥n ch√≠nh, 1 M√≥n ph·ª•, 1 Canh) cho su·∫•t ƒÉn b√°n tr√∫, ƒë·∫£m b·∫£o c√°c ti√™u ch√≠:
            1) T·ªëi ∆∞u h√≥a vi·ªác s·ª≠ d·ª•ng nguy√™n li·ªáu (nguy√™n li·ªáu ch√≠nh n√™n kh√°c nhau).
            2) Kh√¥ng ƒë·ªÉ tr√πng l·∫∑p nguy√™n li·ªáu ch√≠nh (Th·ªãt n·∫°c vai, Th·ªãt g√†/ƒë√πi g√†, S∆∞·ªùn non, C√° phi l√™, Ch·∫£ c√°, Tr·ª©ng, ƒê·∫≠u) trong 2 m√≥n ƒë∆∞·ª£c ch·ªçn.
            3) Ph·∫£i l√† c√°c m√≥n c√≥ trong danh s√°ch.
            
            K·∫øt qu·∫£ ch·ªâ ƒë∆∞·ª£c li·ªát k√™ T√™n M√≥n ƒÇn ƒë√£ ch·ªçn, m·ªói m√≥n m·ªôt d√≤ng, kh√¥ng th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát, kh√¥ng gi·∫£i th√≠ch.

            Danh s√°ch m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh:\n${availableDishes}`;
            
            const systemInstruction = "B·∫°n l√† chuy√™n gia dinh d∆∞·ª°ng v√† qu·∫£n l√Ω b·∫øp ƒÉn tr∆∞·ªùng h·ªçc. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë∆∞a ra m·ªôt th·ª±c ƒë∆°n c√¢n b·∫±ng, ngon mi·ªáng, v√† tu√¢n th·ªß ch·∫∑t ch·∫Ω c√°c quy t·∫Øc v·ªÅ t·ªëi ∆∞u h√≥a nguy√™n li·ªáu v√† kh√¥ng tr√πng l·∫∑p ngu·ªìn protein ch√≠nh. K·∫øt qu·∫£ ph·∫£i l√† m·ªôt danh s√°ch c√°c m√≥n ƒÉn b·∫±ng ti·∫øng Vi·ªát, ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng r√µ r√†ng, ph√π h·ª£p ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ sao ch√©p v√† l·∫≠p th·ª±c ƒë∆°n.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-summary-btn');

            if (result) {
                window.showLLMModal("‚ú® G·ª£i √ù Th·ª±c ƒê∆°n T·ªëi ∆Øu", result);
            }
        }

        window.generateShoppingListNotes = async function() {
            if (dailyMenu.length === 0) {
                window.showMessage("Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n tr∆∞·ªõc khi s·ª≠ d·ª•ng t√≠nh nƒÉng Gemini.", 'error');
                return null;
            }

            const results = window.calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o trong danh s√°ch t·ªïng. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            const shoppingList = Object.entries(results).map(([ingKey, qty]) => {
                const { name: ingredientName, unit } = window.parseIngredientKey(ingKey);
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, qty);
                const displayQty = convertedUnit !== unit ? convertedQuantity.toFixed(2) : qty;
                const displayUnit = convertedUnit !== unit ? convertedUnit : unit;
                return `${ingredientName}: ${displayQty} ${displayUnit}`;
            }).join('\n');


            const prompt = `Ph√¢n t√≠ch danh s√°ch mua s·∫Øm n√†y v√† ƒë∆∞a ra 3 l·ªùi khuy√™n ng·∫Øn g·ªçn, quan tr·ªçng cho vi·ªác mua s·∫Øm s·ªë l∆∞·ª£ng l·ªõn (V√≠ d·ª•: ∆∞u ti√™n h√†ng t∆∞∆°i, ki·ªÉm tra ch·∫•t l∆∞·ª£ng, mua s·ªâ).\n\nDanh s√°ch mua s·∫Øm:\n${shoppingList}`;
            const systemInstruction = "B·∫°n l√† m·ªôt qu·∫£n l√Ω kho v√† b·∫øp chuy√™n nghi·ªáp. H√£y ƒë∆∞a ra 3 ghi ch√∫/l·ªùi khuy√™n quan tr·ªçng nh·∫•t (theo th·ª© t·ª± ∆∞u ti√™n 1, 2, 3) cho ng∆∞·ªùi ƒëi mua s·∫Øm d·ª±a tr√™n danh s√°ch nguy√™n li·ªáu ƒë√£ cung c·∫•p. Vi·∫øt b·∫±ng ti·∫øng Vi·ªát, t·∫≠p trung v√†o t√≠nh th·ª±c t·∫ø v√† hi·ªáu qu·∫£ mua h√†ng.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-notes-btn');

            if (result) {
                window.showLLMModal("‚ú® G·ª£i √ù Mua S·∫Øm Hi·ªáu Qu·∫£", result);
            }
        }


        // --- LOGIC ·∫®N/HI·ªÜN KHU V·ª∞C ƒê·ªäNH M·ª®C ---
        
        window.toggleNormsManagement = function(shouldOpen) {
            const area = document.getElementById('norms-management-area');
            const button = document.getElementById('manage-norms-btn');

            if (shouldOpen) {
                area.classList.remove('hidden');
                button.classList.add('hidden');
                window.resetNormsForm(); 
            } else {
                area.classList.add('hidden');
                button.classList.remove('hidden');
            }
        }
        
        window.parseIngredientKey = function(key) {
            const match = key.match(/(.*)\s*\(([^\)]+)\)$/); // ƒê√£ s·ª≠a: Th√™m + sau [^\)]
            if (match) {
                return { name: match[1].trim(), unit: match[2].trim() }; // ƒê√£ s·ª≠a: match[2] v√† .trim()
            }
            // Fallback n·∫øu kh√¥ng c√≥ d·∫•u ngo·∫∑c
            return { name: key.trim(), unit: 'g' }; // M·∫∑c ƒë·ªãnh l√† 'g' n·∫øu kh√¥ng t√¨m th·∫•y
        }

        // --- LOGIC X·ª¨ L√ù DATE V√Ä EXPORT ---
        
        function getVietnameseDayOfWeek(date) {
            const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
            return days[date.getDay()];
        }

        function initializeDate() {
            const dateInput = document.getElementById('menu-date');
            if (dateInput) { // S·ª¨A L·ªñI: Ch·ªâ g√°n n·∫øu DOM ƒë√£ t·∫£i
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                window.renderResultsTitle(); // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ l·∫ßn ƒë·∫ßu
            }
        }
        
        window.renderResultsTitle = function() {
            const dateInput = document.getElementById('menu-date');
            const titleHeader = document.getElementById('results-title-header');
            
            // S·ª¨A L·ªñI: Ki·ªÉm tra c·∫£ hai ph·∫ßn t·ª≠ tr∆∞·ªõc khi thao t√°c
            if (!dateInput || !titleHeader) return; 

            const menuDateValue = dateInput.value;
            let dateString = '';

            if (menuDateValue) {
                const [year, month, day] = menuDateValue.split('-');
                const dateObj = new Date(menuDateValue.replace(/-/g, '/')); 
                const dayOfWeek = getVietnameseDayOfWeek(dateObj);
                dateString = `${dayOfWeek}, Ng√†y ${day}/${month}/${year}`;
            }
            
            const exportButtonHtml = titleHeader.querySelector('div').outerHTML; 
            
            titleHeader.innerHTML = `
                üõí T·ªïng Nguy√™n Li·ªáu C·∫ßn Thi·∫øt <span class="text-indigo-700">${dateString}</span>
                ${exportButtonHtml}
            `;
        }
        
        window.toggleResultsView = function() {
            resultsView = resultsView === 'table' ? 'list' : 'table';
            saveDataLocal(); // L∆∞u c√†i ƒë·∫∑t view c·ª•c b·ªô
            window.renderResults(); 
        }

        function updateViewToggleButton() {
            const btn = document.getElementById('toggle-view-btn');
            if (!btn) return;
            
            const isTableView = resultsView === 'table';

            if (isTableView) {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    D·∫°ng Danh s√°ch
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng danh s√°ch (t·ªëi ∆∞u mobile)";
            } else {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-3-8l-3 4m6-4l3 4"></path></svg>
                    D·∫°ng B·∫£ng
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng b·∫£ng (chi ti·∫øt)";
            }
        }

        // === K·∫æT TH√öC B·ªî SUNG ===


        // === THAY ƒê·ªîI: T·ª™ CSV SANG EXCEL ===
        window.exportResultsToExcel = function() {
            const dateInput = document.getElementById('menu-date');
            const menuDate = dateInput.value || new Date().toISOString().split('T')[0]; 
            const results = window.calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë·ªÉ xu·∫•t. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            const dataToExport = [];
            const ingredientsArray = Object.entries(results).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                const { name: ingredientName, unit } = window.parseIngredientKey(ingredientWithUnit);
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, quantity);
                
                dataToExport.push({
                    "Nguy√™n Li·ªáu": ingredientName,
                    "S·ªë L∆∞·ª£ng (G·ªëc)": quantity,
                    "ƒê∆°n V·ªã (G·ªëc)": unit,
                    "S·ªë L∆∞·ª£ng (Quy ƒê·ªïi)": convertedQuantity,
                    "ƒê∆°n V·ªã (Quy ƒê·ªïi)": convertedUnit
                });
            });

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt
            ws['!cols'] = [ { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Tong Nguyen Lieu ${menuDate}`);
            
            // Ghi file
            XLSX.writeFile(wb, `Tong_Nguyen_Lieu_${menuDate}.xlsx`);
            window.showMessage(`ƒê√£ xu·∫•t file Tong_Nguyen_Lieu_${menuDate}.xlsx th√†nh c√¥ng!`);
        }


        // --- LOGIC X·ª¨ L√ù ƒê·ªäNH M·ª®C NGUY√äN LI·ªÜU (NORMS) ---

        // T·∫°o danh s√°ch t√™n nguy√™n li·ªáu ƒë·ªôc nh·∫•t (cho t√≠nh nƒÉng g·ª£i √Ω)
        function getUniqueIngredientNames() {
            const nameSet = new Set();
            Object.values(window.norms).forEach(dishNorms => {
                Object.keys(dishNorms).forEach(key => {
                    const { name } = window.parseIngredientKey(key);
                    nameSet.add(name);
                });
            });
            return Array.from(nameSet).sort((a, b) => a.localeCompare(b, 'vi'));
        }

        window.resetNormsForm = function() {
            editingDishName = null;
            document.getElementById('norm-dish-search').value = '';
            document.getElementById('form-title').textContent = 'Ch·ªçn m√≥n ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªãnh m·ª©c';
            // X√ìA: D√≤ng 'current-norm-dish-name' ƒë√£ b·ªã x√≥a
            document.getElementById('new-ingredient-inputs').innerHTML = '';
            document.getElementById('add-edit-form').classList.add('hidden');
        }

        window.loadNormsForm = function(dishName) {
            document.getElementById('add-edit-form').classList.remove('hidden');
            // X√ìA: D√≤ng 'current-norm-dish-name' ƒë√£ b·ªã x√≥a
            document.getElementById('new-ingredient-inputs').innerHTML = '';

            const normData = window.norms[dishName];
            
            if (normData) {
                editingDishName = dishName; // L∆ØU T√äN G·ªêC
                document.getElementById('form-title').textContent = `Ch·ªânh S·ª≠a ƒê·ªãnh M·ª©c: ${dishName}`;
                Object.entries(normData).forEach(([key, quantity]) => {
                    window.addIngredientInput(key, quantity);
                });
                document.getElementById('delete-norm-button').classList.remove('hidden');
            } else {
                editingDishName = null; // ƒê√ÇY L√Ä M√ìN M·ªöI
                document.getElementById('form-title').textContent = `Th√™m M√≥n M·ªõi: ${dishName}`;
                window.addIngredientInput(); 
                document.getElementById('delete-norm-button').classList.add('hidden');
            }
        }
        
        // (saveDishNorm ƒë√£ ƒë∆∞·ª£c chuy·ªÉn v√†o dbModule)

        window.handleUnitChange = function(selectElement) {
            // T√¨m container cha g·∫ßn nh·∫•t
            const parentGroup = selectElement.closest('.ingredient-group');
            const customInputDiv = parentGroup.querySelector('.custom-unit-container');

            if (selectElement.value === '(Kh√°c)') {
                customInputDiv.classList.remove('hidden');
                customInputDiv.querySelector('.custom-unit-input').value = ''; // X√≥a gi√° tr·ªã c≈©
            } else {
                customInputDiv.classList.add('hidden');
            }
        }

        // T√çNH NƒÇNG M·ªöI: G·ª£i √Ω Nguy√™n li·ªáu
        // C√°c bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω dropdown nguy√™n li·ªáu
        let uniqueIngredients = []; 
        let currentIngredientInput = null;

        // C·∫≠p nh·∫≠t danh s√°ch nguy√™n li·ªáu g·ª£i √Ω
        function updateUniqueIngredients() {
            uniqueIngredients = getUniqueIngredientNames();
        }

        // Hi·ªÉn th·ªã g·ª£i √Ω
        window.filterIngredientList = function(inputElement) {
            currentIngredientInput = inputElement;
            const listContainer = inputElement.nextElementSibling; // Dropdown
            const searchTerm = inputElement.value;
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            
            listContainer.innerHTML = '';
            let found = false;
            
            uniqueIngredients.forEach(name => {
                if (window.removeVietnameseDiacritics(name).includes(normalizedTerm)) {
                    const itemDiv = document.createElement('div');
                    itemDiv.textContent = name;
                    itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 text-sm';
                    itemDiv.onmousedown = () => window.selectIngredient(name);
                    listContainer.appendChild(itemDiv);
                    found = true;
                }
            });

            // T√πy ch·ªçn Th√™m m·ªõi
            if (searchTerm && !found) {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = `Th√™m m·ªõi "${searchTerm}"`;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-green-100 transition duration-100 text-sm italic text-gray-500';
                itemDiv.onmousedown = () => window.selectIngredient(searchTerm);
                listContainer.appendChild(itemDiv);
            }
            
            listContainer.classList.remove('hidden');
        }

        // Ch·ªçn m·ªôt nguy√™n li·ªáu
        window.selectIngredient = function(name) {
            if (currentIngredientInput) {
                currentIngredientInput.value = name;
                currentIngredientInput.nextElementSibling.classList.add('hidden');
            }
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        function setupIngredientInputBlur() {
            // H√†m n√†y c·∫ßn ƒë∆∞·ª£c g·ªçi khi addIngredientInput
            if (currentIngredientInput) {
                setTimeout(() => {
                    currentIngredientInput.nextElementSibling.classList.add('hidden');
                }, 200);
            }
        }


        window.addIngredientInput = function(key = '', quantity = '') {
            const container = document.getElementById('new-ingredient-inputs');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 ingredient-group relative'; // Th√™m relative
            
            const { name: ingredientName, unit: ingredientUnit } = window.parseIngredientKey(key);
            
            // S·ª≠a logic: ƒë·∫£m b·∫£o (g) l√† 'g' ch·ª© kh√¥ng ph·∫£i 'g)'
            const selectedUnit = ingredientUnit; 
            const isCustomUnit = !UNITS.includes(selectedUnit) && selectedUnit !== '';
            
            // HTML cho input t√™n nguy√™n li·ªáu v·ªõi dropdown
            const ingredientInputHTML = `
                <div class="relative flex-grow">
                    <input type="text" placeholder="T√™n Nguy√™n li·ªáu" value="${ingredientName}" 
                           class="ingredient-name-input w-full p-2 border rounded-md text-sm"
                           oninput="window.filterIngredientList(this)"
                           onfocus="window.updateUniqueIngredients(); window.filterIngredientList(this)"
                           onblur="setTimeout(() => this.nextElementSibling.classList.add('hidden'), 200)">
                    <div class="ingredient-select-container absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden">
                        <!-- G·ª£i √Ω nguy√™n li·ªáu s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </div>
                </div>
            `;
            
            inputGroup.innerHTML = `
                ${ingredientInputHTML}
                
                <div class="flex flex-col space-y-2 sm:space-y-0 w-full sm:w-48">
                    <select onchange="window.handleUnitChange(this)" class="p-2 border rounded-md ingredient-unit focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                        ${UNITS.map(unit => 
                            `<option value="${unit}" ${!isCustomUnit && unit === selectedUnit ? 'selected' : (isCustomUnit && unit === '(Kh√°c)' ? 'selected' : '')}>${unit.replace(/[()]/g, '')}</option>`
                        ).join('')}
                    </select>
                    
                    <div class="custom-unit-container ${isCustomUnit ? 'block' : 'hidden'} mt-1 pt-1">
                        <input type="text" placeholder="Nh·∫≠p ƒê∆°n v·ªã" value="${isCustomUnit ? selectedUnit : ''}" class="custom-unit-input p-2 border rounded-md w-full text-xs">
                    </div>
                </div>

                <div class="flex space-x-2 w-full sm:w-auto">
                    <input type="number" placeholder="ƒê·ªãnh m·ª©c (1 su·∫•t)" value="${quantity}" min="0" class="w-full sm:w-28 p-2 border rounded-md ingredient-quantity text-right text-sm">
                    <button type="button" onclick="this.closest('.ingredient-group').remove();" class="text-red-500 hover:text-red-700 p-2 rounded-full" title="X√≥a nguy√™n li·ªáu n√†y">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            container.appendChild(inputGroup);
        }

        window.deleteNorm = async function(dish) {
            if (!dish || !(dish in window.norms)) {
                 window.showMessage("M√≥n ƒÉn kh√¥ng t·ªìn t·∫°i trong ƒë·ªãnh m·ª©c.", 'error');
                 return;
            }
            
            delete window.norms[dish];
            
            // GHI L√äN FIRESTORE
            try {
                // Ch√∫ng ta c·∫ßn ghi ƒë√® to√†n b·ªô (kh√¥ng merge) ƒë·ªÉ x√≥a m√≥n ƒÉn
                await window.dbModule.saveNormsAfterDelete(window.norms); 
                window.showMessage(`ƒê·ªãnh m·ª©c m√≥n '${dish}' ƒë√£ ƒë∆∞·ª£c x√≥a (Cloud).`);
            } catch (error) {
                console.error("L·ªói khi x√≥a tr√™n Firestore: ", error);
                window.showMessage(`L·ªói khi x√≥a tr√™n Cloud: ${error.message}`, 'error');
                saveDataLocal(); // L∆∞u t·∫°m local n·∫øu l·ªói
            }

            dailyMenu = dailyMenu.filter(item => item.dish !== dish);
            saveDataLocal(); // L∆∞u l·∫°i dailyMenu (v·∫´n l√† local)
            
            window.resetNormsForm();
            window.toggleNormsManagement(false);
            window.renderAll(); // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi onSnapshot
        }
        
        // H√†m m·ªõi ƒë·ªÉ h·ªó tr·ª£ x√≥a (ghi ƒë√® to√†n b·ªô)
        window.dbModule.saveNormsAfterDelete = async function(updatedNorms) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
            const docRef = doc(window.db, "artifacts", appId, "public/data/norms/master_list");
            await setDoc(docRef, { norms: updatedNorms }, { merge: false }); // merge: false = ghi ƒë√®
        }
        
        window.renderSearchableNormDishList = function() {
            const listContainer = document.getElementById('norm-dish-options');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; 
            
            const dishNames = Object.keys(window.norms).sort((a,b) => a.localeCompare(b, 'vi'));

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ch∆∞a c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectNormDish(dish); 
                listContainer.appendChild(itemDiv);
            });
        }

        window.filterNormDishList = function(searchTerm) {
            const listContainer = document.getElementById('norm-dish-options');
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            if (listContainer.children.length === 0 && Object.keys(window.norms).length > 0) {
                 window.renderSearchableNormDishList();
            }

            listContainer.innerHTML = ''; 

            if (normalizedTerm.length === 0) {
                if (Object.keys(window.norms).length > 0) window.renderSearchableNormDishList();
                listContainer.classList.remove('hidden');
                window.resetNormsForm(); 
                return;
            }
            
            const dishNames = Object.keys(window.norms).sort((a,b) => a.localeCompare(b, 'vi'));
            let matchedDishes = [];

            dishNames.forEach(dish => {
                const normalizedDishName = window.removeVietnameseDiacritics(dish);
                if (normalizedDishName.includes(normalizedTerm)) {
                    matchedDishes.push(dish);
                }
            });

            matchedDishes.forEach(dish => {
                 const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectNormDish(dish);
                listContainer.appendChild(itemDiv);
                foundCount++;
            });

            if (foundCount === 0) {
                const newDishName = searchTerm.trim();
                if (newDishName) { // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ g√µ t√™n m·ªõi
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                    msgDiv.textContent = `Kh√¥ng t√¨m th·∫•y. Nh·∫•n ƒë·ªÉ Th√™m m√≥n "${newDishName}"`;
                    msgDiv.classList.add('cursor-pointer', 'hover:bg-green-100');
                    msgDiv.onmousedown = () => window.selectNormDish(newDishName, true);
                    listContainer.appendChild(msgDiv);
                }
            }
            listContainer.classList.remove('hidden');
        }
        
        window.selectNormDish = function(dishName, isNew = false) {
            document.getElementById('norm-dish-search').value = dishName;
            document.getElementById('norm-dish-options').classList.add('hidden'); 
            window.loadNormsForm(dishName); // T√™n g·ªëc (editingDishName) ƒë∆∞·ª£c set ·ªü ƒë√¢y
        }
        
        // --- LOGIC T√åM KI·∫æM V√Ä CH·ªåN M√ìN ƒÇN TRONG TH·ª∞C ƒê∆†N ---
        
        // === B·ªî SUNG C√ÅC H√ÄM B·ªä THI·∫æU ===

        window.renderSearchableDishList = function() {
            const listContainer = document.getElementById('dish-options-list');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; 
            
            const dishNames = Object.keys(window.norms).sort((a,b) => a.localeCompare(b, 'vi'));

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectDish(dish); 
                listContainer.appendChild(itemDiv);
            });
        }
        
        window.filterDishList = function(searchTerm) {
            const listContainer = document.getElementById('dish-options-list');
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            if (listContainer.children.length === 0) {
                 window.renderSearchableDishList();
            }

            document.getElementById('menu-dish-select').value = ''; 
            listContainer.innerHTML = ''; 

            if (normalizedTerm.length === 0) {
                window.renderSearchableDishList();
                listContainer.classList.remove('hidden');
            } else {
                const dishNames = Object.keys(window.norms).sort((a,b) => a.localeCompare(b, 'vi'));

                dishNames.forEach(dish => {
                    const normalizedDishName = window.removeVietnameseDiacritics(dish);

                    if (normalizedDishName.includes(normalizedTerm)) {
                        const itemDiv = document.createElement('div');
                        itemDiv.textContent = dish;
                        itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                        itemDiv.setAttribute('data-dish-name', dish);
                        itemDiv.onmousedown = () => window.selectDish(dish);
                        listContainer.appendChild(itemDiv);
                        foundCount++;
                    }
                });

                if (foundCount === 0) {
                    const msgDiv = document.createElement('div');
                    msgDiv.id = 'dish-not-found-msg';
                    msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                    msgDiv.textContent = 'Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn ph√π h·ª£p.';
                    listContainer.appendChild(msgDiv);
                }
                listContainer.classList.remove('hidden');
            }
        }
        
        window.selectDish = function(dishName) {
            document.getElementById('dish-search-input').value = dishName;
            document.getElementById('menu-dish-select').value = dishName;
            document.getElementById('dish-options-list').classList.add('hidden'); 
        }

        // --- LOGIC X·ª¨ L√ù TH·ª∞C ƒê∆†N NG√ÄY (DAILY MENU) ---
        
        window.setServings = function(quantity) {
             document.getElementById('menu-servings-input').value = quantity;
        }


        window.addDishToMenu = function() {
            const dishSelect = document.getElementById('menu-dish-select');
            const servingsInput = document.getElementById('menu-servings-input');
            
            const dish = dishSelect.value;
            const servings = parseInt(servingsInput.value);

            if (!dish || !(dish in window.norms)) {
                window.showMessage("Vui l√≤ng ch·ªçn m·ªôt m√≥n ƒÉn h·ª£p l·ªá t·ª´ danh s√°ch.", 'error');
                return;
            }
            if (isNaN(servings) || servings <= 0) {
                window.showMessage("S·ªë su·∫•t ƒÉn ph·∫£i l√† s·ªë d∆∞∆°ng.", 'error');
                return;
            }

            const existingItem = dailyMenu.find(item => item.dish === dish);
            if (existingItem) {
                existingItem.servings += servings;
            } else {
                dailyMenu.push({ dish, servings });
            }

            saveDataLocal(); // L∆∞u th·ª±c ƒë∆°n (lu√¥n l√† local)
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage(`ƒê√£ th√™m ${servings} su·∫•t '${dish}' v√†o th·ª±c ƒë∆°n.`);
            
            document.getElementById('dish-search-input').value = ''; 
            dishSelect.value = '';
            servingsInput.value = 1;
        }

        window.deleteDishFromMenu = function(index) {
            dailyMenu.splice(index, 1);
            saveDataLocal();
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage("M√≥n ƒÉn ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi th·ª±c ƒë∆°n.", 'warning');
        }

        window.resetDailyMenu = function() {
            dailyMenu = [];
            saveDataLocal();
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage("Th·ª±c ƒë∆°n ng√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng.", 'warning');
        }

        window.updateServings = function(index, value) {
            const servings = parseInt(value);
             if (isNaN(servings) || servings <= 0) {
                window.showMessage("S·ªë su·∫•t kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë su·∫•t l·ªõn h∆°n 0.", 'warning');
                if (servings <= 0) {
                    window.deleteDishFromMenu(index);
                } else {
                    window.renderMenu(); 
                }
                return;
            }
            
            dailyMenu[index].servings = servings;
            saveDataLocal();
            window.calculateAndRenderResults();
        }

        // === H√ÄM B·ªä THI·∫æU: X·ª¨ L√ù IMPORT EXCEL ===
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                // Chuy·ªÉn sheet th√†nh JSON
                const json = XLSX.utils.sheet_to_json(worksheet);

                let addedCount = 0;
                let skippedCount = 0;
                let errorMessages = [];

                if (json.length === 0) {
                    window.showMessage("File Excel tr·ªëng ho·∫∑c kh√¥ng ƒë·ªçc ƒë∆∞·ª£c.", 'error');
                    event.target.value = null; // Reset input
                    return;
                }

                json.forEach((row, index) => {
                    // C·ªë g·∫Øng t√¨m t√™n c·ªôt linh ho·∫°t (vi·∫øt hoa/th∆∞·ªùng, c√≥/kh√¥ng d·∫•u)
                    // T√¨m c·ªôt ch·ª©a 'mon an' v√† 'so suat'
                    const dishKey = Object.keys(row).find(k => window.removeVietnameseDiacritics(k).includes("mon an"));
                    const servingsKey = Object.keys(row).find(k => window.removeVietnameseDiacritics(k).includes("so suat"));

                    if (!dishKey || !servingsKey) {
                        if (index === 0) { // Ch·ªâ b√°o l·ªói n√†y m·ªôt l·∫ßn
                             errorMessages.push("L·ªói: File ph·∫£i c√≥ c·ªôt 'T√™n M√≥n ƒÇn' v√† 'S·ªë Su·∫•t'.");
                        }
                        skippedCount++;
                        return;
                    }
                    
                    const dishName = String(row[dishKey]).trim();
                    const servings = parseInt(row[servingsKey]);

                    // Ki·ªÉm tra d·ªØ li·ªáu
                    if (!dishName || isNaN(servings) || servings <= 0) {
                        skippedCount++;
                        errorMessages.push(`L·ªói d√≤ng ${index + 2}: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. (${dishName}, ${row[servingsKey]})`);
                        return;
                    }

                    // Ki·ªÉm tra m√≥n ƒÉn c√≥ trong ƒë·ªãnh m·ª©c kh√¥ng
                    if (!(dishName in window.norms)) {
                        skippedCount++;
                        errorMessages.push(`L·ªói d√≤ng ${index + 2}: M√≥n '${dishName}' kh√¥ng c√≥ trong ƒê·ªãnh M·ª©c.`);
                        return;
                    }

                    // Th√™m v√†o th·ª±c ƒë∆°n (c·ªông d·ªìn n·∫øu ƒë√£ t·ªìn t·∫°i)
                    const existingItem = dailyMenu.find(item => item.dish === dishName);
                    if (existingItem) {
                        existingItem.servings += servings;
                    } else {
                        dailyMenu.push({ dish: dishName, servings: servings });
                    }
                    addedCount++;
                });

                // C·∫≠p nh·∫≠t UI v√† th√¥ng b√°o
                if (addedCount > 0) {
                    saveDataLocal();
                    window.renderMenu();
                    window.calculateAndRenderResults();
                    window.showMessage(`ƒê√£ import ${addedCount} m√≥n ƒÉn. B·ªè qua ${skippedCount} d√≤ng.`);
                } else {
                    window.showMessage(`Kh√¥ng import ƒë∆∞·ª£c m√≥n n√†o. B·ªè qua ${skippedCount} d√≤ng.`, 'error');
                }

                if (errorMessages.length > 0) {
                    // Hi·ªÉn th·ªã 3 l·ªói ƒë·∫ßu ti√™n ƒë·ªÉ tr√°nh tr√†n m√†n h√¨nh
                    window.showMessage(errorMessages.slice(0, 3).join('; '), 'warning');
                    console.warn("L·ªói Import Excel:", errorMessages.join('\n'));
                }

                // Reset file input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i file t∆∞∆°ng t·ª±
                event.target.value = null;
            };
            
            reader.onerror = function(e) {
                window.showMessage("L·ªói khi ƒë·ªçc file.", 'error');
                event.target.value = null;
            };

            reader.readAsArrayBuffer(file);
        }
        // === K·∫æT TH√öC B·ªî SUNG ===

        window.removeVietnameseDiacritics = function(str) {
            if (typeof str !== 'string') return '';
            str = str.toLowerCase();
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            str = str.replace(/\s+/g, ' ').trim();
            return str;
        }

        // === H√ÄM M·ªöI: L·∫§Y DANH S√ÅCH NGUY√äN LI·ªÜU DUY NH·∫§T K√àM ƒê∆†N V·ªä ===
        function getUniqueIngredientsWithUnits() {
            const ingredientSet = new Set();
            // L·∫∑p qua t·∫•t c·∫£ c√°c m√≥n ƒÉn
            Object.values(window.norms).forEach(dishNorms => {
                // L·∫∑p qua t·∫•t c·∫£ c√°c key nguy√™n li·ªáu (v√≠ d·ª•: "Th·ªãt (g)")
                Object.keys(dishNorms).forEach(key => ingredientSet.add(key));
            });
            // S·∫Øp x·∫øp
            const sortedIngredients = Array.from(ingredientSet).sort((a, b) => a.localeCompare(b, 'vi'));
            // Chuy·ªÉn ƒë·ªïi th√†nh object { name, unit }
            return sortedIngredients.map(key => {
                const { name, unit } = window.parseIngredientKey(key);
                return { "T√™n Nguy√™n Li·ªáu": name, "ƒê∆°n V·ªã": unit };
            });
        }
        // === K·∫æT TH√öC H√ÄM M·ªöI ===

        // === H√ÄM M·ªöI: EXPORT DANH S√ÅCH M√ìN ƒÇN ===
        window.exportDishList = function() {
            const dishNames = Object.keys(window.norms).sort((a, b) => a.localeCompare(b, 'vi'));
            
            if (dishNames.length === 0) {
                window.showMessage("Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c ƒë·ªÉ xu·∫•t.", 'warning');
                return;
            }
            
            // Chuy·ªÉn th√†nh ƒë·ªãnh d·∫°ng JSON cho SheetJS
            const data = dishNames.map(name => ({ "T√™n M√≥n ƒÇn": name }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Danh S√°ch M√≥n ƒÇn");
            // Ghi file
            XLSX.writeFile(wb, "Danh_Sach_Mon_An.xlsx");
            window.showMessage("ƒê√£ xu·∫•t Danh S√°ch M√≥n ƒÇn th√†nh c√¥ng!");
        }

        // === H√ÄM M·ªöI: EXPORT DANH S√ÅCH NGUY√äN LI·ªÜU ===
        window.exportIngredientList = function() {
            const ingredients = getUniqueIngredientsWithUnits(); // S·ª≠ d·ª•ng h√†m helper m·ªõi
            
            if (ingredients.length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o trong ƒë·ªãnh m·ª©c ƒë·ªÉ xu·∫•t.", 'warning');
                return;
            }
            
            // D·ªØ li·ªáu ƒë√£ ·ªü ƒë√∫ng ƒë·ªãnh d·∫°ng
            const ws = XLSX.utils.json_to_sheet(ingredients);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Danh S√°ch Nguy√™n Li·ªáu");
            // Ghi file
            XLSX.writeFile(wb, "Danh_Sach_Nguyen_Lieu.xlsx");
            window.showMessage("ƒê√£ xu·∫•t Danh S√°ch Nguy√™n Li·ªáu th√†nh c√¥ng!");
        }

        // === H√ÄM M·ªöI: EXPORT TO√ÄN B·ªò ƒê·ªäNH M·ª®C ===
        window.exportFullNorms = function() {
            const dataToExport = [];
            
            // S·∫Øp x·∫øp theo t√™n m√≥n ƒÉn
            const dishNames = Object.keys(window.norms).sort((a, b) => a.localeCompare(b, 'vi'));

            dishNames.forEach(dishName => {
                const ingredients = window.norms[dishName];
                // S·∫Øp x·∫øp theo t√™n nguy√™n li·ªáu
                const ingKeys = Object.keys(ingredients).sort((a, b) => a.localeCompare(b, 'vi'));
                
                ingKeys.forEach(ingKey => {
                    const quantity = ingredients[ingKey];
                    const { name: ingName, unit: ingUnit } = window.parseIngredientKey(ingKey);
                    
                    dataToExport.push({
                        "T√™n M√≥n ƒÇn": dishName,
                        "T√™n Nguy√™n Li·ªáu": ingName,
                        "ƒê∆°n V·ªã": ingUnit,
                        "ƒê·ªãnh M·ª©c": quantity
                    });
                });
            });

            if (dataToExport.length === 0) {
                window.showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªãnh m·ª©c n√†o ƒë·ªÉ xu·∫•t.", 'warning');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt
            ws['!cols'] = [ { wch: 30 }, { wch: 25 }, { wch: 10 }, { wch: 10 } ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "To√†n B·ªô ƒê·ªãnh M·ª©c");
            // Ghi file
            XLSX.writeFile(wb, "Toan_Bo_Dinh_Muc.xlsx");
            window.showMessage("ƒê√£ xu·∫•t To√†n B·ªô ƒê·ªãnh M·ª©c th√†nh c√¥ng!");
        }
        // === K·∫æT TH√öC C√ÅC H√ÄM EXPORT ===

        // === TH√äM M·ªöI: H√ÄM EXPORT TH·ª∞C ƒê∆†N NG√ÄY ===
        window.exportDailyMenu = function() {
            const dateInput = document.getElementById('menu-date');
            const menuDate = dateInput.value || new Date().toISOString().split('T')[0];

            if (dailyMenu.length === 0) {
                window.showMessage("Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong th·ª±c ƒë∆°n ng√†y ƒë·ªÉ xu·∫•t.", 'warning');
                return;
            }

            // Chuy·ªÉn th√†nh ƒë·ªãnh d·∫°ng JSON cho SheetJS
            const data = dailyMenu.map(item => ({ 
                "T√™n M√≥n ƒÇn": item.dish, 
                "S·ªë Su·∫•t": item.servings 
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [ { wch: 40 }, { wch: 15 } ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Thuc Don ${menuDate}`);
            
            // Ghi file
            XLSX.writeFile(wb, `Thuc_Don_${menuDate}.xlsx`);
            window.showMessage("ƒê√£ xu·∫•t Th·ª±c ƒê∆°n Ng√†y th√†nh c√¥ng!");
        }

        // === TH√äM M·ªöI: C√ÅC H√ÄM IN ===
        function printSection(sectionClass) {
            document.body.classList.add(sectionClass);
            window.print();
            // S·ª≠ d·ª•ng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác x√≥a class di·ªÖn ra sau khi l·ªánh in ho√†n t·∫•t
            setTimeout(() => {
                document.body.classList.remove(sectionClass);
            }, 500);
        }

        window.printDailyMenu = function() {
            if (dailyMenu.length === 0) {
                window.showMessage("Kh√¥ng c√≥ g√¨ trong th·ª±c ƒë∆°n ƒë·ªÉ in.", 'warning');
                return;
            }
            // ·∫®n c√°c ph·∫ßn kh√¥ng c·∫ßn thi·∫øt kh√°c
            document.getElementById('norms-section').classList.add('no-print');
            document.getElementById('results-section').classList.add('no-print');
            document.getElementById('daily-menu-section').classList.remove('no-print');
            
            printSection('printing-menu');
        }

        window.printResults = function() {
             const totalIngredients = window.calculateTotalIngredients();
             if (Object.keys(totalIngredients).length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë·ªÉ in.", 'warning');
                return;
            }
            // ·∫®n c√°c ph·∫ßn kh√¥ng c·∫ßn thi·∫øt kh√°c
            document.getElementById('norms-section').classList.add('no-print');
            document.getElementById('daily-menu-section').classList.add('no-print');
            document.getElementById('results-section').classList.remove('no-print');
            
            printSection('printing-results');
        }
        // === K·∫æT TH√öC H√ÄM IN ===

        window.renderMenu = function() {
            const tableBody = document.getElementById('daily-menu-table-body');
            tableBody.innerHTML = '';
            
            if (dailyMenu.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Th·ª±c ƒë∆°n h√¥m nay ch∆∞a c√≥ m√≥n n√†o.</td></tr>`;
                return;
            }

            dailyMenu.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                
                // T√çNH TO√ÅN T·ªîNG CHO T·ª™NG M√ìN
                const normData = window.norms[item.dish];
                // === B·∫ÆT ƒê·∫¶U CH·ªàNH S·ª¨A ===
                let normHtml = '';
                let totalHtml = '';
                
                if (!normData) {
                    normHtml = '<span class="text-red-500 italic">Thi·∫øu ƒê·ªãnh M·ª©c</span>';
                    totalHtml = '<span class="text-red-500 italic">Kh√¥ng th·ªÉ t√≠nh t·ªïng</span>';
                } else {
                    const normParts = [];
                    const totalParts = [];

                    Object.entries(normData).forEach(([ingKey, qty]) => {
                        const { name, unit } = window.parseIngredientKey(ingKey);
                        
                        // 1. Chu·ªói ƒë·ªãnh m·ª©c
                        normParts.push(`${name}: ${qty} ${unit}`);
                        
                        // 2. Chu·ªói t·ªïng (ƒë√£ c√≥ t√≠nh to√°n)
                        const totalQty = qty * item.servings;
                        const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, totalQty);
                        const displayTotalQty = Number.isInteger(convertedQuantity) ? convertedQuantity.toLocaleString('vi-VN') : convertedQuantity.toFixed(2).toLocaleString('vi-VN');
                        
                        totalParts.push(`${name}: <strong class="text-blue-700">${displayTotalQty} ${convertedUnit}</strong>`);
                    });

                    normHtml = normParts.join(' | ');
                    totalHtml = totalParts.join(' | ');
                }

                row.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-900">
                        ${item.dish}
                        <div class="text-xs text-gray-500 mt-1 pt-1 border-t border-gray-100">
                            <span class="font-semibold text-gray-600">ƒê·ªãnh m·ª©c:</span> ${normHtml}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            <span class="font-semibold">T·ªïng NL:</span> ${totalHtml}
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3">
                        <input type="number" 
                            value="${item.servings}" 
                            min="1" 
                            onchange="window.updateServings(${index}, this.value)"
                            class="w-full p-1 border rounded-md text-center focus:ring-green-500 focus:border-green-500 text-sm">
                    </td>
                    <td class="px-3 sm:px-6 py-3 text-right">
                        <button onclick="window.deleteDishFromMenu(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full" title="X√≥a m√≥n ƒÉn">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- LOGIC T√çNH TO√ÅN V√Ä HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---

        window.getConvertedUnit = function(unit, quantity) {
            let convertedQuantity = quantity;
            let convertedUnit = unit;

            if (unit === 'g' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'kg';
            } else if (unit === 'ml' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'l';
            }
            return { convertedQuantity, convertedUnit };
        }

        window.calculateTotalIngredients = function() {
            const totalIngredients = {};

            dailyMenu.forEach(menuItem => {
                const dish = menuItem.dish;
                const servings = menuItem.servings;
                const dishNorms = window.norms[dish];

                if (dishNorms) {
                    for (const ingredient in dishNorms) {
                        const normQuantity = dishNorms[ingredient]; 
                        const requiredQuantity = normQuantity * servings; 

                        if (totalIngredients[ingredient]) {
                            totalIngredients[ingredient] += requiredQuantity;
                        } else {
                            totalIngredients[ingredient] = requiredQuantity;
                        }
                    }
                }
            });

            return totalIngredients;
        }

        window.renderResults = function() {
            const totalIngredients = window.calculateTotalIngredients();
            const tableBody = document.getElementById('results-table-body');
            const listBody = document.getElementById('results-list-view');
            const tableView = document.getElementById('results-table-view');
            
            updateViewToggleButton();
            
            tableBody.innerHTML = '';
            listBody.innerHTML = '';
            
            const ingredientsArray = Object.entries(totalIngredients).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            if (ingredientsArray.length === 0) {
                const emptyRow = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</td></tr>`;
                tableBody.innerHTML = emptyRow;
                listBody.innerHTML = `<p class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</p>`;
                
                if (resultsView === 'table') {
                    tableView.classList.remove('hidden');
                    listBody.classList.add('hidden');
                } else {
                    tableView.classList.add('hidden');
                    listBody.classList.remove('hidden');
                }
                return;
            }

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                const { name: ingredientName, unit } = window.parseIngredientKey(ingredientWithUnit);
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, quantity);
                const displayQuantity = Number.isInteger(quantity) ? quantity.toLocaleString('vi-VN') : quantity.toFixed(2).toLocaleString('vi-VN');
                const displayConvertedQuantity = Number.isInteger(convertedQuantity) ? convertedQuantity.toLocaleString('vi-VN') : convertedQuantity.toFixed(2).toLocaleString('vi-VN');
                
                const tableRow = document.createElement('tr');
                tableRow.className = 'bg-white hover:bg-yellow-100 transition duration-100';
                tableRow.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-800">${ingredientName}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right font-semibold text-yellow-800">${displayQuantity} ${unit}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right text-yellow-600 font-medium">${displayConvertedQuantity} ${convertedUnit}</td>
                `;
                tableBody.appendChild(tableRow);
                
                const listItem = document.createElement('div');
                listItem.className = 'p-3 bg-white rounded-lg shadow-sm border border-yellow-300';
                listItem.innerHTML = `
                    <div class="font-bold text-base text-gray-800 mb-1">${ingredientName}</div>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-1">
                        <span class="text-xs text-gray-500">T·ªïng S·ªë L∆∞·ª£ng (G·ªëc):</span>
                        <span class="font-semibold text-yellow-800 text-sm">${displayQuantity} ${unit}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-xs text-gray-500">Quy ƒê·ªïi:</span>
                        <span class="font-medium text-yellow-600 text-sm">${displayConvertedQuantity} ${convertedUnit}</span>
                    </div>
                `;
                listBody.appendChild(listItem);
            });
            
            if (resultsView === 'table') {
                tableView.classList.remove('hidden');
                listBody.classList.add('hidden');
            } else {
                tableView.classList.add('hidden');
                listBody.classList.remove('hidden');
            }
        }
        
        window.renderAll = function() {
            window.renderMenu();
            window.calculateAndRenderResults();
            updateUniqueIngredients(); // C·∫≠p nh·∫≠t danh s√°ch g·ª£i √Ω
        }

        window.calculateAndRenderResults = function() {
             setTimeout(window.renderResults, 50);
        }

        // --- KH·ªûI T·∫†O (S·ª¨A L·ªñI: Ch·∫°y ngay l·∫≠p t·ª©c v√¨ script ·ªü cu·ªëi body) ---
        initializeDataSync(); // Kh·ªüi t·∫°o ƒë·ªìng b·ªô
        initializeDate(); // Kh·ªüi t·∫°o ng√†y
        window.resetNormsForm(); // Kh·ªüi t·∫°o form ·ªü tr·∫°ng th√°i ch·ªçn m√≥n
        window.renderAll(); // G·ªçi render l·∫ßn ƒë·∫ßu sau khi t·∫£i d·ªØ li·ªáu
        
    </script>

</body>
</html>

