<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh ƒê·ªãnh M·ª©c Nguy√™n Li·ªáu Th·ª±c ƒê∆°n</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† ƒë√°p ·ª©ng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ v√† cƒÉn ch·ªânh c∆° b·∫£n */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 1rem;
        }
        /* Custom style to handle closing dropdown when clicking outside */
        .dish-option:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        /* B·ªï sung ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng ngang tr√™n mobile (n·∫øu c·∫ßn thi·∫øt, nh∆∞ng ƒë√£ c·ªë g·∫Øng tr√°nh) */
        .table-responsive {
            overflow-x: auto;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Modal Content */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        /* T√πy ch·ªânh cho dropdown trong khu v·ª±c ch·ªânh s·ª≠a */
        .norm-select-container {
            max-height: 12rem; /* Gi·ªõi h·∫°n chi·ªÅu cao cho dropdown danh s√°ch m√≥n */
            overflow-y: auto;
        }
        /* T√πy ch·ªânh cho dropdown nguy√™n li·ªáu */
        .ingredient-select-container {
             max-height: 10rem; 
             overflow-y: auto;
        }
    </style>
    
    <!-- FIREBASE SDK IMPORTS (S·ª≠ d·ª•ng module script) -->
    <script type="module">
        // Import c√°c h√†m c·∫ßn thi·∫øt cho Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyD1W08tbeT1durWvUj2i6BoRyCtrT9eXtE",
            authDomain: "quan-ly-thuc-don.firebaseapp.com",
            projectId: "quan-ly-thuc-don",
            storageBucket: "quan-ly-thuc-don.firebasestorage.app",
            messagingSenderId: "333327496945",
            appId: "1:333327496945:web:6593a84dedeaf37d3f9b50",
            measurementId: "G-BGQ7MBH0V4"
        };
        
        // Kh·ªüi t·∫°o Firebase Services
        window.firebaseApp = initializeApp(firebaseConfig);
        window.firebaseAnalytics = getAnalytics(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        
        // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C FIREBASE (Cloud Data) ---
        
        // App ID gi·∫£ ƒë·ªãnh (N·∫øu kh√¥ng d√πng Custom Token)
        const appId = firebaseConfig.projectId || 'default-app-id'; 
        
        // B·∫≠t Debug log cho Firestore (r·∫•t h·ªØu √≠ch khi ph√°t tri·ªÉn)
        setLogLevel('debug'); 

        // H√†m x√°c th·ª±c v√† ƒë·ªìng b·ªô d·ªØ li·ªáu
        async function initializeDataSync() {
            try {
                // ƒêƒÉng nh·∫≠p ·∫©n danh ƒë·ªÉ c√≥ quy·ªÅn truy c·∫≠p Firestore (theo quy t·∫Øc b·∫£o m·∫≠t m·∫´u)
                await signInAnonymously(window.auth);
                
                // ƒê∆∞·ªùng d·∫´n t·ªõi t√†i li·ªáu l∆∞u tr·ªØ ƒê·ªãnh m·ª©c chung (Public Data)
                const normsDocRef = doc(window.db, 'artifacts', appId, 'public', 'data', 'norms', 'master_list');

                // Th√™m listener cho d·ªØ li·ªáu (nghe thay ƒë·ªïi th·ªùi gian th·ª±c)
                onSnapshot(normsDocRef, (docSnapshot) => {
                    const statusDiv = document.getElementById('connection-status');
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        
                        // C·∫≠p nh·∫≠t bi·∫øn global window.norms
                        window.norms = data.norms || window.DEFAULT_NORMS;
                        
                        statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi Firestore. D·ªØ li·ªáu ƒë·ªãnh m·ª©c ƒë∆∞·ª£c ƒë·ªìng b·ªô.';
                        statusDiv.classList.replace('text-gray-600', 'text-green-600');
                        statusDiv.classList.remove('text-red-600', 'text-blue-600');
                        window.renderAll();
                    } else {
                        // N·∫øu t√†i li·ªáu ch∆∞a t·ªìn t·∫°i, t·∫°o m·ªõi b·∫±ng DEFAULT_NORMS
                        statusDiv.textContent = 'K·∫øt n·ªëi Firestore: Kh·ªüi t·∫°o d·ªØ li·ªáu...';
                        statusDiv.classList.replace('text-gray-600', 'text-blue-600');
                        statusDiv.classList.remove('text-red-600', 'text-green-600');
                        
                        // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh v√† t·∫°o t√†i li·ªáu
                        window.norms = window.DEFAULT_NORMS;
                        setDoc(normsDocRef, { norms: window.DEFAULT_NORMS, lastUpdated: new Date().toISOString() })
                            .then(() => {
                                statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi Firestore. D·ªØ li·ªáu ƒë·ªãnh m·ª©c ƒë∆∞·ª£c ƒë·ªìng b·ªô.';
                                statusDiv.classList.replace('text-blue-600', 'text-green-600');
                                window.renderAll();
                            })
                            .catch(error => {
                                console.error("L·ªói khi t·∫°o t√†i li·ªáu Firestore:", error);
                                statusDiv.textContent = 'L·ªñI K·∫æT N·ªêI FIREBASE. D·ªØ li·ªáu ch·ªâ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô.';
                                statusDiv.classList.replace('text-green-600', 'text-red-600');
                                // Chuy·ªÉn sang ch·∫ø ƒë·ªô LocalStorage n·∫øu l·ªói
                                window.norms = window.DEFAULT_NORMS;
                                window.renderAll();
                            });
                    }
                    
                    // Kh·ªüi t·∫°o th·ª±c ƒë∆°n ng√†y t·ª´ LocalStorage (v√¨ th·ª±c ƒë∆°n ng√†y kh√¥ng c·∫ßn ƒë·ªìng b·ªô)
                    window.dailyMenu = JSON.parse(localStorage.getItem('dailyMenu')) || [];
                    window.renderMenu();

                }, (error) => {
                    console.error("L·ªói l·∫Øng nghe Firestore (onSnapshot):", error);
                    const statusDiv = document.getElementById('connection-status');
                    statusDiv.textContent = 'L·ªñI K·∫æT N·ªêI FIRESTORE. D·ªØ li·ªáu ch·ªâ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô.';
                    statusDiv.classList.replace('text-green-600', 'text-red-600');
                    // Chuy·ªÉn sang ch·∫ø ƒë·ªô LocalStorage n·∫øu l·ªói
                    window.norms = window.DEFAULT_NORMS;
                    window.renderAll();
                });

            } catch (error) {
                console.error("L·ªói x√°c th·ª±c Firebase:", error);
                const statusDiv = document.getElementById('connection-status');
                
                let errorMessage = 'L·ªñI K·∫æT N·ªêI FIREBASE. D·ªØ li·ªáu ch·ªâ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô.';

                if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'L·ªñI X√ÅC TH·ª∞C: C·∫ßn B·∫¨T ƒêƒÉng nh·∫≠p ·∫®n danh (Anonymous Auth) trong Firebase Console.';
                    window.showMessage("L·ªói: Vui l√≤ng B·∫¨T Anonymous Auth trong Firebase Console.", 'error');
                } else {
                    window.showMessage(`L·ªói Firebase: ${error.message}`, 'error');
                }
                
                statusDiv.textContent = errorMessage;
                statusDiv.classList.replace('text-gray-600', 'text-red-600');
                statusDiv.classList.remove('text-green-600', 'text-blue-600');

                // Chuy·ªÉn sang ch·∫ø ƒë·ªô LocalStorage/Default n·∫øu l·ªói
                window.norms = window.DEFAULT_NORMS;
                window.renderAll();
            }
        }

        // --- EXPORT C√ÅC H√ÄM C·∫¶N G·ªåI T·ª™ HTML RA GLOBAL SCOPE ---
        window.initializeDataSync = initializeDataSync;
        
        // --- C∆† S·ªû D·ªÆ LI·ªÜU V√Ä ƒê·ªäNH NGHƒ®A ---
        
        // Danh s√°ch c√°c ƒë∆°n v·ªã t√≠nh ƒë∆∞·ª£c thi·∫øt l·∫≠p s·∫µn
        const UNITS = ['g', 'kg', 'ml', 'l', 'c√°i', 'qu·∫£', 'b√≥', 'lon', 'h·ªôp', 'th√¨a', 'mu·ªóng', 'ph·∫ßn', 'mi·∫øng', '(Kh√°c)']; // Th√™m t√πy ch·ªçn "(Kh√°c)"
        
        // D·ªØ li·ªáu ƒë·ªãnh m·ª©c m·∫∑c ƒë·ªãnh (ƒê√£ ƒë∆∞·ª£c chuy·ªÉn t·ª´ bi·∫øn initialNorms)
        const DEFAULT_NORMS = {
            "G√† chi√™n s·ªët cay": { "Th·ªãt n·∫°c vai (g)": 200, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "Th·ªãt kho c·ªß c·∫£i": { "Th·ªãt n·∫°c vai (g)": 180, "C·ªß c·∫£i ƒë·ªè (g)": 35 },
            "C·ªët l·∫øt ram m·∫∑n": { "C·ªët l·∫øt (g)": 200 },
            "Ch·∫£ c√° kho ti√™u": { "Ch·∫£ c√° (g)": 150 },
            "G√† chi√™n n∆∞·ªõc m·∫Øm": { "G√† t∆∞∆°i (g)": 200 },
            "Th·ªãt kho tr·ª©ng g√†": { "Th·ªãt n·∫°c vai (g)": 130, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "C√° phi l√™": { "C√° phi l√™ (g)": 130 },
            "G√† kho g·ª´ng": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn kho ti√™u": { "S∆∞·ªùn non (g)": 220 },
            "G√† kho s·∫£": { "G√† t∆∞∆°i (g)": 180 },
            "S∆∞·ªùn s·ªët chua ng·ªçt": { "S∆∞·ªùn non (g)": 220 },
            "Th·ªãt kho ƒë·∫≠u h≈©": { "Th·ªãt n·∫°c vai (g)": 130, "ƒê·∫≠u h≈© chi√™n (g)": 100 },
            "Ch·∫£ c√° tr·ª©ng c√∫t": { "Ch·∫£ c√° b·ªçc tr·ª©ng c√∫t (g)": 125 },
            "ƒê√πi g√† chi√™n": { "ƒê√πi g√† (g)": 200 },
            "C·∫£i ng·ªçt x√†o": { "C·∫£i ng·ªçt (g)": 80 },
            "B·∫ßu x√†o": { "B·∫ßu (g)": 80 },
            "B·∫Øp c·∫£i x√†o": { "B·∫Øp c·∫£i tr√≤n (g)": 80 },
            "Rau mu·ªëng x√†o": { "Rau mu·ªëng (g)": 90 },
            "D∆∞a leo x√†o": { "D∆∞a leo (g)": 80 },
            "ƒê·∫≠u ƒë≈©a x√†o": { "ƒê·∫≠u ƒë≈© (g)": 80 },
            "C·∫£i th√¨a x√†o": { "C·∫£i th√¨a (g)": 80 },
            "Su su, c√† r·ªët x√†o": { "Su su (g)": 80, "C√† r·ªët (g)": 10 },
            "Canh Rong bi·ªÉn": { "Rong bi·ªÉn kh√¥ (g)": 0.35 },
            "Canh B·∫Øp c·∫£i tr·∫Øng, c√† r·ªët": { "B·∫Øp c·∫£i tr·∫Øng (g)": 40, "C√† r·ªët (g)": 10 },
            "Canh b·∫ßu": { "B·∫ßu (g)": 55 },
            "Canh Soup": { "C·ªß c·∫£i tr·∫Øng (g)": 10, "C√† r·ªët (g)": 10, "C·ªß d·ªÅn (g)": 10, "Su su (g)": 10, "B·∫Øp c·∫£i tr·∫Øng (g)": 15 },
            "Canh Khoai M·ª°": { "Khoai m·ª° (g)": 55 },
            "Canh B√≠ xanh": { "B√≠ xanh (g)": 55 },
            "Canh C·∫£i th·∫£o": { "C·∫£i th·∫£o (g)": 50 },
            "Canh chua rau mu·ªëng": { "rau mu·ªëng (g)": 20, "c·ªß chua (g)": 5 },
            
            // D·ªÆ LI·ªÜU T·ª™ H√åNH ·∫¢NH ƒê√çNH K√àM M·ªöI (ƒê√£ ƒë∆∞·ª£c b·ªï sung)
            "M√¨ tr·ªôn x√∫c x√≠ch": { "M√¨ Nissin (g)": 70, "X√∫c x√≠ch (g)": 50 },
            "M√¨ tr·ªôn tr·ª©ng, x√∫c x√≠ch": { "M√¨ Nissin (g)": 70, "X√∫c x√≠ch (g)": 50, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "M√¨ ph√¥ mai tr·ª©ng": { "M√¨ Nissin (g)": 70, "Tr·ª©ng g√† (qu·∫£)": 1 },
            "G√† l·∫Øc": { "G√† vi√™n (g)": 110 },
            "B√°nh g√† ph√¥ mai": { "B√°nh g√† ph√¥ mai (g)": 180 },
            "B√°nh bao tr·ª©ng c√∫t": { "B√°nh bao tr·ª©ng c√∫t (g)": 62.5 },
            "B√°nh bao tr·ª©ng mu·ªëi": { "B√°nh bao tr·ª©ng mu·ªëi (g)": 100 },
            "B√°nh bao ng·ªçt": { "B√°nh bao ng·ªçt (g)": 40 },
            "C√° phi l√™ s·ªët chua ng·ªçt": { "C√° phi l√™ (g)": 130 },
            "Tr·ª©ng cu·ªôn ng≈© s·∫Øc": { "Tr·ª©ng g√† (qu·∫£)": 2, "C√† r·ªët (g)": 10, "ƒê·∫≠u ƒë≈©a (g)": 5, "Th·ªãt xay (g)": 30 },
            "G√† R√¥ti": { "ƒê√πi g√† (g)": 200 },
            "Ph·ªü g√†": { "B√°nh ph·ªü (g)": 200, "G√† phi l√™ (g)": 150, "Gi√° (g)": 35, "C√† r·ªët (g)": 10, "C·ªß c·∫£i tr·∫Øng (g)": 10 }

        };

        // L·∫•y ƒë·ªãnh m·ª©c t·ª´ LocalStorage ho·∫∑c d√πng ƒë·ªãnh m·ª©c m·∫∑c ƒë·ªãnh n·∫øu LocalStorage tr·ªëng
        // L∆ØU √ù: Bi·∫øn n√†y s·∫Ω b·ªã ghi ƒë√® b·ªüi d·ªØ li·ªáu Firestore sau khi k·∫øt n·ªëi th√†nh c√¥ng.
        const storedNorms = localStorage.getItem('norms');
        window.norms = storedNorms ? JSON.parse(storedNorms) : DEFAULT_NORMS;

        // C·∫•u tr√∫c Th·ª±c ƒë∆°n (V·∫´n l∆∞u trong b·ªô nh·ªõ tr√¨nh duy·ªát cho phi√™n hi·ªán t·∫°i)
        let dailyMenu = JSON.parse(localStorage.getItem('dailyMenu')) || [];
        
        // Tr·∫°ng th√°i View cho b·∫£ng k·∫øt qu·∫£: 'table' (M·∫∑c ƒë·ªãnh) ho·∫∑c 'list'
        let resultsView = localStorage.getItem('resultsView') || 'table';

        // Bi·∫øn to√†n c·ª•c theo d√µi m√≥n ƒëang ch·ªânh s·ª≠a
        let editingDishName = null; 

        // --- C√ÄI ƒê·∫∂T GEMINI API ---
        const LLM_API_KEY = "";
        const LLM_MODEL = "gemini-2.5-flash-preview-05-20";
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${LLM_API_KEY}`;
        
        // --- H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
        // H√†m n√†y gi·ªù ƒë√¢y GHI D·ªÆ LI·ªÜU L√äN FIRESTORE
        function saveData() {
            // L∆∞u th·ª±c ƒë∆°n ng√†y v√†o LocalStorage (V·∫´n d√πng c·ª•c b·ªô)
            localStorage.setItem('dailyMenu', JSON.stringify(dailyMenu));
            localStorage.setItem('resultsView', resultsView);

            if (window.db && window.auth.currentUser) {
                const normsDocRef = doc(window.db, 'artifacts', appId, 'public', 'data', 'norms', 'master_list');
                
                // Ghi d·ªØ li·ªáu ƒë·ªãnh m·ª©c l√™n Firestore
                setDoc(normsDocRef, { 
                    norms: window.norms, 
                    lastUpdated: new Date().toISOString() 
                })
                .then(() => {
                    // console.log("ƒê·ªãnh m·ª©c ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n Firestore.");
                })
                .catch(error => {
                    console.error("L·ªói khi ghi d·ªØ li·ªáu l√™n Firestore:", error);
                    window.showMessage("L·ªói: Kh√¥ng th·ªÉ ƒë·ªìng b·ªô ƒë·ªãnh m·ª©c l√™n ƒë√°m m√¢y.", 'error');
                });
            } else {
                 // N·∫øu kh√¥ng c√≥ k·∫øt n·ªëi, l∆∞u d·ª± ph√≤ng v√†o LocalStorage
                 localStorage.setItem('norms', JSON.stringify(window.norms));
                 window.showMessage("L∆∞u t·∫°m th·ªùi c·ª•c b·ªô (ch∆∞a ƒë·ªìng b·ªô). Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi Firebase.", 'warning');
            }
        }

        // --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO V√Ä MODAL ---
        
        window.showMessage = function(message, type = 'success') {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white z-50 opacity-0 ${bgColor} text-sm`;
            box.textContent = message;
            box.classList.remove('hidden');
            
            setTimeout(() => {
                box.style.opacity = '1';
            }, 50);

            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        window.showLLMModal = function(title, content) {
            const modal = document.getElementById('llm-modal');
            document.getElementById('llm-modal-title').textContent = title;
            document.getElementById('llm-modal-content').innerHTML = content.replace(/\n/g, '<br>'); // Convert newlines to <br>
            modal.classList.remove('hidden');
            // CƒÉn gi·ªØa modal content
            modal.querySelector('.modal-content').classList.add('scale-100');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        // --- H√ÄM CHUNG X·ª¨ L√ù GEMINI API ---

        /**
         * G·ªçi API c·ªßa Gemini v·ªõi c∆° ch·∫ø exponential backoff
         */
        async function fetchLLMResponse(prompt, systemInstruction, buttonId) {
            const button = document.getElementById(buttonId);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'ƒêang t·∫°o...';

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            const maxRetries = 5;
            let lastResult = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            lastResult = text;
                            break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Th·ª≠ l·∫°i n·∫øu l√† l·ªói Rate Limit (429) ho·∫∑c Server Error (5xx)
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Gemini API error:", error);
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            button.disabled = false;
            button.innerHTML = originalText;
            
            if (!lastResult) {
                 window.showMessage("L·ªói: Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Gemini sau nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau.", 'error');
            }

            return lastResult;
        }

        // --- T√çNH NƒÇNG GEMINI C·ª§ TH·ªÇ ---

        /**
         * T·∫°o g·ª£i √Ω th·ª±c ƒë∆°n m·ªõi d·ª±a tr√™n c√°c ti√™u ch√≠ t·ªëi ∆∞u h√≥a
         */
        window.generateMenuSuggestion = async function() {
            if (Object.keys(window.norms).length === 0) {
                window.showMessage("Kh√¥ng c√≥ ƒë·ªãnh m·ª©c m√≥n ƒÉn n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng th√™m ƒë·ªãnh m·ª©c tr∆∞·ªõc.", 'error');
                return;
            }

            // 1. Chu·∫©n b·ªã danh s√°ch m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh
            const availableDishes = Object.keys(window.norms).map(dishName => {
                const normsForDish = window.norms[dishName];
                // L·∫•y nguy√™n li·ªáu ƒë·∫ßu ti√™n l√†m ƒë·∫°i di·ªán cho nguy√™n li·ªáu ch√≠nh
                const [mainIngredientKey] = Object.entries(normsForDish)[0];
                const { name: mainIngredient } = window.parseIngredientKey(mainIngredientKey);
                
                // Chu·∫©n h√≥a t√™n nguy√™n li·ªáu ch√≠nh ƒë·ªÉ LLM d·ªÖ ph√¢n lo·∫°i
                return `${dishName} (Ch√≠nh: ${mainIngredient})`;
            }).join('\n');
            
            const prompt = `T·ª´ danh s√°ch c√°c m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh sau, h√£y ƒë·ªÅ xu·∫•t m·ªôt th·ª±c ƒë∆°n ho√†n ch·ªânh cho m·ªôt ng√†y (g·ªìm 3-4 m√≥n: 1 M√≥n ch√≠nh, 1 M√≥n ph·ª•, 1 Canh) cho su·∫•t ƒÉn b√°n tr√∫, ƒë·∫£m b·∫£o c√°c ti√™u ch√≠:
            1) T·ªëi ∆∞u h√≥a vi·ªác s·ª≠ d·ª•ng nguy√™n li·ªáu (nguy√™n li·ªáu ch√≠nh n√™n kh√°c nhau).
            2) Kh√¥ng ƒë·ªÉ tr√πng l·∫∑p nguy√™n li·ªáu ch√≠nh (Th·ªãt n·∫°c vai, Th·ªãt g√†/ƒë√πi g√†, S∆∞·ªùn non, C√° phi l√™, Ch·∫£ c√°, Tr·ª©ng, ƒê·∫≠u) trong 2 m√≥n ƒë∆∞·ª£c ch·ªçn.
            3) Ph·∫£i l√† c√°c m√≥n c√≥ trong danh s√°ch.
            
            K·∫øt qu·∫£ ch·ªâ ƒë∆∞·ª£c li·ªát k√™ T√™n M√≥n ƒÇn ƒë√£ ch·ªçn, m·ªói m√≥n m·ªôt d√≤ng, kh√¥ng th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát, kh√¥ng gi·∫£i th√≠ch.

            Danh s√°ch m√≥n ƒÉn v√† nguy√™n li·ªáu ch√≠nh:\n${availableDishes}`;
            
            const systemInstruction = "B·∫°n l√† chuy√™n gia dinh d∆∞·ª°ng v√† qu·∫£n l√Ω b·∫øp ƒÉn tr∆∞·ªùng h·ªçc. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë∆∞a ra m·ªôt th·ª±c ƒë∆°n c√¢n b·∫±ng, ngon mi·ªáng, v√† tu√¢n th·ªß ch·∫∑t ch·∫Ω c√°c quy t·∫Øc v·ªÅ t·ªëi ∆∞u h√≥a nguy√™n li·ªáu v√† kh√¥ng tr√πng l·∫∑p ngu·ªìn protein ch√≠nh. K·∫øt qu·∫£ ph·∫£i l√† m·ªôt danh s√°ch c√°c m√≥n ƒÉn b·∫±ng ti·∫øng Vi·ªát, ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng r√µ r√†ng, ph√π h·ª£p ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ sao ch√©p v√† l·∫≠p th·ª±c ƒë∆°n.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-summary-btn');

            if (result) {
                window.showLLMModal("‚ú® G·ª£i √ù Th·ª±c ƒê∆°n T·ªëi ∆Øu", result);
            }
        }

        /**
         * T·∫°o g·ª£i √Ω mua s·∫Øm d·ª±a tr√™n t·ªïng nguy√™n li·ªáu
         */
        window.generateShoppingListNotes = async function() {
            if (dailyMenu.length === 0) {
                window.showMessage("Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n tr∆∞·ªõc khi s·ª≠ d·ª•ng t√≠nh nƒÉng Gemini.", 'error');
                return null;
            }

            const results = window.calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o trong danh s√°ch t·ªïng. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            const shoppingList = Object.entries(results).map(([ingKey, qty]) => {
                const { name: ingredientName, unit } = window.parseIngredientKey(ingKey);
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, qty);
                
                // S·ª≠ d·ª•ng ƒë∆°n v·ªã quy ƒë·ªïi n·∫øu l√† kg ho·∫∑c l√≠t
                const displayQty = convertedUnit !== unit ? convertedQuantity.toFixed(2) : qty;
                const displayUnit = convertedUnit !== unit ? convertedUnit : unit;

                return `${ingredientName}: ${displayQty} ${displayUnit}`;
            }).join('\n');


            const prompt = `Ph√¢n t√≠ch danh s√°ch mua s·∫Øm n√†y v√† ƒë∆∞a ra 3 l·ªùi khuy√™n ng·∫Øn g·ªçn, quan tr·ªçng cho vi·ªác mua s·∫Øm s·ªë l∆∞·ª£ng l·ªõn (V√≠ d·ª•: ∆∞u ti√™n h√†ng t∆∞∆°i, ki·ªÉm tra ch·∫•t l∆∞·ª£ng, mua s·ªâ).\n\nDanh s√°ch mua s·∫Øm:\n${shoppingList}`;

            const systemInstruction = "B·∫°n l√† m·ªôt qu·∫£n l√Ω kho v√† b·∫øp chuy√™n nghi·ªáp. H√£y ƒë∆∞a ra 3 ghi ch√∫/l·ªùi khuy√™n quan tr·ªçng nh·∫•t (theo th·ª© t·ª± ∆∞u ti√™n 1, 2, 3) cho ng∆∞·ªùi ƒëi mua s·∫Øm d·ª±a tr√™n danh s√°ch nguy√™n li·ªáu ƒë√£ cung c·∫•p. Vi·∫øt b·∫±ng ti·∫øng Vi·ªát, t·∫≠p trung v√†o t√≠nh th·ª±c t·∫ø v√† hi·ªáu qu·∫£ mua h√†ng.";

            const result = await fetchLLMResponse(prompt, systemInstruction, 'generate-notes-btn');

            if (result) {
                window.showLLMModal("‚ú® G·ª£i √ù Mua S·∫Øm Hi·ªáu Qu·∫£", result);
            }
        }


        // --- LOGIC ·∫®N/HI·ªÜN KHU V·ª∞C ƒê·ªäNH M·ª®C ---
        
        /**
         * Toggle hi·ªÉn th·ªã khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         * @param {boolean} shouldOpen - N·∫øu true, m·ªü khu v·ª±c qu·∫£n l√Ω, n·∫øu false, ƒë√≥ng
         */
        window.toggleNormsManagement = function(shouldOpen) {
            const area = document.getElementById('norms-management-area');
            const button = document.getElementById('manage-norms-btn');

            if (shouldOpen) {
                area.classList.remove('hidden');
                button.classList.add('hidden');
                // Reset form ƒë·ªÉ chu·∫©n b·ªã cho vi·ªác nh·∫≠p li·ªáu/ch·ªçn m√≥n m·ªõi
                window.resetNormsForm(); 
            } else {
                area.classList.add('hidden');
                button.classList.remove('hidden');
            }
        }
        
        /**
         * T√°ch t√™n nguy√™n li·ªáu v√† ƒë∆°n v·ªã t·ª´ key ƒë√£ l∆∞u (v√≠ d·ª•: "Th·ªãt B√≤ (g)")
         */
        window.parseIngredientKey = function(key) {
            // Regex t√¨m (ƒë∆°n v·ªã) ·ªü cu·ªëi chu·ªói
            const match = key.match(/(.*)\s*(\([^\)]+\))$/);
            if (match) {
                // Tr·∫£ v·ªÅ t√™n, v√† ƒë∆°n v·ªã (b·ªè d·∫•u ngo·∫∑c)
                return { name: match[1].trim(), unit: match[2].replace(/[()]/g, '') };
            }
            // Tr·∫£ v·ªÅ m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ ƒë∆°n v·ªã trong ngo·∫∑c
            return { name: key, unit: UNITS[0].replace(/[()]/g, '') }; 
        }

        // --- LOGIC X·ª¨ L√ù DATE V√Ä EXPORT ---
        
        /**
         * Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ JS (0=CN, 1=T2,...) sang Ti·∫øng Vi·ªát (Th·ª© Hai, Th·ª© Ba,...)
         * @param {Date} date - ƒê·ªëi t∆∞·ª£ng ng√†y th√°ng
         * @returns {string} Th·ª© trong tu·∫ßn b·∫±ng Ti·∫øng Vi·ªát
         */
        function getVietnameseDayOfWeek(date) {
            const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
            return days[date.getDay()];
        }

        /**
         * Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán t·∫°i
         */
        function initializeDate() {
            const dateInput = document.getElementById('menu-date');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            window.renderResultsTitle(); // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ l·∫ßn ƒë·∫ßu
        }
        
        /**
         * C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ k·∫øt qu·∫£ v·ªõi ng√†y ƒë√£ ch·ªçn
         */
        window.renderResultsTitle = function() {
            const dateInput = document.getElementById('menu-date');
            const menuDateValue = dateInput.value;
            let dateString = '';

            if (menuDateValue) {
                // L·∫•y th√¥ng tin ng√†y th√°ng
                const [year, month, day] = menuDateValue.split('-');
                const dateObj = new Date(menuDateValue.replace(/-/g, '/')); // T·∫°o Date object
                
                const dayOfWeek = getVietnameseDayOfWeek(dateObj);

                // ƒê·ªãnh d·∫°ng chu·ªói hi·ªÉn th·ªã: "Th·ª© Hai, Ng√†y 01/01/2024"
                dateString = `${dayOfWeek}, Ng√†y ${day}/${month}/${year}`;
            }
            
            const titleHeader = document.getElementById('results-title-header');
            const exportButtonHtml = titleHeader.querySelector('div').outerHTML; // L·∫•y c·∫£ kh·ªëi n√∫t
            
            titleHeader.innerHTML = `
                üõí T·ªïng Nguy√™n Li·ªáu C·∫ßn Thi·∫øt <span class="text-indigo-700">${dateString}</span>
                ${exportButtonHtml}
            `;
        }
        
        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô xem b·∫£ng v√† danh s√°ch cho k·∫øt qu·∫£.
         */
        window.toggleResultsView = function() {
            resultsView = resultsView === 'table' ? 'list' : 'table';
            saveData();
            window.renderResults(); // G·ªçi h√†m render ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
        }

        /**
         * C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi giao di·ªán
         */
        function updateViewToggleButton() {
            const btn = document.getElementById('toggle-view-btn');
            if (!btn) return;
            
            const isTableView = resultsView === 'table';

            if (isTableView) {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    D·∫°ng Danh s√°ch
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng danh s√°ch (t·ªëi ∆∞u mobile)";
            } else {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-3-8l-3 4m6-4l3 4"></path></svg>
                    D·∫°ng B·∫£ng
                `;
                btn.title = "Chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng b·∫£ng (chi ti·∫øt)";
            }
        }


        /**
         * Xu·∫•t d·ªØ li·ªáu nguy√™n li·ªáu c·∫ßn thi·∫øt sang file CSV c√≥ BOM (h·ªó tr·ª£ ti·∫øng Vi·ªát)
         */
        window.exportResultsToCSVWithBOM = function() {
            const dateInput = document.getElementById('menu-date');
            // ƒê·ªãnh d·∫°ng t√™n file: yyyy-mm-dd
            const menuDate = dateInput.value || new Date().toISOString().split('T')[0]; 
            const results = window.calculateTotalIngredients();
            
            if (Object.keys(results).length === 0) {
                window.showMessage("Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë·ªÉ xu·∫•t. Vui l√≤ng th√™m m√≥n ƒÉn v√†o th·ª±c ƒë∆°n.", 'error');
                return;
            }

            // S·ª≠ d·ª•ng d·∫•u ph·∫©y (,) l√†m delimiter cho CSV
            // C·ªôt ti√™u ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c b·ªï sung th√¥ng tin
            let csvContent = "Nguy√™n Li·ªáu,S·ªë L∆∞·ª£ng (G·ªëc),ƒê∆°n V·ªã (G·ªëc),S·ªë L∆∞·ª£ng (Quy ƒê·ªïi),ƒê∆°n V·ªã (Quy ƒê·ªïi)\r\n";

            // Data rows
            const ingredientsArray = Object.entries(results).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                const { name: ingredientName, unit } = window.parseIngredientKey(ingredientWithUnit);
                
                // T√≠nh to√°n quy ƒë·ªïi
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, quantity);

                // L√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n
                const formattedQuantity = Number.isInteger(quantity) ? quantity.toString() : quantity.toFixed(2); 
                const formattedConvertedQuantity = Number.isInteger(convertedQuantity) ? convertedQuantity.toString() : convertedQuantity.toFixed(2);
                
                // D√≤ng d·ªØ li·ªáu CSV
                const row = `"${ingredientName}",${formattedQuantity},"${unit}",${formattedConvertedQuantity},"${convertedUnit}"`;
                csvContent += row + "\r\n";
            });

            // Th√™m Byte Order Mark (BOM) ƒë·ªÉ Excel nh·∫≠n di·ªán UTF-8
            const bom = "\uFEFF"; 
            const encodedCsvContent = bom + csvContent;

            // T·∫°o Blob object v·ªõi MIME type CSV v√† BOM (UTF-8)
            const csvBlob = new Blob([encodedCsvContent], { type: 'text/csv;charset=utf-8;' });
            const dataUri = URL.createObjectURL(csvBlob);
            
            // T·∫°o file v√† t·∫£i xu·ªëng
            const link = document.createElement("a");
            link.setAttribute("href", dataUri);
            link.setAttribute("download", `nguyen_lieu_thuc_don_${menuDate}.csv`); // ƒê·∫∑t ph·∫ßn m·ªü r·ªông l√† .csv
            document.body.appendChild(link); // Required for certain browsers
            link.click();
            document.body.removeChild(link);
            
            // X√≥a URL object khi kh√¥ng c·∫ßn thi·∫øt n·ªØa
            URL.revokeObjectURL(dataUri); 

            window.showMessage(`ƒê√£ xu·∫•t file nguyen_lieu_thuc_don_${menuDate}.csv th√†nh c√¥ng!`);
        }
        // Gi·ªØ l·∫°i h√†m c≈© ƒë·ªÉ tr√°nh l·ªói tham chi·∫øu n·∫øu c√≥, nh∆∞ng c·∫≠p nh·∫≠t t√™n
        function exportResultsToXLS() {
             window.exportResultsToCSVWithBOM();
        }
        function exportResultsToCSV() {
             window.exportResultsToCSVWithBOM();
        }


        // --- LOGIC X·ª¨ L√ù ƒê·ªäNH M·ª®C NGUY√äN LI·ªÜU (NORMS) ---

        /**
         * Thi·∫øt l·∫≠p form ch·ªânh s·ª≠a/th√™m m√≥n ƒÉn v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (ch·ªçn m√≥n)
         */
        window.resetNormsForm = function() {
            editingDishName = null;
            document.getElementById('norm-dish-search').value = '';
            document.getElementById('form-title').textContent = 'Ch·ªçn m√≥n ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªãnh m·ª©c';
            document.getElementById('current-norm-dish-name').value = '';
            
            // ·∫®n v√πng nh·∫≠p nguy√™n li·ªáu v√† n√∫t l∆∞u/x√≥a/c·∫≠p nh·∫≠t
            document.getElementById('new-ingredient-inputs').innerHTML = '';
            document.getElementById('add-edit-form').classList.add('hidden');
        }

        /**
         * Hi·ªán form v√† t·∫£i d·ªØ li·ªáu cho m√≥n ƒëang ch·ªçn
         */
        window.loadNormsForm = function(dishName) {
            document.getElementById('add-edit-form').classList.remove('hidden');
            document.getElementById('current-norm-dish-name').value = dishName;

            // X√≥a input c≈©
            document.getElementById('new-ingredient-inputs').innerHTML = '';

            const normData = window.norms[dishName];
            
            if (normData) {
                // Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a m√≥n ƒë√£ c√≥
                editingDishName = dishName;
                document.getElementById('form-title').textContent = `Ch·ªânh S·ª≠a ƒê·ªãnh M·ª©c: ${dishName}`;
                Object.entries(normData).forEach(([key, quantity]) => {
                    window.addIngredientInput(key, quantity);
                });
                document.getElementById('delete-norm-button').classList.remove('hidden');

            } else {
                // Ch·∫ø ƒë·ªô th√™m m√≥n m·ªõi
                editingDishName = null;
                document.getElementById('form-title').textContent = `Th√™m M√≥n M·ªõi: ${dishName}`;
                window.addIngredientInput(); 
                document.getElementById('delete-norm-button').classList.add('hidden');
            }
        }
        
        /**
         * H√†m l∆∞u/c·∫≠p nh·∫≠t ƒë·ªãnh m·ª©c (ƒë∆∞·ª£c g·ªçi b·ªüi n√∫t L∆∞u/C·∫≠p Nh·∫≠t)
         */
        window.saveDishNorm = function() {
            const currentDishName = document.getElementById('current-norm-dish-name').value.trim();
            const isEditing = editingDishName !== null;

            if (!currentDishName) {
                window.showMessage("L·ªói: Vui l√≤ng ch·ªçn m√≥n ƒÉn ho·∫∑c nh·∫≠p t√™n m√≥n m·ªõi tr∆∞·ªõc khi l∆∞u.", 'error');
                return;
            }

            // Ki·ªÉm tra tr√πng l·∫∑p n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô TH√äM M·ªöI
            if (!isEditing && currentDishName in window.norms) {
                 window.showMessage(`M√≥n ƒÉn '${currentDishName}' ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªânh s·ª≠a ho·∫∑c x√≥a m√≥n c≈©.`, 'error');
                 return;
            }

            const newNorm = {};
            let hasValidIngredient = false;

            const nameInputs = document.querySelectorAll('#new-ingredient-inputs .ingredient-name-input');
            const unitSelects = document.querySelectorAll('#new-ingredient-inputs .ingredient-unit');
            const customUnitInputs = document.querySelectorAll('#new-ingredient-inputs .custom-unit-input');
            const quantityInputs = document.querySelectorAll('#new-ingredient-inputs .ingredient-quantity');


            nameInputs.forEach((nameInput, index) => {
                const ingredientName = nameInput.value.trim();
                let unitValue = unitSelects[index].value; // L·∫•y gi√° tr·ªã ƒë√£ ch·ªçn
                const customUnitInput = customUnitInputs[index];
                const quantity = parseFloat(quantityInputs[index].value);
                
                // N·∫øu ch·ªçn t√πy ch·ªçn (Kh√°c), l·∫•y gi√° tr·ªã t·ª´ input t√πy ch·ªânh
                if (unitValue === '(Kh√°c)' && customUnitInput) {
                    const customUnit = customUnitInput.value.trim();
                    if (customUnit) {
                        unitValue = `${customUnit}`;
                    } else {
                        // B·ªè qua n·∫øu ƒë∆°n v·ªã t√πy ch·ªânh tr·ªëng
                        return; 
                    }
                }

                if (ingredientName && quantity >= 0 && unitValue) {
                    // D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u ph·∫£i c√≥ d·∫°ng "T√™n Nguy√™n li·ªáu (ƒë∆°n v·ªã)"
                    const fullIngredientName = `${ingredientName} (${unitValue})`; // S·ª≠a l·ªói: Lu√¥n th√™m d·∫•u ngo·∫∑c ƒë∆°n v·ªã
                    newNorm[fullIngredientName] = quantity;
                    if (quantity > 0) hasValidIngredient = true;
                }
            });

            if (!hasValidIngredient) {
                window.showMessage("M√≥n ƒÉn ph·∫£i c√≥ √≠t nh·∫•t m·ªôt nguy√™n li·ªáu v·ªõi ƒë·ªãnh m·ª©c > 0.", 'error');
                return;
            }
            
            // C·∫≠p nh·∫≠t bi·∫øn global 'norms'
            window.norms[currentDishName] = newNorm; 
            
            // L∆∞u v√†o LocalStorage
            saveData();

            window.showMessage(`ƒê·ªãnh m·ª©c m√≥n '${currentDishName}' ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T th√†nh c√¥ng!`);
            
            window.resetNormsForm(); 
            window.renderAll();
        }

        /**
         * X·ª≠ l√Ω hi·ªÉn th·ªã/·∫©n input t√πy ch·ªânh khi thay ƒë·ªïi select ƒë∆°n v·ªã
         */
        window.handleUnitChange = function(selectElement) {
            const parentDiv = selectElement.closest('.flex.flex-col.sm\\:flex-row');
            const customInputDiv = parentDiv.querySelector('.custom-unit-container');

            if (selectElement.value === '(Kh√°c)') {
                customInputDiv.classList.remove('hidden');
                customInputDiv.querySelector('.custom-unit-input').value = ''; // X√≥a gi√° tr·ªã c≈©
            } else {
                customInputDiv.classList.add('hidden');
            }
        }
        
        /**
         * L·∫•y danh s√°ch c√°c t√™n nguy√™n li·ªáu ƒë·ªôc ƒë√°o ƒë√£ t·ª´ng ƒë∆∞·ª£c s·ª≠ d·ª•ng.
         */
        function getUniqueIngredientNames() {
            const names = new Set();
            for (const dish in window.norms) {
                for (const ingredientKey in window.norms[dish]) {
                    const { name } = window.parseIngredientKey(ingredientKey);
                    names.add(name);
                }
            }
            return Array.from(names).sort((a, b) => a.localeCompare(b, 'vi'));
        }

        /**
         * G·∫Øn gi√° tr·ªã ƒë√£ ch·ªçn v√†o √¥ input
         */
        window.selectIngredient = function(itemDiv, inputId) {
            const ingredientName = itemDiv.getAttribute('data-ingredient-name');
            const input = document.getElementById(inputId);
            const optionsList = document.getElementById(inputId + '-options');
            
            input.value = ingredientName;
            optionsList.classList.add('hidden');
        }

        /**
         * L·ªçc danh s√°ch g·ª£i √Ω nguy√™n li·ªáu
         */
        window.filterIngredientList = function(searchTerm, inputId) {
            const listContainer = document.getElementById(inputId + '-options');
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            const uniqueIngredients = getUniqueIngredientNames();
            let foundCount = 0;
            
            listContainer.innerHTML = ''; 

            if (normalizedTerm.length === 0) {
                 // N·∫øu r·ªóng, hi·ªÉn th·ªã 10 m√≥n ƒë·∫ßu ti√™n
                uniqueIngredients.slice(0, 10).forEach(name => {
                    const itemDiv = document.createElement('div');
                    itemDiv.textContent = name;
                    itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                    itemDiv.setAttribute('data-ingredient-name', name);
                    itemDiv.onmousedown = () => window.selectIngredient(itemDiv, inputId);
                    listContainer.appendChild(itemDiv);
                    foundCount++;
                });
            } else {
                // N·∫øu c√≥ t√¨m ki·∫øm
                uniqueIngredients.forEach(name => {
                    const normalizedNameWithoutDiacritics = window.removeVietnameseDiacritics(name);

                    if (normalizedNameWithoutDiacritics.includes(normalizedTerm)) {
                        const itemDiv = document.createElement('div');
                        itemDiv.textContent = name;
                        itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                        itemDiv.setAttribute('data-ingredient-name', name);
                        itemDiv.onmousedown = () => window.selectIngredient(itemDiv, inputId);
                        listContainer.appendChild(itemDiv);
                        foundCount++;
                    }
                });
            }
            
            if (foundCount === 0 && normalizedTerm.length > 0) {
                const newName = searchTerm.trim();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                msgDiv.textContent = `Kh√¥ng t√¨m th·∫•y. Nh·∫•n ƒë·ªÉ Th√™m m·ªõi "${newName}"`;
                msgDiv.classList.add('cursor-pointer', 'hover:bg-green-100');
                msgDiv.onmousedown = () => window.selectIngredient(msgDiv, inputId);
                listContainer.appendChild(msgDiv);
            }

            listContainer.classList.remove('hidden');
        }

        /**
         * Th√™m tr∆∞·ªùng input cho nguy√™n li·ªáu m·ªõi v√†o form th√™m ƒë·ªãnh m·ª©c
         * @param {string} key - Key nguy√™n li·ªáu ƒë√£ l∆∞u (v√≠ d·ª•: "Th·ªãt B√≤ (g)")
         * @param {number} quantity - ƒê·ªãnh m·ª©c s·ªë l∆∞·ª£ng
         */
        window.addIngredientInput = function(key = '', quantity = '') {
            const container = document.getElementById('new-ingredient-inputs');
            const inputGroup = document.createElement('div');
            // Responsive layout cho input nguy√™n li·ªáu
            const uniqueId = 'ing-input-' + Date.now(); // ID duy nh·∫•t cho √¥ input nguy√™n li·ªáu
            inputGroup.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 ingredient-group';
            
            // L·∫•y t√™n nguy√™n li·ªáu (ch·ªâ t√™n, b·ªè ƒë∆°n v·ªã)
            const { name: ingredientName, unit: ingredientUnit } = window.parseIngredientKey(key);
            
            // Th√™m d·∫•u ngo·∫∑c l·∫°i cho vi·ªác so s√°nh trong select
            const selectedUnitWithParentheses = `(${ingredientUnit})`;
            
            // Ki·ªÉm tra xem ƒë∆°n v·ªã ƒë√£ l∆∞u c√≥ ph·∫£i l√† ƒë∆°n v·ªã t√πy ch·ªânh kh√¥ng (kh√¥ng n·∫±m trong UNITS c·ªë ƒë·ªãnh)
            const isCustomUnit = !UNITS.includes(selectedUnitWithParentheses);
            
            inputGroup.innerHTML = `
                <!-- KH·ªêI CH·ªåN/T√åM KI·∫æM NGUY√äN LI·ªÜU -->
                <div class="relative flex-grow">
                    <input type="text" id="${uniqueId}" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p T√™n Nguy√™n li·ªáu" value="${ingredientName}" 
                        oninput="window.filterIngredientList(this.value, '${uniqueId}')"
                        onfocus="window.filterIngredientList(this.value, '${uniqueId}')"
                        onblur="setTimeout(() => document.getElementById('${uniqueId}-options').classList.add('hidden'), 200)"
                        class="w-full p-2 border rounded-md ingredient-name-input text-sm ingredient-name">
                    
                    <div id="${uniqueId}-options" 
                            class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg ingredient-select-container hidden text-sm">
                        <!-- Ingredient suggestions -->
                    </div>
                </div>
                
                <!-- KH·ªêI ƒê∆†N V·ªä V√Ä S·ªê L∆Ø·ª¢NG -->
                <div class="flex flex-col space-y-2 sm:space-y-0 w-full sm:w-48">
                    <select onchange="window.handleUnitChange(this)" class="p-2 border rounded-md ingredient-unit focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                        ${UNITS.map(unit => 
                            // L·ª±a ch·ªçn (Kh√°c) n·∫øu ƒë∆°n v·ªã ƒë√£ l∆∞u l√† custom
                            `<option value="${unit}" ${!isCustomUnit && unit === selectedUnitWithParentheses ? 'selected' : (isCustomUnit && unit === '(Kh√°c)' ? 'selected' : '')}>${unit.replace(/[()]/g, '')}</option>`
                        ).join('')}
                    </select>
                    
                    <div class="custom-unit-container ${isCustomUnit || ingredientUnit === 'Kh√°c' ? 'block' : 'hidden'} mt-1 pt-1">
                        <input type="text" placeholder="Nh·∫≠p ƒê∆°n v·ªã" value="${isCustomUnit && ingredientUnit !== 'Kh√°c' ? ingredientUnit : ''}" class="custom-unit-input p-2 border rounded-md w-full text-xs">
                    </div>
                </div>

                <div class="flex space-x-2 w-full sm:w-auto">
                    <input type="number" placeholder="ƒê·ªãnh m·ª©c (1 su·∫•t)" value="${quantity}" min="0" class="w-full sm:w-28 p-2 border rounded-md ingredient-quantity text-right text-sm">
                    <button type="button" onclick="this.closest('.ingredient-group').remove();" class="text-red-500 hover:text-red-700 p-2 rounded-full" title="X√≥a nguy√™n li·ªáu n√†y">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            container.appendChild(inputGroup);
        }

        /**
         * X√≥a ƒë·ªãnh m·ª©c m√≥n ƒÉn. (L∆ØU √ù: Kh√¥ng d√πng confirm() n√™n thao t√°c n√†y x√≥a ngay l·∫≠p t·ª©c)
         */
        window.deleteNorm = function(dish) {
            if (!dish || !(dish in window.norms)) {
                 window.showMessage("M√≥n ƒÉn kh√¥ng t·ªìn t·∫°i trong ƒë·ªãnh m·ª©c.", 'error');
                 return;
            }
            
            // X√≥a trong bi·∫øn global
            delete window.norms[dish];
            
            // L∆∞u v√†o LocalStorage
            saveData();

            // X√≥a m√≥n ƒÉn n√†y kh·ªèi th·ª±c ƒë∆°n n·∫øu c√≥
            dailyMenu = dailyMenu.filter(item => item.dish !== dish);
            
            window.resetNormsForm();
            window.toggleNormsManagement(false);
            
            window.showMessage(`ƒê·ªãnh m·ª©c m√≥n '${dish}' ƒë√£ ƒë∆∞·ª£c x√≥a.`);
            window.renderAll();
        }
        
        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn cho vi·ªác qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        window.renderSearchableNormDishList = function() {
            const listContainer = document.getElementById('norm-dish-options');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            
            const dishNames = Object.keys(window.norms).sort();

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Ch∆∞a c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectNormDish(dish); // D√πng mousedown ƒë·ªÉ ngƒÉn onblur
                listContainer.appendChild(itemDiv);
            });
        }

        /**
         * L·ªçc danh s√°ch m√≥n ƒÉn cho khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        window.filterNormDishList = function(searchTerm) {
            const listContainer = document.getElementById('norm-dish-options');
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            if (listContainer.children.length === 0 && Object.keys(window.norms).length > 0) {
                 window.renderSearchableNormDishList();
            }

            listContainer.innerHTML = ''; 

            if (normalizedTerm.length === 0) {
                if (Object.keys(window.norms).length > 0) window.renderSearchableNormDishList();
                listContainer.classList.remove('hidden');
                window.resetNormsForm(); // Reset form khi input r·ªóng
                return;
            }
            
            const dishNames = Object.keys(window.norms).sort();
            let matchedDishes = [];

            dishNames.forEach(dish => {
                const normalizedDishName = window.removeVietnameseDiacritics(dish);

                if (normalizedDishName.includes(normalizedTerm)) {
                    matchedDishes.push(dish);
                }
            });

            matchedDishes.forEach(dish => {
                 const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectNormDish(dish);
                listContainer.appendChild(itemDiv);
                foundCount++;
            });

            if (foundCount === 0) {
                // N·∫øu kh√¥ng t√¨m th·∫•y, hi·ªÉn th·ªã t√πy ch·ªçn th√™m m·ªõi
                const newDishName = searchTerm.trim();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                msgDiv.textContent = `Kh√¥ng t√¨m th·∫•y. Nh·∫•n ƒë·ªÉ Th√™m m√≥n "${newDishName}"`;
                msgDiv.classList.add('cursor-pointer', 'hover:bg-green-100');
                msgDiv.onmousedown = () => window.selectNormDish(newDishName, true);
                listContainer.appendChild(msgDiv);

            }
            listContainer.classList.remove('hidden');
        }
        
        /**
         * Ch·ªçn m√≥n ƒÉn t·ª´ danh s√°ch cho khu v·ª±c qu·∫£n l√Ω ƒë·ªãnh m·ª©c
         */
        window.selectNormDish = function(dishName, isNew = false) {
            document.getElementById('norm-dish-search').value = dishName;
            document.getElementById('norm-dish-options').classList.add('hidden'); // ·∫®n danh s√°ch
            window.loadNormsForm(dishName); // T·∫£i form ch·ªânh s·ª≠a/th√™m
        }
        
        // --- LOGIC T√åM KI·∫æM V√Ä CH·ªåN M√ìN ƒÇN TRONG TH·ª∞C ƒê∆†N ---

        /**
         * H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát (chu·∫©n h√≥a Unicode)
         */
        window.removeVietnameseDiacritics = function(str) {
            str = str.toLowerCase();
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            // X√≥a c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát v√† kho·∫£ng tr·∫Øng d∆∞ th·ª´a
            str = str.replace(/\s+/g, ' ').trim();
            return str;
        }

        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn c√≥ th·ªÉ t√¨m ki·∫øm
         */
        window.renderSearchableDishList = function() {
            const listContainer = document.getElementById('dish-options-list');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            
            const dishNames = Object.keys(window.norms).sort();

            if (dishNames.length === 0) {
                listContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong ƒë·ªãnh m·ª©c.</div>';
                return;
            }

            dishNames.forEach(dish => {
                const itemDiv = document.createElement('div');
                itemDiv.textContent = dish;
                itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                itemDiv.setAttribute('data-dish-name', dish);
                itemDiv.onmousedown = () => window.selectDish(dish); // D√πng mousedown ƒë·ªÉ ngƒÉn onblur
                listContainer.appendChild(itemDiv);
            });
        }
        
        /**
         * L·ªçc danh s√°ch m√≥n ƒÉn d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
         */
        window.filterDishList = function(searchTerm) {
            const listContainer = document.getElementById('dish-options-list');
            // Chu·∫©n h√≥a t·ª´ kh√≥a t√¨m ki·∫øm (kh√¥ng d·∫•u, ch·ªØ th∆∞·ªùng)
            const normalizedTerm = window.removeVietnameseDiacritics(searchTerm);
            let foundCount = 0;

            // ƒê·∫£m b·∫£o danh s√°ch ƒë√£ ƒë∆∞·ª£c render tr∆∞·ªõc khi l·ªçc
            if (listContainer.children.length === 0) {
                 window.renderSearchableDishList();
            }

            // X√≥a gi√° tr·ªã c·ªßa hidden input khi b·∫Øt ƒë·∫ßu t√¨m ki·∫øm m·ªõi ho·∫∑c g√µ
            document.getElementById('menu-dish-select').value = ''; 
            
            const dishOptions = listContainer.querySelectorAll('.dish-option');
            
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y
            const notFoundMessageId = 'dish-not-found-msg';
            const existingMessage = document.getElementById(notFoundMessageId);
            
            // N·∫øu c√≥ th√¥ng b√°o kh√¥ng t√¨m th·∫•y, x√≥a n√≥ ƒëi tr∆∞·ªõc khi l·ªçc l·∫°i
            if (existingMessage) existingMessage.remove(); 
            listContainer.innerHTML = ''; // X√≥a to√†n b·ªô n·ªôi dung trong list container

            if (normalizedTerm.length === 0) {
                // N·∫øu input r·ªóng, hi·ªÉn th·ªã l·∫°i to√†n b·ªô m√≥n
                window.renderSearchableDishList();
                listContainer.classList.remove('hidden');

            } else {
                 // N·∫øu c√≥ t·ª´ kh√≥a t√¨m ki·∫øm
                const dishNames = Object.keys(window.norms).sort();

                dishNames.forEach(dish => {
                    // Chu·∫©n h√≥a t√™n m√≥n ƒÉn trong database (kh√¥ng d·∫•u, ch·ªØ th∆∞·ªùng)
                    const normalizedDishName = window.removeVietnameseDiacritics(dish);

                    if (normalizedDishName.includes(normalizedTerm)) {
                        const itemDiv = document.createElement('div');
                        itemDiv.textContent = dish;
                        itemDiv.className = 'p-2 cursor-pointer hover:bg-indigo-100 transition duration-100 dish-option text-sm';
                        itemDiv.setAttribute('data-dish-name', dish);
                        itemDiv.onmousedown = () => window.selectDish(dish);
                        listContainer.appendChild(itemDiv);
                        foundCount++;
                    }
                });

                if (foundCount === 0) {
                    const msgDiv = document.createElement('div');
                    msgDiv.id = notFoundMessageId;
                    msgDiv.className = 'p-2 text-gray-500 italic text-sm';
                    msgDiv.textContent = 'Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn ph√π h·ª£p.';
                    listContainer.appendChild(msgDiv);
                }
                listContainer.classList.remove('hidden');
            }
        }
        
        /**
         * Ch·ªçn m√≥n ƒÉn t·ª´ danh s√°ch
         */
        window.selectDish = function(dishName) {
            document.getElementById('dish-search-input').value = dishName;
            document.getElementById('menu-dish-select').value = dishName;
            document.getElementById('dish-options-list').classList.add('hidden'); // ·∫®n danh s√°ch
        }


        // --- LOGIC X·ª¨ L√ù TH·ª∞C ƒê∆†N NG√ÄY (DAILY MENU) ---
        
        /**
         * H√†m nhanh ƒë·ªÉ ƒëi·ªÅn s·ªë su·∫•t
         */
        window.setServings = function(quantity) {
             document.getElementById('menu-servings-input').value = quantity;
        }


        /**
         * Th√™m m√≥n ƒÉn v√† s·ªë su·∫•t v√†o th·ª±c ƒë∆°n ng√†y
         */
        window.addDishToMenu = function() {
            // S·ª≠ d·ª•ng hidden input ƒë·ªÉ l·∫•y gi√° tr·ªã m√≥n ƒë√£ ch·ªçn
            const dishSelect = document.getElementById('menu-dish-select');
            const servingsInput = document.getElementById('menu-servings-input');
            
            const dish = dishSelect.value;
            const servings = parseInt(servingsInput.value);

            if (!dish || !(dish in window.norms)) {
                window.showMessage("Vui l√≤ng ch·ªçn m·ªôt m√≥n ƒÉn h·ª£p l·ªá t·ª´ danh s√°ch.", 'error');
                return;
            }
            if (isNaN(servings) || servings <= 0) {
                window.showMessage("S·ªë su·∫•t ƒÉn ph·∫£i l√† s·ªë d∆∞∆°ng.", 'error');
                return;
            }

            // Ki·ªÉm tra n·∫øu m√≥n ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t s·ªë su·∫•t
            const existingItem = dailyMenu.find(item => item.dish === dish);
            if (existingItem) {
                existingItem.servings += servings;
            } else {
                dailyMenu.push({ dish, servings });
            }

            saveData();
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage(`ƒê√£ th√™m ${servings} su·∫•t '${dish}' v√†o th·ª±c ƒë∆°n.`);
            
            // Reset input sau khi th√™m th√†nh c√¥ng
            document.getElementById('dish-search-input').value = ''; 
            dishSelect.value = '';
            servingsInput.value = 1;
        }

        /**
         * X√≥a m√≥n ƒÉn kh·ªèi th·ª±c ƒë∆°n ng√†y
         */
        window.deleteDishFromMenu = function(index) {
            dailyMenu.splice(index, 1);
            saveData();
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage("M√≥n ƒÉn ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi th·ª±c ƒë∆°n.", 'warning');
        }

        /**
         * ƒê·∫∑t l·∫°i to√†n b·ªô th·ª±c ƒë∆°n ng√†y
         */
        window.resetDailyMenu = function() {
            dailyMenu = [];
            saveData();
            window.renderMenu();
            window.calculateAndRenderResults();
            window.showMessage("Th·ª±c ƒë∆°n ng√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng.", 'warning');
        }

        /**
         * C·∫≠p nh·∫≠t s·ªë su·∫•t c·ªßa m√≥n ƒÉn trong th·ª±c ƒë∆°n
         */
        window.updateServings = function(index, value) {
            const servings = parseInt(value);
             if (isNaN(servings) || servings <= 0) {
                window.showMessage("S·ªë su·∫•t kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë su·∫•t l·ªõn h∆°n 0.", 'warning');
                if (servings <= 0) {
                    window.deleteDishFromMenu(index);
                } else {
                    window.renderMenu(); 
                }
                return;
            }
            
            dailyMenu[index].servings = servings;
            saveData();
            window.calculateAndRenderResults();
        }

        /**
         * L·∫•y ƒë·ªãnh m·ª©c (norms) c·ªßa m·ªôt m√≥n ƒÉn, ƒë·ªãnh d·∫°ng th√†nh chu·ªói HTML ƒë·ªÉ hi·ªÉn th·ªã
         * @param {string} dishName - T√™n m√≥n ƒÉn
         * @returns {string} HTML string of ingredients
         */
        function getDishNormsHtml(dishName) {
            const normData = window.norms[dishName];
            if (!normData) return '<span class="text-red-500 italic">Thi·∫øu ƒê·ªãnh M·ª©c</span>';

            let ingredientsHtml = Object.entries(normData).map(([ingKey, qty]) => {
                const { name, unit } = window.parseIngredientKey(ingKey);
                // Hi·ªÉn th·ªã ƒë·ªãnh m·ª©c chi ti·∫øt cho 1 su·∫•t
                return `<span class="inline-block text-xs text-gray-600 mr-2">${name}: **${qty}** ${unit}</span>`;
            }).join(' | ');

            return `<div class="text-xs text-gray-500 mt-1 pt-1 border-t border-gray-100">${ingredientsHtml}</div>`;
        }

        /**
         * Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn trong th·ª±c ƒë∆°n
         */
        window.renderMenu = function() {
            const tableBody = document.getElementById('daily-menu-table-body');
            tableBody.innerHTML = '';
            
            if (dailyMenu.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Th·ª±c ƒë∆°n h√¥m nay ch∆∞a c√≥ m√≥n n√†o.</td></tr>`;
                return;
            }

            dailyMenu.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                
                const dishNormsHtml = getDishNormsHtml(item.dish);

                row.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-900">
                        ${item.dish}
                        <div class="mt-1">${dishNormsHtml}</div>
                    </td>
                    <td class="px-3 sm:px-6 py-3">
                        <input type="number" 
                            value="${item.servings}" 
                            min="1" 
                            onchange="window.updateServings(${index}, this.value)"
                            class="w-full p-1 border rounded-md text-center focus:ring-green-500 focus:border-green-500 text-sm">
                    </td>
                    <td class="px-3 sm:px-6 py-3 text-right">
                        <button onclick="window.deleteDishFromMenu(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full" title="X√≥a m√≥n ƒÉn">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- LOGIC T√çNH TO√ÅN V√Ä HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---

        /**
         * H√†m quy ƒë·ªïi ƒë∆°n v·ªã g->kg v√† ml->l
         */
        window.getConvertedUnit = function(unit, quantity) {
            let convertedQuantity = quantity;
            let convertedUnit = unit;

            if (unit === 'g' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'kg';
            } else if (unit === 'ml' && quantity >= 1000) {
                convertedQuantity = quantity / 1000;
                convertedUnit = 'l';
            }
            // N·∫øu s·ªë l∆∞·ª£ng nh·ªè h∆°n 1000 (ho·∫∑c ƒë∆°n v·ªã kh√°c), gi·ªØ nguy√™n
            return { convertedQuantity, convertedUnit };
        }

        /**
         * Th·ª±c hi·ªán t√≠nh to√°n t·ªïng l∆∞·ª£ng nguy√™n li·ªáu
         */
        window.calculateTotalIngredients = function() {
            const totalIngredients = {};

            dailyMenu.forEach(menuItem => {
                const dish = menuItem.dish;
                const servings = menuItem.servings;
                
                const dishNorms = window.norms[dish];

                if (dishNorms) {
                    for (const ingredient in dishNorms) {
                        const normQuantity = dishNorms[ingredient]; // ƒê·ªãnh m·ª©c (cho 1 su·∫•t)
                        const requiredQuantity = normQuantity * servings; // S·ªë l∆∞·ª£ng c·∫ßn cho to√†n b·ªô su·∫•t

                        // C·ªông d·ªìn v√†o t·ªïng
                        if (totalIngredients[ingredient]) {
                            totalIngredients[ingredient] += requiredQuantity;
                        } else {
                            totalIngredients[ingredient] = requiredQuantity;
                        }
                    }
                }
            });

            return totalIngredients;
        }

        /**
         * Hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£ t·ªïng nguy√™n li·ªáu
         */
        window.renderResults = function() {
            const totalIngredients = window.calculateTotalIngredients();
            const tableBody = document.getElementById('results-table-body');
            const listBody = document.getElementById('results-list-view');
            const tableView = document.getElementById('results-table-view');
            
            // C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi
            updateViewToggleButton();
            
            // X√≥a n·ªôi dung c≈©
            tableBody.innerHTML = '';
            listBody.innerHTML = '';
            
            const ingredientsArray = Object.entries(totalIngredients).sort((a, b) => a[0].localeCompare(b[0], 'vi'));

            if (ingredientsArray.length === 0) {
                const emptyRow = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</td></tr>`;
                tableBody.innerHTML = emptyRow;
                listBody.innerHTML = `<p class="px-6 py-4 text-sm text-gray-500 text-center italic">Kh√¥ng c√≥ nguy√™n li·ªáu n√†o ƒë∆∞·ª£c t√≠nh to√°n. H√£y ki·ªÉm tra Th·ª±c ƒë∆°n v√† ƒê·ªãnh m·ª©c!</p>`;
                
                // ·∫®n/hi·ªán d·ª±a tr√™n ch·∫ø ƒë·ªô xem (ngay c·∫£ khi r·ªóng)
                if (resultsView === 'table') {
                    tableView.classList.remove('hidden');
                    listBody.classList.add('hidden');
                } else {
                    tableView.classList.add('hidden');
                    listBody.classList.remove('hidden');
                }
                return;
            }

            ingredientsArray.forEach(([ingredientWithUnit, quantity]) => {
                // T√°ch T√™n Nguy√™n Li·ªáu v√† ƒê∆°n V·ªã
                const { name: ingredientName, unit } = window.parseIngredientKey(ingredientWithUnit);
                
                // Quy ƒë·ªïi ƒë∆°n v·ªã
                const { convertedQuantity, convertedUnit } = window.getConvertedUnit(unit, quantity);

                // ƒê·ªãnh d·∫°ng s·ªë l∆∞·ª£ng g·ªëc
                const displayQuantity = Number.isInteger(quantity) ? quantity.toLocaleString('vi-VN') : quantity.toFixed(2).toLocaleString('vi-VN');
                
                // ƒê·ªãnh d·∫°ng s·ªë l∆∞·ª£ng ƒë√£ quy ƒë·ªïi
                const displayConvertedQuantity = Number.isInteger(convertedQuantity) ? convertedQuantity.toLocaleString('vi-VN') : convertedQuantity.toFixed(2).toLocaleString('vi-VN');
                
                // 1. T·∫°o h√†ng cho ch·∫ø ƒë·ªô B·∫£ng (Table View)
                const tableRow = document.createElement('tr');
                tableRow.className = 'bg-white hover:bg-yellow-100 transition duration-100';
                tableRow.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 text-sm font-medium text-gray-800">${ingredientName}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right font-semibold text-yellow-800">${displayQuantity} ${unit}</td>
                    <td class="px-3 sm:px-6 py-3 text-sm text-right text-yellow-600 font-medium">${displayConvertedQuantity} ${convertedUnit}</td>
                `;
                tableBody.appendChild(tableRow);
                
                // 2. T·∫°o Card cho ch·∫ø ƒë·ªô Danh s√°ch (List View)
                const listItem = document.createElement('div');
                listItem.className = 'p-3 bg-white rounded-lg shadow-sm border border-yellow-300';
                listItem.innerHTML = `
                    <div class="font-bold text-base text-gray-800 mb-1">${ingredientName}</div>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-1">
                        <span class="text-xs text-gray-500">T·ªïng S·ªë L∆∞·ª£ng (G·ªëc):</span>
                        <span class="font-semibold text-yellow-800 text-sm">${displayQuantity} ${unit}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-xs text-gray-500">Quy ƒê·ªïi:</span>
                        <span class="font-medium text-yellow-600 text-sm">${displayConvertedQuantity} ${convertedUnit}</span>
                    </div>
                `;
                listBody.appendChild(listItem);
            });
            
            // ·∫®n/hi·ªán giao di·ªán theo tr·∫°ng th√°i view
            if (resultsView === 'table') {
                tableView.classList.remove('hidden');
                listBody.classList.add('hidden');
            } else {
                tableView.classList.add('hidden');
                listBody.classList.remove('hidden');
            }
        }
        
        /**
         * H√†m t·ªïng h·ª£p ƒë·ªÉ render l·∫°i t·∫•t c·∫£
         */
        window.renderAll = function() {
            window.renderMenu();
            window.calculateAndRenderResults();
        }

        window.calculateAndRenderResults = function() {
             // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o updateServings ho√†n t·∫•t tr∆∞·ªõc khi t√≠nh to√°n
             setTimeout(window.renderResults, 50);
        }

        // --- KH·ªûI T·∫†O ---
        document.addEventListener('DOMContentLoaded', () => {
            // KH·ªûI T·∫†O ƒê·ªíNG B·ªò ƒê√ÅM M√ÇY
            window.initializeDataSync(); 
            
            initializeDate(); // Kh·ªüi t·∫°o ng√†y
            window.resetNormsForm(); // Kh·ªüi t·∫°o form ·ªü tr·∫°ng th√°i ch·ªçn m√≥n
            // window.renderAll() ƒë∆∞·ª£c g·ªçi b√™n trong initializeDataSync sau khi t·∫£i d·ªØ li·ªáu
        });
    </script>

</body>
</html>
